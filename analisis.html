<!DOCTYPE html>
<html class="light" lang="es"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Análisis Operativo - QuantyA</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>

<script id="tailwind-config">
    tailwind.config = {
        darkMode: "class",
        theme: {
            extend: {
                colors: { "primary": "#176282", "background-light": "#f9fafb", "background-dark": "#181d25" },
                fontFamily: { "display": ["Inter", "sans-serif"] },
                borderRadius: {"DEFAULT": "0.5rem", "lg": "1rem", "xl": "1.5rem", "full": "9999px"},
            },
        },
    }
</script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCO6WXu9iZsyEUmNNxrE4oWToLYY8wl-y4",
        authDomain: "misfinanzaspro-d2f3f.firebaseapp.com",
        databaseURL: "https://misfinanzaspro-d2f3f-default-rtdb.firebaseio.com",
        projectId: "misfinanzaspro-d2f3f"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    let currentUser = null;

    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUser = user;
            sincronizarAnalisis();
        } else { window.location.href = "index.html"; }
    });

    function sincronizarAnalisis() {
        onValue(ref(db, `usuarios/${currentUser.uid}`), (snapshot) => {
            const data = snapshot.val() || {};
            const movimientos = data.movimientos || {};
            const metas = data.metas || {};

            let ingTotal = 0, gasTotal = 0;
            let catsGastos = {}, catsIngresos = {};

            Object.values(movimientos).forEach(m => {
                const monto = parseFloat(m.monto);
                if (m.tipo === 'ingreso') {
                    ingTotal += monto;
                    catsIngresos[m.categoria] = (catsIngresos[m.categoria] || 0) + monto;
                } else {
                    gasTotal += monto;
                    catsGastos[m.categoria] = (catsGastos[m.categoria] || 0) + monto;
                }
            });

            // Actualizar Gráfico y Totales (Diseño Original)
            const porcGas = ingTotal > 0 ? (gasTotal / ingTotal) * 100 : 0;
            document.getElementById('circle-gas-main').style.strokeDashoffset = 251.2 - (251.2 * Math.min(porcGas, 100)) / 100;
            document.getElementById('total-center-display').innerText = `$${new Intl.NumberFormat('es-CL').format(gasTotal)}`;
            
            // Renderizar las 4 columnas (Top 4)
            renderTop(catsGastos, 'list-top-gastos', 'bg-primary');
            renderTop(catsIngresos, 'list-top-ingresos', 'bg-[#4db3da]');

            // Actualizar Tabla Rendimiento con flechas
            actualizarTabla(ingTotal, gasTotal);

            // Metas dinámicas (Diseño Original)
            renderMetas(metas);
        });
    }

    function renderTop(obj, id, colorClass) {
        const container = document.getElementById(id);
        container.innerHTML = '';
        Object.entries(obj).sort((a,b) => b[1] - a[1]).slice(0, 4).forEach(([name, val]) => {
            container.innerHTML += `
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <span class="size-3 rounded-full ${colorClass}"></span>
                        <span class="text-sm font-semibold">${name}</span>
                    </div>
                    <span class="text-sm font-bold">$${new Intl.NumberFormat('es-CL').format(val)}</span>
                </div>`;
        });
    }

    function actualizarTabla(ing, gas) {
        const ingReal = document.getElementById('ing-real');
        const gasReal = document.getElementById('gas-real');
        const indIng = document.getElementById('ind-ing');
        const indGas = document.getElementById('ind-gas');

        ingReal.innerText = `$${new Intl.NumberFormat('es-CL').format(ing)}`;
        gasReal.innerText = `$${new Intl.NumberFormat('es-CL').format(gas)}`;

        // Lógica de Indicadores
        const diffIng = ((ing - 5000) / 5000) * 100;
        const diffGas = ((gas - 3200) / 3200) * 100;

        indIng.innerHTML = `<span class="inline-flex items-center ${diffIng >= 0 ? 'text-green-500 bg-green-50' : 'text-red-500 bg-red-50'} px-2 py-1 rounded text-xs font-bold">
            <span class="material-symbols-outlined text-xs mr-1">${diffIng >= 0 ? 'trending_up' : 'trending_down'}</span> ${Math.abs(diffIng.toFixed(1))}%</span>`;
        
        indGas.innerHTML = `<span class="inline-flex items-center ${diffGas <= 0 ? 'text-green-500 bg-green-50' : 'text-red-500 bg-red-50'} px-2 py-1 rounded text-xs font-bold">
            <span class="material-symbols-outlined text-xs mr-1">${diffGas <= 0 ? 'trending_down' : 'trending_up'}</span> ${Math.abs(diffGas.toFixed(1))}%</span>`;
    }

    function renderMetas(metas) {
        const container = document.getElementById('metas-container-dinamico');
        container.innerHTML = '';
        Object.entries(metas).forEach(([id, meta]) => {
            const progreso = Math.min(Math.round((meta.ahorrado / meta.objetivo) * 100), 100);
            container.innerHTML += `
                <div class="bg-white dark:bg-slate-800 rounded-xl p-6 shadow-sm border border-slate-100 dark:border-slate-700 group hover:border-primary/50 transition-colors mb-5">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <div class="size-12 bg-primary/10 rounded-xl flex items-center justify-center text-primary"><span class="material-symbols-outlined">track_changes</span></div>
                            <div><h4 class="font-bold text-base">${meta.nombre}</h4><p class="text-xs text-slate-500 font-medium">Actualizado recientemente</p></div>
                        </div>
                        <span class="text-primary font-black text-lg">${progreso}%</span>
                    </div>
                    <div class="w-full h-3 bg-slate-100 dark:bg-slate-700 rounded-full mb-4 overflow-hidden"><div class="h-full bg-primary rounded-full" style="width: ${progreso}%"></div></div>
                    <div class="flex justify-between items-end">
                        <div><p class="text-[10px] text-slate-400 font-black uppercase tracking-widest mb-1">Progreso Actual</p><p class="text-xl font-black leading-none">$${new Intl.NumberFormat('es-CL').format(meta.ahorrado)} <span class="text-sm font-medium text-slate-400">/ $${new Intl.NumberFormat('es-CL').format(meta.objetivo)}</span></p></div>
                        <button onclick="window.aportarAhorro('${id}', ${meta.ahorrado})" class="bg-primary/5 dark:bg-primary/20 text-primary px-4 py-2 rounded-lg font-bold text-xs hover:bg-primary hover:text-white transition-all uppercase tracking-widest">Añadir Ahorro</button>
                    </div>
                </div>`;
        });
    }

    window.aportarAhorro = async (id, actual) => {
        const monto = prompt("¿Cuánto deseas añadir?");
        if(monto) {
            const nuevo = parseFloat(actual) + parseFloat(monto.replace(/\./g, ""));
            await update(ref(db, `usuarios/${currentUser.uid}/metas/${id}`), { ahorrado: nuevo });
        }
    }
</script>

<style type="text/tailwindcss">
    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #dce2e5; border-radius: 10px; }
</style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-[#121617] dark:text-white transition-colors duration-200">
<div class="flex h-screen overflow-hidden">
    <aside class="w-72 bg-white dark:bg-background-dark border-r border-slate-200 dark:border-slate-800 flex flex-col justify-between p-6 shrink-0">
        <div class="space-y-8">
            <div class="flex items-center gap-3 px-2">
                <div class="size-10 bg-primary rounded-xl flex items-center justify-center text-white"><span class="material-symbols-outlined text-2xl">account_balance</span></div>
                <div><h1 class="text-xl font-black tracking-tight leading-none">QuantyA</h1><p class="text-xs text-slate-500 dark:text-slate-400 font-medium">Gestión Financiera</p></div>
            </div>
            <nav class="space-y-1">
                <a class="flex items-center gap-3 px-4 py-3 text-slate-500 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 rounded-xl transition-all" href="dashboard.html"><span class="material-symbols-outlined">dashboard</span><span class="font-semibold text-sm">Panel</span></a>
                <a class="flex items-center gap-3 px-4 py-3 text-slate-500 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 rounded-xl transition-all" href="movimientos.html"><span class="material-symbols-outlined">swap_horiz</span><span class="font-semibold text-sm">Movimientos</span></a>
                <a class="flex items-center gap-3 px-4 py-3 bg-primary/10 text-primary rounded-xl transition-all" href="analisis.html"><span class="material-symbols-outlined">analytics</span><span class="font-bold text-sm">Análisis</span></a>
                <a class="flex items-center gap-3 px-4 py-3 text-slate-500 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 rounded-xl transition-all" href="metas.html"><span class="material-symbols-outlined">track_changes</span><span class="font-semibold text-sm">Metas</span></a>
                <a class="flex items-center gap-3 px-4 py-3 text-slate-500 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 rounded-xl transition-all" href="reportes.html"><span class="material-symbols-outlined">description</span><span class="font-semibold text-sm">Reportes</span></a>
                <a class="flex items-center gap-3 px-4 py-3 text-slate-500 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 rounded-xl transition-all" href="configuracion.html"><span class="material-symbols-outlined">settings</span><span class="font-semibold text-sm">Configuración</span></a>
            </nav>
        </div>
        <div class="bg-slate-50 dark:bg-slate-800/50 p-4 rounded-2xl flex items-center gap-3">
            <div class="size-10 rounded-full bg-cover bg-center" style='background-image: url("https://ui-avatars.com/api/?name=Julian+Finance&background=176282&color=fff");'></div>
            <div class="flex-1 overflow-hidden"><p class="text-sm font-bold truncate">Julian Finance</p><p class="text-[10px] text-slate-500 dark:text-slate-400 uppercase tracking-widest font-bold">Plan Premium</p></div>
        </div>
    </aside>

    <main class="flex-1 overflow-y-auto custom-scrollbar flex flex-col">
        <header class="sticky top-0 z-10 bg-background-light/80 dark:bg-background-dark/80 backdrop-blur-md px-10 py-6 flex justify-between items-center border-b border-transparent">
            <div><h2 class="text-3xl font-black tracking-tight">Análisis Operativo</h2><p class="text-slate-500 dark:text-slate-400 text-sm font-medium">Sincronización en tiempo real <span class="inline-block size-2 bg-green-500 rounded-full ml-1 animate-pulse"></span></p></div>
            <div class="flex items-center gap-4">
                <button class="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-2 rounded-xl hover:bg-slate-50 transition-all flex items-center gap-2 px-4 h-10"><span class="material-symbols-outlined text-sm">calendar_today</span><span class="text-sm font-bold">Enero 2026</span></button>
                <button onclick="window.print()" class="bg-primary text-white px-6 h-10 rounded-xl font-bold text-sm shadow-lg shadow-primary/20 flex items-center gap-2"><span class="material-symbols-outlined text-sm">download</span>Exportar Informe</button>
            </div>
        </header>

        <div class="px-10 pb-10 flex gap-8">
            <section class="flex-[1.2] space-y-6 min-w-0">
                <div class="bg-white dark:bg-slate-800 rounded-xl p-8 shadow-sm border border-slate-100 dark:border-slate-700">
                    <div class="flex justify-between items-end mb-8">
                        <h3 class="text-xl font-bold tracking-tight">Distribución Mensual</h3>
                        <div class="flex gap-4 border-b border-slate-100 dark:border-slate-700">
                            <button class="pb-2 border-b-2 border-primary text-primary font-bold text-sm">Mensual</button>
                            <button class="pb-2 text-slate-400 font-bold text-sm hover:text-slate-600">Trimestral</button>
                            <button class="pb-2 text-slate-400 font-bold text-sm hover:text-slate-600">Anual</button>
                        </div>
                    </div>
                    <div class="flex items-center gap-12">
                        <div class="relative size-64 flex items-center justify-center shrink-0">
                            <svg class="size-full transform -rotate-90" viewBox="0 0 100 100">
                                <circle class="text-slate-100 dark:text-slate-700" cx="50" cy="50" fill="transparent" r="40" stroke="currentColor" stroke-width="12"></circle>
                                <circle id="circle-gas-main" cx="50" cy="50" fill="transparent" r="40" stroke="#176282" stroke-dasharray="251.2" stroke-dashoffset="113" stroke-linecap="round" stroke-width="12"></circle>
                            </svg>
                            <div class="absolute inset-0 flex flex-col items-center justify-center">
                                <span class="text-xs text-slate-400 font-bold uppercase tracking-wider">Total Gastos</span>
                                <span id="total-center-display" class="text-3xl font-black text-slate-800 dark:text-white">$0</span>
                            </div>
                        </div>
                        <div class="flex-1 grid grid-cols-2 gap-8">
                            <div><p class="text-[10px] font-black text-primary uppercase mb-4 tracking-widest">Mayores Gastos</p><div id="list-top-gastos" class="space-y-4"></div></div>
                            <div><p class="text-[10px] font-black text-[#4db3da] uppercase mb-4 tracking-widest">Mayores Ingresos</p><div id="list-top-ingresos" class="space-y-4"></div></div>
                        </div>
                    </div>
                </div>

                <div class="bg-white dark:bg-slate-800 rounded-xl overflow-hidden shadow-sm border border-slate-100 dark:border-slate-700">
                    <div class="p-6 border-b border-slate-50 dark:border-slate-700"><h3 class="text-lg font-bold tracking-tight">Resumen de Rendimiento</h3></div>
                    <table class="w-full text-left">
                        <thead class="bg-slate-50 dark:bg-slate-800/50"><tr>
                            <th class="px-6 py-4 text-xs font-black uppercase text-slate-400 tracking-widest">Categoría</th>
                            <th class="px-6 py-4 text-xs font-black uppercase text-slate-400 tracking-widest text-right">Presupuesto</th>
                            <th class="px-6 py-4 text-xs font-black uppercase text-slate-400 tracking-widest text-right">Real</th>
                            <th class="px-6 py-4 text-xs font-black uppercase text-slate-400 tracking-widest text-right">Indicador</th>
                        </tr></thead>
                        <tbody class="divide-y divide-slate-50 dark:divide-slate-700">
                            <tr><td class="px-6 py-4 font-semibold text-sm">Ingresos Mensuales</td><td class="px-6 py-4 text-sm font-bold text-right">$5,000</td><td id="ing-real" class="px-6 py-4 text-sm font-black text-right">$0</td><td id="ind-ing" class="px-6 py-4 text-right"></td></tr>
                            <tr><td class="px-6 py-4 font-semibold text-sm">Gastos Totales</td><td class="px-6 py-4 text-sm font-bold text-right">$3,200</td><td id="gas-real" class="px-6 py-4 text-sm font-black text-right">$0</td><td id="ind-gas" class="px-6 py-4 text-right"></td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <section class="flex-1 space-y-6">
                <div class="flex justify-between items-center"><h3 class="text-xl font-bold tracking-tight">Metas de Ahorro</h3><button class="size-10 rounded-xl bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 hover:bg-primary hover:text-white transition-all flex items-center justify-center group"><span class="material-symbols-outlined">add</span></button></div>
                <div id="metas-container-dinamico">
                    </div>
            </section>
        </div>
    </main>
</div>
</body></html>
