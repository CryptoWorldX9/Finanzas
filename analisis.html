function actualizarAnalisis(datos) {
        let ingresos = 0, gastos = 0, listaGastos = [];
        let conteoConceptos = {};
        
        datos.forEach(m => {
            const monto = Number(m.monto) || 0;
            if (m.tipo.toLowerCase().includes('ingreso')) {
                ingresos += monto;
            } else {
                gastos += monto;
                listaGastos.push(m);
                conteoConceptos[m.concepto] = (conteoConceptos[m.concepto] || 0) + 1;
            }
        });

        const saldo = ingresos - gastos;
        const porcentajeAhorro = ingresos > 0 ? Math.max(0, ((saldo / ingresos) * 100)) : 0;
        const diasActivos = Math.max(filtroActual, 1);
        const gastoPromedioDiario = gastos / diasActivos;
        const masFrecuente = Object.entries(conteoConceptos).sort((a,b) => b[1] - a[1])[0]?.[0] || 'N/A';

        // Render Matriz Pro Superior
        document.getElementById('matriz-pro-superior').innerHTML = `
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <div class="bg-white dark:bg-slate-800 p-4 rounded-xl border border-slate-100 dark:border-slate-700 shadow-sm">
                    <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1">Gasto Diario Prom.</p>
                    <p class="text-lg font-black text-slate-700 dark:text-white">$${new Intl.NumberFormat('es-CL').format(Math.round(gastoPromedioDiario))}</p>
                </div>
                <div class="bg-white dark:bg-slate-800 p-4 rounded-xl border border-slate-100 dark:border-slate-700 shadow-sm">
                    <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1">Frecuencia Mayor</p>
                    <p class="text-lg font-black text-primary truncate">${masFrecuente}</p>
                </div>
                <div class="bg-white dark:bg-slate-800 p-4 rounded-xl border border-slate-100 dark:border-slate-700 shadow-sm">
                    <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1">Eficiencia de Ahorro</p>
                    <p class="text-lg font-black text-emerald-500">${porcentajeAhorro.toFixed(1)}%</p>
                </div>
                <div class="bg-white dark:bg-slate-800 p-4 rounded-xl border border-slate-100 dark:border-slate-700 shadow-sm">
                    <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1">Flujo Total</p>
                    <p class="text-lg font-black text-slate-700 dark:text-white">${datos.length}</p>
                </div>
            </div>`;

        // Actualización del Centro del Gráfico
        document.getElementById('centro-monto').innerText = `${porcentajeAhorro.toFixed(0)}%`;
        document.getElementById('subcentro-texto').innerText = `AHORRO`;
        document.getElementById('centro-monto').className = `text-3xl md:text-4xl font-black text-emerald-500`;

        const topGastos = listaGastos.sort((a, b) => b.monto - a.monto).slice(0, 4);
        const contenedorLista = document.getElementById('lista-categorias-gastos');
        contenedorLista.innerHTML = topGastos.map(g => {
            const style = getIconByConcepto(g.concepto);
            return `
                <div class="flex items-center justify-between p-2">
                    <div class="flex items-center gap-3">
                        <div class="size-9 rounded-lg flex items-center justify-center ${style.col}">
                            <span class="material-symbols-outlined text-xl">${style.ico}</span>
                        </div>
                        <span class="text-sm font-bold truncate w-24 md:w-32 text-slate-700 dark:text-slate-200">${g.concepto}</span>
                    </div>
                    <span class="text-sm font-black text-red-500">$${new Intl.NumberFormat('es-CL').format(g.monto)}</span>
                </div>`;
        }).join('');

        // Lógica del Gráfico con Segmento de Ahorro
        const ctx = document.getElementById('graficoDistribucion').getContext('2d');
        if (miGrafico) miGrafico.destroy();
        
        // Si el gasto supera el ingreso, el ahorro es 0 para el gráfico
        const dataGrafico = [gastos, Math.max(0, ingresos - gastos)];
        
        miGrafico = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Gastos', 'Ahorro Real'],
                datasets: [{
                    data: dataGrafico,
                    backgroundColor: ['#ef4444', '#10b981'],
                    hoverOffset: 12, 
                    borderWidth: 0, 
                    borderRadius: 10,
                    spacing: 5
                }]
            },
            options: {
                cutout: '75%',
                plugins: {
                    legend: { display: false },
                    datalabels: { display: false }
                },
                responsive: true, 
                maintainAspectRatio: false
            }
        });

        // Métricas Pro Inferiores
        document.getElementById('resumen-rendimiento-dinamico').innerHTML = `
            <div class="grid grid-cols-2 gap-4 p-6">
                <div class="p-4 bg-slate-50 dark:bg-slate-700/30 rounded-xl border border-slate-100 dark:border-slate-700">
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Saldo Líquido</p>
                    <p class="text-lg md:text-xl font-black text-primary">$${new Intl.NumberFormat('es-CL').format(saldo)}</p>
                </div>
                <div class="p-4 bg-slate-50 dark:bg-slate-700/30 rounded-xl border border-slate-100 dark:border-slate-700">
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Gasto vs Ingreso</p>
                    <p class="text-lg md:text-xl font-black ${gastos > ingresos ? 'text-red-500' : 'text-slate-700 dark:text-white'}">${ingresos > 0 ? ((gastos/ingresos)*100).toFixed(0) : 0}%</p>
                </div>
                <div class="p-4 bg-slate-50 dark:bg-slate-700/30 rounded-xl border border-slate-100 dark:border-slate-700">
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Días de Autonomía</p>
                    <p class="text-lg md:text-xl font-black text-primary">${gastoPromedioDiario > 0 ? Math.floor(saldo/gastoPromedioDiario) : '0'} Días</p>
                </div>
                <div class="p-4 bg-slate-50 dark:bg-slate-700/30 rounded-xl border border-slate-100 dark:border-slate-700">
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Score Salud</p>
                    <p class="text-lg md:text-xl font-black ${porcentajeAhorro > 20 ? 'text-emerald-500' : 'text-orange-500'}">${porcentajeAhorro > 20 ? 'Óptimo' : 'Mejorable'}</p>
                </div>
            </div>`;
    }
