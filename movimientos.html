<!DOCTYPE html>
<html class="light" lang="es">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>QuantyA - Gestión de Movimientos</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCO6WXu9iZsyEUmNNxrE4oWToLYY8wl-y4",
            authDomain: "misfinanzaspro-d2f3f.firebaseapp.com",
            databaseURL: "https://misfinanzaspro-d2f3f-default-rtdb.firebaseio.com",
            projectId: "misfinanzaspro-d2f3f",
            storageBucket: "misfinanzaspro-d2f3f.firebasestorage.app",
            messagingSenderId: "613366165036",
            appId: "1:613366165036:web:bebc72b38d39ab64932b89"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        
        let allMovements = JSON.parse(localStorage.getItem('cache_movimientos')) || [];
        let currentUser = null;

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                // Renderizado inicial con lo que haya en caché para velocidad 0ms
                if(allMovements.length > 0) filtrarYRenderizar();
                inicializarApp();
            } else {
                window.location.href = "index.html";
            }
        });

        function inicializarApp() {
            // Categorías dinámicas
            const listasRef = ref(db, `usuarios/${currentUser.uid}/listas/categoria`);
            onValue(listasRef, (snapshot) => {
                const selectCat = document.getElementById('filter-categoria');
                const fragment = document.createDocumentFragment();
                const optTodas = document.createElement('option');
                optTodas.value = "Todas"; optTodas.textContent = "Todas";
                fragment.appendChild(optTodas);

                if (snapshot.exists()) {
                    snapshot.forEach(child => {
                        const opt = document.createElement('option');
                        opt.value = child.val().nombre;
                        opt.textContent = child.val().nombre;
                        fragment.appendChild(opt);
                    });
                }
                selectCat.innerHTML = '';
                selectCat.appendChild(fragment);
            });

            // Movimientos con Sincronización Fluida
            const movRef = ref(db, `usuarios/${currentUser.uid}/movimientos`);
            onValue(movRef, (snapshot) => {
                const nuevosDatos = [];
                snapshot.forEach(child => {
                    nuevosDatos.push({ id: child.key, ...child.val() });
                });
                
                nuevosDatos.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
                
                // Si los datos son distintos a la caché, actualizamos
                if(JSON.stringify(nuevosDatos) !== JSON.stringify(allMovements)) {
                    allMovements = nuevosDatos;
                    localStorage.setItem('cache_movimientos', JSON.stringify(allMovements));
                    requestAnimationFrame(filtrarYRenderizar);
                }
            });
        }

        window.filtrarYRenderizar = () => {
            const searchText = document.getElementById('filter-search').value.toLowerCase();
            const type = document.getElementById('filter-tipo').value;
            const category = document.getElementById('filter-categoria').value;
            const date = document.getElementById('filter-fecha').value;

            const filtered = allMovements.filter(m => {
                const matchSearch = (m.concepto || "").toLowerCase().includes(searchText) || (m.id && m.id.toLowerCase().includes(searchText));
                const matchType = type === "Todos" || (type === "Ingresos" && m.tipo.includes("Ingreso")) || (type === "Egresos" && !m.tipo.includes("Ingreso"));
                const matchCat = category === "Todas" || m.categoria === category;
                const matchDate = !date || m.fecha === date;
                return matchSearch && matchType && matchCat && matchDate;
            });

            renderTable(filtered);
        };

        function renderTable(data) {
            const tbody = document.getElementById('table-body');
            const fragment = document.createDocumentFragment();
            
            data.forEach(m => {
                const isIngreso = m.tipo.toLowerCase().includes('ingreso') || m.tipo.toLowerCase().includes('venta');
                
                // Lógica de colores Pro por método de pago
                const metodo = (m.pago || 'Otro').toLowerCase();
                let colorClase = 'bg-slate-100 text-slate-600 border-slate-200';

                if (metodo.includes('transferencia')) {
                    colorClase = 'bg-emerald-100 text-emerald-700 border-emerald-200';
                } else if (metodo.includes('debito') || metodo.includes('tarjeta')) {
                    colorClase = 'bg-blue-100 text-blue-700 border-blue-200';
                } else if (metodo.includes('credito')) {
                    colorClase = 'bg-purple-100 text-purple-700 border-purple-200';
                } else if (metodo.includes('efectivo')) {
                    colorClase = 'bg-amber-100 text-amber-700 border-amber-200';
                }

                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50/50 dark:hover:bg-slate-800/30 transition-colors border-b border-slate-100 dark:border-slate-800 last:border-0";
                tr.innerHTML = `
                    <td class="px-6 py-4 text-sm text-slate-500">${m.fecha}</td>
                    <td class="px-6 py-4">
                        <p class="text-sm font-bold text-slate-700 dark:text-slate-200">${m.concepto}</p>
                        <p class="text-[10px] text-slate-400 uppercase tracking-tight font-medium">CAT: ${m.categoria} | ${m.subcategoria || 'General'}</p>
                    </td>
                    <td class="px-6 py-4 text-sm font-black text-right ${isIngreso ? 'text-emerald-custom' : 'text-red-500'}">
                        ${isIngreso ? '+' : '-'} $${new Intl.NumberFormat('es-CL').format(m.monto)}
                    </td>
                    <td class="px-6 py-4">
                        <span class="${colorClase} border text-[10px] font-black px-2.5 py-1 rounded-full uppercase tracking-tighter">
                            ${m.pago}
                        </span>
                    </td>
                `;
                fragment.appendChild(tr);
            });

            tbody.innerHTML = '';
            tbody.appendChild(fragment);
        }
    </script>

    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#176282",
                        "navy-900": "#0f172a",
                        "slate-custom": "#64748b",
                        "emerald-custom": "#10b981",
                        "background-light": "#f8f9fa"
                    },
                    fontFamily: { "display": ["Inter", "sans-serif"] }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        body { font-family: 'Inter', sans-serif; }
        .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24; }
    </style>
</head>
<body class="bg-background-light dark:bg-[#111827] font-display text-slate-900 dark:text-slate-100">

<div class="flex min-h-screen">
    <aside class="w-64 bg-[#0f172a] text-white flex flex-col fixed h-full z-50 border-r border-slate-800">
        <div class="p-6 flex items-center gap-3">
            <div class="size-10 bg-primary rounded-lg flex items-center justify-center">
                <span class="material-symbols-outlined text-white text-2xl">account_balance_wallet</span>
            </div>
            <div>
                <h1 class="text-xl font-bold tracking-tight">QuantyA</h1>
                <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Gestión Profesional</p>
            </div>
        </div>

        <nav class="flex-1 px-4 mt-4 space-y-1">
            <a href="dashboard.html" class="flex items-center gap-3 px-4 py-3 rounded-lg text-slate-400 hover:bg-slate-800 hover:text-white transition-colors">
                <span class="material-symbols-outlined text-[20px]">dashboard</span>
                <span class="text-sm font-medium">Panel</span>
            </a>
            <a href="movimientos.html" class="flex items-center gap-3 px-4 py-3 rounded-lg bg-primary text-white transition-all shadow-lg shadow-primary/20">
                <span class="material-symbols-outlined text-[20px]">swap_horiz</span>
                <span class="text-sm font-medium">Movimientos</span>
            </a>
            <a href="analisis.html" class="flex items-center gap-3 px-4 py-3 rounded-lg text-slate-400 hover:bg-slate-800 hover:text-white transition-colors">
                <span class="material-symbols-outlined text-[20px]">analytics</span>
                <span class="text-sm font-medium">Análisis</span>
            </a>
            <a href="metas.html" class="flex items-center gap-3 px-4 py-3 rounded-lg text-slate-400 hover:bg-slate-800 hover:text-white transition-colors">
                <span class="material-symbols-outlined text-[20px]">track_changes</span>
                <span class="text-sm font-medium">Metas</span>
            </a>
            <a href="reportes.html" class="flex items-center gap-3 px-4 py-3 rounded-lg text-slate-400 hover:bg-slate-800 hover:text-white transition-colors">
                <span class="material-symbols-outlined text-[20px]">description</span>
                <span class="text-sm font-medium">Reportes</span>
            </a>
            <a href="configuracion.html" class="flex items-center gap-3 px-4 py-3 rounded-lg text-slate-400 hover:bg-slate-800 hover:text-white transition-colors">
                <span class="material-symbols-outlined text-[20px]">settings</span>
                <span class="text-sm font-medium">Configuración</span>
            </a>
        </nav>

        <div class="p-4 border-t border-slate-800">
            <a href="index.html" class="flex items-center gap-3 px-4 py-3 text-red-400 hover:bg-red-500/10 rounded-lg transition-colors">
                <span class="material-symbols-outlined text-[20px]">logout</span>
                <span class="text-sm font-medium">Cerrar Sesión</span>
            </a>
        </div>
    </aside>

    <main class="ml-64 flex-1 flex flex-col">
        <header class="h-16 bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800 px-8 flex items-center justify-between sticky top-0 z-40">
            <h2 class="text-lg font-bold text-slate-700 dark:text-slate-200">Registro de Movimientos</h2>
            <a href="dashboard.html" class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-lg text-xs font-bold shadow-lg flex items-center gap-2 transition-all">
                <span class="material-symbols-outlined text-sm">add</span> Nuevo Movimiento
            </a>
        </header>

        <div class="p-8 space-y-8 max-w-[1440px] mx-auto w-full">
            <section class="bg-white dark:bg-slate-900 p-6 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm">
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                    <div>
                        <label class="block text-[10px] font-black text-slate-500 uppercase mb-1.5">Buscador</label>
                        <input id="filter-search" oninput="filtrarYRenderizar()" type="text" placeholder="Concepto o ID..." class="w-full bg-slate-50 dark:bg-slate-800 border-slate-200 dark:border-slate-700 rounded-lg text-sm focus:ring-primary">
                    </div>
                    <div>
                        <label class="block text-[10px] font-black text-slate-500 uppercase mb-1.5">Tipo</label>
                        <select id="filter-tipo" onchange="filtrarYRenderizar()" class="w-full bg-slate-50 dark:bg-slate-800 border-slate-200 dark:border-slate-700 rounded-lg text-sm font-bold text-slate-600 dark:text-slate-300">
                            <option>Todos</option>
                            <option>Ingresos</option>
                            <option>Egresos</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-[10px] font-black text-slate-500 uppercase mb-1.5">Categoría</label>
                        <select id="filter-categoria" onchange="filtrarYRenderizar()" class="w-full bg-slate-50 dark:bg-slate-800 border-slate-200 dark:border-slate-700 rounded-lg text-sm">
                            <option>Todas</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-[10px] font-black text-slate-500 uppercase mb-1.5">Fecha</label>
                        <input id="filter-fecha" onchange="filtrarYRenderizar()" type="date" class="w-full bg-slate-50 dark:bg-slate-800 border-slate-200 dark:border-slate-700 rounded-lg text-sm">
                    </div>
                    <div class="flex items-end">
                        <button onclick="document.getElementById('filter-search').value=''; document.getElementById('filter-fecha').value=''; filtrarYRenderizar();" class="w-full bg-slate-800 dark:bg-slate-700 text-white font-bold py-2.5 rounded-lg text-xs uppercase tracking-widest hover:bg-slate-700 transition-colors">Limpiar</button>
                    </div>
                </div>
            </section>

            <div class="bg-white dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm overflow-hidden">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-slate-50 dark:bg-slate-800/50">
                            <th class="px-6 py-4 text-[10px] font-black text-slate-500 dark:text-slate-400 uppercase tracking-widest">Fecha</th>
                            <th class="px-6 py-4 text-[10px] font-black text-slate-500 dark:text-slate-400 uppercase tracking-widest">Concepto / Ref</th>
                            <th class="px-6 py-4 text-[10px] font-black text-slate-500 dark:text-slate-400 uppercase tracking-widest text-right">Monto</th>
                            <th class="px-6 py-4 text-[10px] font-black text-slate-500 dark:text-slate-400 uppercase tracking-widest">Método</th>
                        </tr>
                    </thead>
                    <tbody id="table-body" class="divide-y divide-slate-100 dark:divide-slate-800">
                        </tbody>
                </table>
            </div>
        </div>
    </main>
</div>

</body>
</html>
