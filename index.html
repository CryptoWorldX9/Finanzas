<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finanzas PRO | Smart Management</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    
    <style>
        :root { 
            --p: #0f172a; --acc: #2563eb; --bg: #f8fafc; 
            --danger: #ef4444; --success: #10b981; --warning: #f59e0b;
            --sidebar-w: 260px;
        }
        * { margin:0; padding:0; box-sizing:border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--bg); display: flex; min-height: 100vh; color: #1e293b; overflow-x: hidden; }

        /* Sidebar & Navigation */
        .sidebar { 
            width: var(--sidebar-w); background: var(--p); color: white; padding: 25px; 
            position: fixed; height: 100vh; z-index: 1000; transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1); 
        }
        .main-content { margin-left: var(--sidebar-w); padding: 30px; width: calc(100% - var(--sidebar-w)); transition: 0.4s; }

        .nav-link { display: flex; align-items: center; gap: 12px; padding: 14px; color: #cbd5e1; cursor: pointer; border-radius: 12px; margin-bottom: 8px; transition: 0.3s; }
        .nav-link:hover, .nav-link.active { background: var(--acc); color: white; transform: translateX(5px); }

        /* Mobile Menu */
        .menu-toggle { display: none; position: fixed; top: 15px; left: 15px; z-index: 1100; background: var(--p); color: white; border: none; padding: 10px; border-radius: 8px; cursor: pointer; }

        /* Coach & Header */
        .header-meta { margin-bottom: 5px; color: var(--acc); font-weight: 700; font-size: 12px; letter-spacing: 2px; text-transform: uppercase; }
        .coach-bubble { 
            background: white; border-radius: 18px; padding: 20px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.05); border-left: 6px solid var(--acc); 
            margin-bottom: 30px; position: relative;
        }

        /* Cards & Inputs */
        .card { background: white; border-radius: 16px; padding: 25px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); margin-bottom: 25px; border: 1px solid #eef2f6; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 18px; margin-bottom: 18px; }
        
        label { font-size: 11px; font-weight: 800; color: #64748b; text-transform: uppercase; margin-bottom: 6px; display: block; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 10px; font-size: 14px; background: #fdfdfd; }
        input:focus { border-color: var(--acc); outline: none; box-shadow: 0 0 0 4px rgba(37,99,235,0.1); }
        
        .btn { padding: 14px 24px; border-radius: 10px; border: none; cursor: pointer; font-weight: 700; transition: 0.3s; display: flex; align-items: center; gap: 10px; justify-content: center; }
        .btn-p { background: var(--acc); color: white; }
        .btn-p:hover { box-shadow: 0 8px 15px rgba(37,99,235,0.3); }

        /* Table Design */
        .table-container { overflow-x: auto; border-radius: 12px; border: 1px solid #eef2f6; }
        table { width: 100%; border-collapse: collapse; background: white; }
        th { background: #f8fafc; padding: 15px; text-align: left; color: #64748b; font-size: 12px; }
        td { padding: 15px; border-bottom: 1px solid #f1f5f9; font-size: 13px; }

        /* Responsive Mobile */
        @media (max-width: 900px) {
            .sidebar { left: -100%; width: 280px; }
            .sidebar.open { left: 0; }
            .main-content { margin-left: 0; width: 100%; padding: 70px 15px 20px 15px; }
            .menu-toggle { display: block; }
            .form-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<button class="menu-toggle" onclick="toggleMenu()">‚ò∞</button>

<nav class="sidebar" id="sidebar">
    <h2 style="margin-bottom: 30px; font-weight: 900;">FINANZAS PRO</h2>
    <div class="nav-link active" onclick="showTab('registro')">üìù <span>Registro</span></div>
    <div class="nav-link" onclick="showTab('historial')">üìú <span>Historial</span></div>
    <div class="nav-link" onclick="showTab('analisis')">üìä <span>An√°lisis</span></div>
    <div class="nav-link" onclick="showTab('ajustes')">‚öôÔ∏è <span>Ajustes</span></div>
</nav>

<main class="main-content">
    <div class="header-meta">Sistema Inteligente de Gesti√≥n Patrimonial</div>
    <div class="coach-bubble">
        <small style="color: var(--acc); font-weight: 800; display: block; margin-bottom: 5px;">SABIDUR√çA FINANCIERA ‚ú®</small>
        <p id="tip-text">Cargando inteligencia...</p>
    </div>

    <div id="registro" class="tab-content">
        <div class="card">
            <h3 id="form-title">Registrar Transacci√≥n</h3><br>
            <input type="hidden" id="edit-id">
            <div class="form-grid">
                <div><label>Fecha</label><input type="date" id="f_fecha"></div>
                <div><label>Tipo</label><select id="f_tipo"><option>Egreso</option><option>Ingreso</option></select></div>
                <div><label>Monto</label><input type="number" id="f_monto" oninput="calcDiff()"></div>
                <div><label>Presupuesto</label><input type="number" id="f_presupuesto" oninput="calcDiff()"></div>
            </div>
            <div class="form-grid">
                <div><label>Categor√≠a</label><select id="f_cat" onchange="updateSubSelect()"></select></div>
                <div><label>Subcategor√≠a</label><select id="f_subcat"></select></div>
                <div><label>Concepto</label><input type="text" id="f_concepto"></div>
                <div><label>Proveedor</label><select id="f_proveedor"></select></div>
            </div>
            <div class="form-grid">
                <div><label>Forma Pago</label><select id="f_pago"></select></div>
                <div><label>Estado</label><select id="f_estado"><option>Pagado</option><option>Pendiente</option></select></div>
                <div><label>Gasto</label><select id="f_gasto_tipo"><option>Fijo</option><option>Variable</option></select></div>
                <div><label>Diferencia</label><div id="val_diff" style="font-weight:900; padding:10px;">$0</div></div>
            </div>
            <button class="btn btn-p" onclick="saveData()">üíæ SINCRONIZAR CON NUBE</button>
        </div>
    </div>

    <div id="historial" class="tab-content" style="display:none;">
        <div class="card">
            <h3>Explorador de Movimientos</h3><br>
            <div style="display:flex; gap:10px; margin-bottom:20px; flex-wrap:wrap;">
                <input type="text" id="search_input" placeholder="Buscar por concepto, categor√≠a o proveedor..." oninput="renderHistorialFull()" style="flex:2;">
                <select id="filter_mes_h" onchange="renderHistorialFull()" style="flex:1;"></select>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr><th>Fecha</th><th>Concepto</th><th>Categor√≠a</th><th>Monto</th><th>Acciones</th></tr>
                    </thead>
                    <tbody id="hist_body_full"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="analisis" class="tab-content" style="display:none;">
        <div class="form-grid">
            <div class="card"><h3>Distribuci√≥n de Gastos</h3><canvas id="chartPie"></canvas></div>
            <div class="card"><h3>Top 5 Impactos</h3><div id="topList"></div></div>
        </div>
    </div>

    <div id="ajustes" class="tab-content" style="display:none;">
        <div class="form-grid">
            <div class="card">
                <label>Gestionar Categor√≠as</label>
                <div style="display:flex; gap:5px; margin-bottom:10px;"><input type="text" id="new_cat"><button onclick="addSet('cats','new_cat')" class="btn btn-p" style="width:45px">+</button></div>
                <div id="list_cats"></div>
            </div>
            <div class="card">
                <label>Proveedores</label>
                <div style="display:flex; gap:5px; margin-bottom:10px;"><input type="text" id="new_prov"><button onclick="addSet('proveedores','new_prov')" class="btn btn-p" style="width:45px">+</button></div>
                <div id="list_provs"></div>
            </div>
        </div>
    </div>
</main>

<script>
    // FIREBASE
    const firebaseConfig = {
      apiKey: "AIzaSyCO6WXu9iZsyEUmNNxrE4oWToLYY8wl-y4",
      authDomain: "misfinanzaspro-d2f3f.firebaseapp.com",
      databaseURL: "https://misfinanzaspro-d2f3f-default-rtdb.firebaseio.com",
      projectId: "misfinanzaspro-d2f3f",
      storageBucket: "misfinanzaspro-d2f3f.firebasestorage.app",
      messagingSenderId: "613366165036",
      appId: "1:613366165036:web:bebc72b38d39ab64932b89"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // TIPS (70 FRASES)
    const tips = [
        "Ahorra primero, gasta lo que quede despu√©s.", "El inter√©s compuesto es la octava maravilla del mundo.",
        "Un peque√±o agujero hunde un gran barco. Cuida los gastos hormiga.", "No pongas todos tus huevos en la misma canasta.",
        "El mejor momento para invertir fue ayer, el segundo mejor es hoy.", "Si compras cosas que no necesitas, pronto vender√°s lo que necesitas.",
        "El dinero es un buen siervo pero un mal amo.", "La riqueza no consiste en tener grandes posesiones, sino en tener pocas necesidades.",
        "Invertir en conocimientos produce siempre los mejores beneficios.", "No ahorres lo que te queda despu√©s de gastar, gasta lo que te queda despu√©s de ahorrar.",
        "Tu nivel de gastos no debe crecer al mismo ritmo que tus ingresos.", "P√°gate a ti mismo primero: reserva el 10% de tu sueldo apenas lo recibas.",
        "El cr√©dito es un sistema de esclavitud moderna si no se usa para activos.", "Tener un fondo de emergencia te da libertad de decisi√≥n.",
        "Las ofertas no son ahorro si no ten√≠as planeado comprar ese art√≠culo.", "La inflaci√≥n es el impuesto silencioso, invierte para superarla.",
        "Revisa tus suscripciones: el dinero se fuga en los goteos mensuales.", "Compra calidad, lo barato sale caro a largo plazo.",
        "La mejor inversi√≥n es tu propia salud y educaci√≥n.", "Establece metas claras: ahorrar sin prop√≥sito es dif√≠cil.",
        "Anota cada gasto por 30 d√≠as, te sorprender√° d√≥nde se va tu dinero.", "Evita las deudas de consumo como la peste.",
        "Las tarjetas de cr√©dito son herramientas, no dinero extra.", "Si no puedes pagarlo dos veces, no puedes permit√≠rtelo.",
        "Planifica tus comidas: el delivery es el mayor enemigo del presupuesto mensual.", "Invierte en activos que pongan dinero en tu bolsillo, no pasivos.",
        "El lujo es para cuando ya eres rico, no para parecerlo.", "Aprende a decir NO a compromisos sociales que no puedes costear.",
        "Ahorra para el retiro desde tu primer sueldo, el tiempo es tu aliado.", "Diversifica: diferentes monedas, diferentes mercados.",
        "No sigas consejos financieros de personas que no est√°n donde t√∫ quieres estar.", "La paciencia es la clave de las inversiones exitosas.",
        "Crea m√∫ltiples fuentes de ingresos, no dependas solo de una.", "Usa la regla de las 24 horas antes de compras impulsivas.",
        "La libertad financiera no es trabajar menos, es elegir en qu√© trabajar.", "Un presupuesto te dice a d√≥nde ir, en lugar de preguntarte a d√≥nde se fue.",
        "Automatiza tus ahorros, as√≠ no tienes que pensar en ello.", "Vivir por debajo de tus posibilidades es la verdadera riqueza.",
        "Compara precios siempre, el internet es tu mejor herramienta de ahorro.", "No ignores las facturas, el inter√©s por mora es tirar dinero a la basura.",
        "Usa efectivo para gastos diarios si pierdes el control con la tarjeta.", "Mant√©n tu coche un par de a√±os m√°s de lo planeado.",
        "Educa a tus hijos sobre finanzas, es el mejor legado.", "La envidia financiera es el camino m√°s r√°pido a la quiebra.",
        "Aprende a cocinar: es una de las habilidades m√°s rentables.", "Revisa tus seguros anualmente para buscar mejores primas.",
        "Vende lo que no usas, limpia tu casa y llena tu cartera.", "El tiempo vale m√°s que el dinero, g√°stalo con sabidur√≠a.",
        "No te compares con el vecino, sus deudas pueden ser mayores que las tuyas.", "La disciplina financiera es libertad.",
        "Entiende qu√© est√°s comprando antes de invertir un solo d√≥lar.", "Las crisis son oportunidades disfrazadas para los que tienen efectivo.",
        "Ahorrar es un h√°bito, no una cantidad.", "Aprende la diferencia entre precio y valor.",
        "Nunca inviertas dinero que necesites para el alquiler del mes.", "Mide tu riqueza por cu√°ntos d√≠as podr√≠as vivir sin trabajar.",
        "La simplicidad es la m√°xima sofisticaci√≥n financiera.", "Protege tu capacidad de generar ingresos.",
        "Haz un inventario de lo que tienes antes de ir de compras.", "La gratificaci√≥n instant√°nea es el enemigo del √©xito futuro.",
        "S√© generoso cuando puedas, el dinero fluye hacia quienes lo comparten.", "El optimismo es una estrategia de inversi√≥n.",
        "No asumas riesgos que no puedas explicar a un ni√±o de 5 a√±os.", "Mant√©n tus gastos fijos lo m√°s bajos posible.",
        "El √©xito financiero es 20% conocimiento y 80% comportamiento.", "Tu casa es un activo solo si te genera ingresos.",
        "No dejes que tus emociones manejen tu billetera.", "La mejor deuda es la que no existe.",
        "Ahorrar es comprar tu libertad futura.", "Finanzas PRO es tu mejor aliado, √∫salo a diario."
    ];

    let settings = JSON.parse(localStorage.getItem('fpro_final_settings')) || {
        cats: ['Alimentaci√≥n', 'Vivienda', 'Transporte', 'Salud', 'Ocio'],
        subs: {'Alimentaci√≥n': ['Supermercado', 'Restaurante']},
        proveedores: ['General'],
        pagos: ['Efectivo', 'Tarjeta']
    };
    let rawData = {};

    function init() {
        document.getElementById('f_fecha').valueAsDate = new Date();
        populateMonths();
        updateAllSelects();
        startCoach();
        
        db.ref('movimientos').on('value', snap => {
            rawData = snap.val() || {};
            renderHistorialFull();
        });
    }

    function toggleMenu() { document.getElementById('sidebar').classList.toggle('open'); }

    function startCoach() {
        let i = 0;
        setInterval(() => {
            document.getElementById('tip-text').innerText = tips[i];
            i = (i + 1) % tips.length;
        }, 10000);
        document.getElementById('tip-text').innerText = tips[0];
    }

    function showTab(id) {
        document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
        document.getElementById(id).style.display = 'block';
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        event.currentTarget.classList.add('active');
        if(window.innerWidth < 900) toggleMenu();
        if(id === 'analisis') runAnalysis();
    }

    function saveData() {
        const id = document.getElementById('edit-id').value;
        const fecha = document.getElementById('f_fecha').value;
        const data = {
            fecha, tipo: document.getElementById('f_tipo').value,
            monto: parseFloat(document.getElementById('f_monto').value) || 0,
            presupuesto: parseFloat(document.getElementById('f_presupuesto').value) || 0,
            concepto: document.getElementById('f_concepto').value,
            cat: document.getElementById('f_cat').value,
            subcat: document.getElementById('f_subcat').value,
            proveedor: document.getElementById('f_proveedor').value,
            pago: document.getElementById('f_pago').value,
            estado: document.getElementById('f_estado').value,
            gasto_tipo: document.getElementById('f_gasto_tipo').value,
            mes_anio: fecha.substring(0, 7)
        };
        if(id) db.ref('movimientos/' + id).set(data);
        else db.ref('movimientos').push(data);
        alert("Sincronizado");
        clearForm();
    }

    function renderHistorialFull() {
        const search = document.getElementById('search_input').value.toLowerCase();
        const mes = document.getElementById('filter_mes_h').value;
        const body = document.getElementById('hist_body_full');
        body.innerHTML = '';

        Object.keys(rawData).reverse().forEach(key => {
            const d = rawData[key];
            const matchSearch = d.concepto.toLowerCase().includes(search) || d.cat.toLowerCase().includes(search) || d.proveedor.toLowerCase().includes(search);
            const matchMes = mes === "all" || d.mes_anio === mes;

            if(matchSearch && matchMes) {
                body.innerHTML += `<tr>
                    <td>${d.fecha}</td>
                    <td><b>${d.concepto}</b></td>
                    <td>${d.cat}</td>
                    <td style="color:${d.tipo==='Ingreso'?'green':'red'}">$${d.monto.toLocaleString()}</td>
                    <td>
                        <button onclick="editItem('${key}')">‚úèÔ∏è</button>
                        <button onclick="deleteItem('${key}')">üóëÔ∏è</button>
                    </td>
                </tr>`;
            }
        });
    }

    // Funciones de utilidad iguales a las anteriores...
    function editItem(key) {
        const d = rawData[key];
        document.getElementById('edit-id').value = key;
        document.getElementById('f_fecha').value = d.fecha;
        document.getElementById('f_monto').value = d.monto;
        document.getElementById('f_concepto').value = d.concepto;
        document.getElementById('f_cat').value = d.cat;
        updateSubSelect();
        showTab('registro');
    }

    function deleteItem(key) { if(confirm("¬øEliminar?")) db.ref('movimientos/' + key).remove(); }

    function updateAllSelects() {
        const f = (id, arr) => document.getElementById(id).innerHTML = arr.map(i => `<option>${i}</option>`).join('');
        f('f_cat', settings.cats);
        f('f_proveedor', settings.proveedores);
        f('f_pago', settings.pagos);
        updateSubSelect();
    }

    function updateSubSelect() {
        const cat = document.getElementById('f_cat').value;
        const subs = settings.subs[cat] || ['General'];
        document.getElementById('f_subcat').innerHTML = subs.map(s => `<option>${s}</option>`).join('');
    }

    function calcDiff() {
        const m = parseFloat(document.getElementById('f_monto').value) || 0;
        const p = parseFloat(document.getElementById('f_presupuesto').value) || 0;
        const d = p - m;
        document.getElementById('val_diff').innerText = `$${d.toLocaleString()}`;
        document.getElementById('val_diff').style.color = d < 0 ? 'red' : 'green';
    }

    function clearForm() {
        document.getElementById('edit-id').value = '';
        document.getElementById('f_monto').value = '';
        document.getElementById('f_concepto').value = '';
    }

    function populateMonths() {
        const sel = document.getElementById('filter_mes_h');
        sel.innerHTML = '<option value="all">Todos los meses</option>';
        const now = new Date();
        for(let i=0; i<12; i++) {
            const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
            const val = d.toISOString().substring(0,7);
            sel.innerHTML += `<option value="${val}">${val}</option>`;
        }
    }

    function addSet(key, inputId) {
        const v = document.getElementById(inputId).value;
        if(v) { settings[key].push(v); localStorage.setItem('fpro_final_settings', JSON.stringify(settings)); updateAllSelects(); renderSettings(); }
    }

    function runAnalysis() {
        const gastos = Object.values(rawData).filter(d => d.tipo === 'Egreso');
        const catMap = {};
        gastos.forEach(g => catMap[g.cat] = (catMap[g.cat] || 0) + g.monto);
        const ctx = document.getElementById('chartPie').getContext('2d');
        new Chart(ctx, { type: 'doughnut', data: { labels: Object.keys(catMap), datasets: [{ data: Object.values(catMap), backgroundColor: ['#2563eb', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'] }] } });
    }

    window.onload = init;
</script>
</body>
</html>


