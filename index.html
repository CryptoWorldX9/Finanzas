<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finanzas PRO | Master Edition 2026</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    
    <style>
        :root { 
            --p: #0f172a; --acc: #2563eb; --bg: #f1f5f9; 
            --danger: #ef4444; --success: #10b981; --warning: #f59e0b;
        }
        * { margin:0; padding:0; box-sizing:border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--bg); display: flex; min-height: 100vh; color: #1e293b; }

        /* Navegaci√≥n */
        .sidebar { width: 260px; background: var(--p); color: white; padding: 20px; position: fixed; height: 100vh; z-index: 100; transition: 0.3s; }
        .main-content { margin-left: 260px; padding: 30px; width: calc(100% - 260px); transition: 0.3s; }

        .nav-link { display: flex; align-items: center; gap: 10px; padding: 12px; color: #cbd5e1; cursor: pointer; border-radius: 8px; margin-bottom: 5px; font-weight: 500; }
        .nav-link:hover, .nav-link.active { background: var(--acc); color: white; }

        /* Coach Bubble */
        .coach-bubble { background: white; border-radius: 15px; padding: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border-left: 5px solid var(--acc); margin-bottom: 25px; animation: float 3s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }

        /* Cards */
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); margin-bottom: 20px; border: 1px solid #e2e8f0; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px; }
        
        label { font-size: 11px; font-weight: 700; color: #64748b; text-transform: uppercase; margin-bottom: 5px; display: block; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 14px; transition: 0.2s; }
        input:focus { border-color: var(--acc); outline: none; box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }
        
        .btn { padding: 12px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; transition: 0.2s; display: flex; align-items: center; gap: 8px; justify-content: center; }
        .btn-p { background: var(--acc); color: white; }
        .btn-s { background: #64748b; color: white; }
        .btn-danger { background: var(--danger); color: white; padding: 5px 10px; }

        /* Tablas */
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { background: #f8fafc; padding: 12px; text-align: left; color: #64748b; border-bottom: 2px solid #edf2f7; }
        td { padding: 12px; border-bottom: 1px solid #f1f5f9; }

        .diff-neg { color: var(--danger); font-weight: 800; }
        .diff-pos { color: var(--success); font-weight: 800; }

        @media (max-width: 768px) {
            .sidebar { width: 0; padding: 0; overflow: hidden; }
            .main-content { margin-left: 0; width: 100%; padding: 15px; }
        }
    </style>
</head>
<body>

<nav class="sidebar">
    <h2 style="margin-bottom: 30px; letter-spacing: 1px;">FINANZAS PRO</h2>
    <div class="nav-link active" onclick="showTab('registro')">üìù <span>Registro</span></div>
    <div class="nav-link" onclick="showTab('analisis')">üìä <span>An√°lisis</span></div>
    <div class="nav-link" onclick="showTab('ajustes')">‚öôÔ∏è <span>Ajustes</span></div>
</nav>

<main class="main-content">
    <div class="coach-bubble">
        <small style="color: var(--acc); font-weight: 800;">TIPS DE AHORRO ‚ú®</small>
        <p id="tip-text">Cargando consejos financieros...</p>
    </div>

    <div id="registro" class="tab-content">
        <div class="card">
            <h3 id="form-title">Nueva Operaci√≥n</h3><br>
            <input type="hidden" id="edit-id">
            
            <div class="form-grid">
                <div><label>Fecha</label><input type="date" id="f_fecha"></div>
                <div><label>Tipo</label><select id="f_tipo"><option>Egreso</option><option>Ingreso</option></select></div>
                <div><label>Monto ($)</label><input type="number" id="f_monto" oninput="calcDiff()"></div>
                <div><label>Presupuesto ($)</label><input type="number" id="f_presupuesto" oninput="calcDiff()"></div>
            </div>

            <div class="form-grid">
                <div><label>Concepto</label><input type="text" id="f_concepto" placeholder="Ej: Cuenta de agua"></div>
                <div><label>Categor√≠a</label><select id="f_cat" onchange="updateSubSelect()"></select></div>
                <div><label>Subcategor√≠a</label><select id="f_subcat"></select></div>
                <div><label>Proveedor</label><select id="f_proveedor"></select></div>
            </div>

            <div class="form-grid">
                <div><label>Forma de Pago</label><select id="f_pago"></select></div>
                <div><label>Estado</label>
                    <select id="f_estado">
                        <option>Pagado</option>
                        <option>Pendiente</option>
                        <option>Vencido</option>
                    </select>
                </div>
                <div><label>Gasto</label>
                    <select id="f_gasto_tipo">
                        <option>Fijo</option>
                        <option>Variable</option>
                    </select>
                </div>
                <div><label>Recurrente</label>
                    <select id="f_recurrente"><option>No</option><option>S√≠</option></select>
                </div>
            </div>

            <div style="margin-bottom:15px;"><label>Observaciones</label><textarea id="f_obs" rows="2"></textarea></div>

            <div style="display:flex; justify-content: space-between; align-items:center; flex-wrap:wrap; gap:10px;">
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-p" onclick="saveData()">üíæ GUARDAR EN NUBE</button>
                    <button class="btn btn-s" onclick="clearForm()">üßπ LIMPIAR</button>
                </div>
                <div style="font-size: 18px;"><b>Diferencia: </b><span id="val_diff">$0</span></div>
            </div>
        </div>

        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3>Listado Mensual</h3>
                <select id="filter_mes" onchange="renderList()" style="width:auto;"></select>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr><th>Fecha</th><th>Concepto</th><th>Categor√≠a</th><th>Monto</th><th>Estado</th><th>Acciones</th></tr>
                    </thead>
                    <tbody id="list_body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="analisis" class="tab-content" style="display:none;">
        <div class="form-grid">
            <div class="card"><h3>Gastos por Categor√≠a</h3><canvas id="chartPie"></canvas></div>
            <div class="card"><h3>Top 5 Gastos Fuertes</h3><div id="topList"></div></div>
        </div>
    </div>

    <div id="ajustes" class="tab-content" style="display:none;">
        <h2>Configuraci√≥n de Listas</h2><br>
        <div class="form-grid">
            <div class="card">
                <label>Categor√≠as</label>
                <div style="display:flex; gap:5px; margin-bottom:10px;"><input type="text" id="new_cat"><button onclick="addSet('cats','new_cat')" class="btn btn-p">+</button></div>
                <div id="list_cats"></div>
            </div>
            <div class="card">
                <label>Subcategor√≠as de:</label>
                <select id="sel_cat_sub" onchange="renderSettings()"></select>
                <div style="display:flex; gap:5px; margin-top:10px;"><input type="text" id="new_sub"><button onclick="addSub()" class="btn btn-p">+</button></div>
                <div id="list_subs" style="margin-top:10px;"></div>
            </div>
            <div class="card">
                <label>Proveedores</label>
                <div style="display:flex; gap:5px; margin-bottom:10px;"><input type="text" id="new_prov"><button onclick="addSet('proveedores','new_prov')" class="btn btn-p">+</button></div>
                <div id="list_provs"></div>
            </div>
            <div class="card">
                <label>Formas de Pago</label>
                <div style="display:flex; gap:5px; margin-bottom:10px;"><input type="text" id="new_pago"><button onclick="addSet('pagos','new_pago')" class="btn btn-p">+</button></div>
                <div id="list_pagos"></div>
            </div>
        </div>
    </div>
</main>

<script>
    // CONFIGURACI√ìN FIREBASE
    const firebaseConfig = {
      apiKey: "AIzaSyCO6WXu9iZsyEUmNNxrE4oWToLYY8wl-y4",
      authDomain: "misfinanzaspro-d2f3f.firebaseapp.com",
      databaseURL: "https://misfinanzaspro-d2f3f-default-rtdb.firebaseio.com", 
      projectId: "misfinanzaspro-d2f3f",
      storageBucket: "misfinanzaspro-d2f3f.firebasestorage.app",
      messagingSenderId: "613366165036",
      appId: "1:613366165036:web:bebc72b38d39ab64932b89"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ESTADO LOCAL
    let settings = JSON.parse(localStorage.getItem('fpro_v4_settings')) || {
        cats: ['Servicios b√°sicos', 'Alimentaci√≥n', 'Transporte', 'Vivienda', 'Ocio'],
        subs: {'Servicios b√°sicos': ['Agua potable', 'Luz', 'Gas', 'Internet']},
        proveedores: ['Aguas Andinas', 'Enel', 'Gasco', 'Walmart'],
        pagos: ['D√©bito', 'Cr√©dito', 'Efectivo', 'Transferencia']
    };

    let rawData = {};
    const tips = [
        "¬øSab√≠as que ahorrando $1.000 diarios al a√±o sumas $365.000 para tus vacaciones?",
        "Regla 50/30/20: 50% Necesidades, 30% Gustos, 20% Ahorro.",
        "Los gastos fijos no deben superar el 60% de tus ingresos totales.",
        "Revisa tus suscripciones mensuales, ¬°muchas veces pagamos lo que no usamos!",
        "Siempre compara el precio por unidad en el supermercado para ahorrar de verdad."
    ];

    function init() {
        document.getElementById('f_fecha').valueAsDate = new Date();
        populateMonths();
        updateAllSelects();
        startCoach();
        
        db.ref('movimientos').on('value', (snap) => {
            rawData = snap.val() || {};
            renderList();
            if(document.getElementById('analisis').style.display === 'block') runAnalysis();
        });
    }

    // COACH
    function startCoach() {
        let i = 0;
        setInterval(() => {
            document.getElementById('tip-text').innerText = tips[i];
            i = (i + 1) % tips.length;
        }, 8000);
        document.getElementById('tip-text').innerText = tips[0];
    }

    // REGISTRO
    function saveData() {
        const id = document.getElementById('edit-id').value;
        const fecha = document.getElementById('f_fecha').value;
        const data = {
            fecha,
            tipo: document.getElementById('f_tipo').value,
            monto: parseFloat(document.getElementById('f_monto').value) || 0,
            presupuesto: parseFloat(document.getElementById('f_presupuesto').value) || 0,
            concepto: document.getElementById('f_concepto').value,
            cat: document.getElementById('f_cat').value,
            subcat: document.getElementById('f_subcat').value,
            proveedor: document.getElementById('f_proveedor').value,
            pago: document.getElementById('f_pago').value,
            estado: document.getElementById('f_estado').value,
            gasto_tipo: document.getElementById('f_gasto_tipo').value,
            recurrente: document.getElementById('f_recurrente').value,
            obs: document.getElementById('f_obs').value,
            mes_anio: fecha.substring(0, 7)
        };

        if(id) db.ref('movimientos/' + id).set(data).then(() => alert("Actualizado"));
        else db.ref('movimientos').push(data).then(() => alert("Guardado"));
        clearForm();
    }

    function renderList() {
        const mes = document.getElementById('filter_mes').value;
        const body = document.getElementById('list_body');
        body.innerHTML = '';
        Object.keys(rawData).forEach(key => {
            const d = rawData[key];
            if(d.mes_anio === mes) {
                body.innerHTML += `<tr>
                    <td>${d.fecha}</td>
                    <td><b>${d.concepto}</b></td>
                    <td><small>${d.cat}</small></td>
                    <td style="color:${d.tipo==='Ingreso'?'green':'red'}"><b>$${d.monto.toLocaleString()}</b></td>
                    <td><small>${d.estado}</small></td>
                    <td>
                        <button onclick="editItem('${key}')" style="border:none; cursor:pointer;">‚úèÔ∏è</button>
                        <button onclick="deleteItem('${key}')" style="border:none; cursor:pointer;">üóëÔ∏è</button>
                    </td>
                </tr>`;
            }
        });
    }

    function editItem(key) {
        const d = rawData[key];
        document.getElementById('edit-id').value = key;
        document.getElementById('f_fecha').value = d.fecha;
        document.getElementById('f_tipo').value = d.tipo;
        document.getElementById('f_monto').value = d.monto;
        document.getElementById('f_presupuesto').value = d.presupuesto;
        document.getElementById('f_concepto').value = d.concepto;
        document.getElementById('f_cat').value = d.cat;
        updateSubSelect();
        document.getElementById('f_subcat').value = d.subcat;
        document.getElementById('f_proveedor').value = d.proveedor;
        document.getElementById('f_pago').value = d.pago;
        document.getElementById('f_estado').value = d.estado;
        document.getElementById('f_obs').value = d.obs || '';
        document.getElementById('form-title').innerText = "‚úèÔ∏è Editando Operaci√≥n";
        calcDiff();
        window.scrollTo(0,0);
    }

    // AJUSTES
    function addSet(key, inputId) {
        const v = document.getElementById(inputId).value;
        if(v) { settings[key].push(v); saveSettings(); document.getElementById(inputId).value=''; }
    }

    function addSub() {
        const cat = document.getElementById('sel_cat_sub').value;
        const v = document.getElementById('new_sub').value;
        if(cat && v) {
            if(!settings.subs[cat]) settings.subs[cat] = [];
            settings.subs[cat].push(v);
            saveSettings();
            document.getElementById('new_sub').value = '';
        }
    }

    function saveSettings() {
        localStorage.setItem('fpro_v4_settings', JSON.stringify(settings));
        updateAllSelects();
        renderSettings();
    }

    function renderSettings() {
        const draw = (arr, key, target) => {
            document.getElementById(target).innerHTML = arr.map((item, i) => `
                <div style="display:flex; justify-content:space-between; background:#f8fafc; padding:8px; border-radius:6px; margin-bottom:4px;">
                    <span>${item}</span><button class="btn-danger" onclick="removeSet('${key}', ${i})">‚úï</button>
                </div>`).join('');
        };
        draw(settings.cats, 'cats', 'list_cats');
        draw(settings.proveedores, 'proveedores', 'list_provs');
        draw(settings.pagos, 'pagos', 'list_pagos');
        document.getElementById('sel_cat_sub').innerHTML = settings.cats.map(c => `<option>${c}</option>`).join('');
        
        const c = document.getElementById('sel_cat_sub').value;
        const subs = settings.subs[c] || [];
        document.getElementById('list_subs').innerHTML = subs.map((s, i) => `
            <div style="display:flex; justify-content:space-between; background:#f8fafc; padding:8px; border-radius:6px; margin-bottom:4px;">
                <span>${s}</span><button class="btn-danger" onclick="removeSub('${c}', ${i})">‚úï</button>
            </div>`).join('');
    }

    function removeSet(key, i) { settings[key].splice(i, 1); saveSettings(); }
    function removeSub(cat, i) { settings.subs[cat].splice(i, 1); saveSettings(); }

    // APOYO
    function updateAllSelects() {
        const f = (id, arr) => document.getElementById(id).innerHTML = arr.map(i => `<option>${i}</option>`).join('');
        f('f_cat', settings.cats);
        f('f_proveedor', settings.proveedores);
        f('f_pago', settings.pagos);
        updateSubSelect();
    }

    function updateSubSelect() {
        const cat = document.getElementById('f_cat').value;
        const subs = settings.subs[cat] || ['General'];
        document.getElementById('f_subcat').innerHTML = subs.map(s => `<option>${s}</option>`).join('');
    }

    function calcDiff() {
        const m = parseFloat(document.getElementById('f_monto').value) || 0;
        const p = parseFloat(document.getElementById('f_presupuesto').value) || 0;
        const d = p - m;
        const el = document.getElementById('val_diff');
        el.innerText = `$${d.toLocaleString()}`;
        el.className = d < 0 ? 'diff-neg' : 'diff-pos';
    }

    function clearForm() {
        document.getElementById('edit-id').value = '';
        document.getElementById('f_monto').value = '';
        document.getElementById('f_concepto').value = '';
        document.getElementById('f_obs').value = '';
        document.getElementById('form-title').innerText = "Nueva Operaci√≥n";
        calcDiff();
    }

    function populateMonths() {
        const sel = document.getElementById('filter_mes');
        const now = new Date();
        for(let i=0; i<12; i++) {
            const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
            const val = d.toISOString().substring(0,7);
            sel.innerHTML += `<option value="${val}">${val}</option>`;
        }
    }

    function showTab(id) {
        document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
        document.getElementById(id).style.display = 'block';
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        event.currentTarget.classList.add('active');
        if(id === 'ajustes') renderSettings();
        if(id === 'analisis') runAnalysis();
    }

    // AN√ÅLISIS
    let myChart;
    function runAnalysis() {
        const gastos = Object.values(rawData).filter(d => d.tipo === 'Egreso');
        const catMap = {};
        gastos.forEach(g => catMap[g.cat] = (catMap[g.cat] || 0) + g.monto);

        if(myChart) myChart.destroy();
        const ctx = document.getElementById('chartPie').getContext('2d');
        myChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: Object.keys(catMap),
                datasets: [{ data: Object.values(catMap), backgroundColor: ['#2563eb', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'] }]
            }
        });

        const top = gastos.sort((a,b) => b.monto - a.monto).slice(0, 5);
        document.getElementById('topList').innerHTML = top.map(t => `
            <div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #eee;">
                <span>${t.concepto}</span><b>$${t.monto.toLocaleString()}</b>
            </div>`).join('');
    }

    window.onload = init;
</script>
</body>
</html>
