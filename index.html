<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finanzas PRO | Master Edition</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        :root { --p: #0f172a; --acc: #2563eb; --bg: #f8fafc; --danger: #ef4444; --success: #10b981; }
        * { margin:0; padding:0; box-sizing:border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--bg); display: flex; min-height: 100vh; color: #1e293b; overflow-x: hidden; }

        /* SIDEBAR */
        .sidebar { width: 260px; background: var(--p); color: white; padding: 25px; position: fixed; height: 100vh; z-index: 1000; transition: 0.4s; }
        .main-content { margin-left: 260px; padding: 20px; width: calc(100% - 260px); margin-top: 75px; transition: 0.4s; }

        /* TOP BAR */
        .top-bar { 
            position: fixed; top: 0; left: 260px; right: 0; height: 75px; 
            background: white; display: flex; align-items: center; padding: 0 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); z-index: 900; gap: 20px; transition: 0.4s;
        }

        .menu-btn { display: none; background: var(--p); color: white; border: none; padding: 10px; border-radius: 8px; cursor: pointer; font-size: 1.2rem; }

        .balance-card { display: flex; gap: 15px; flex-grow: 1; justify-content: flex-end; }
        .bal-item { text-align: right; }
        .bal-item small { font-size: 10px; font-weight: 800; color: #64748b; text-transform: uppercase; }
        .bal-item p { font-size: 16px; font-weight: 900; }

        /* DIALOGO DE TIPS ESTILO CHAT PROFESIONAL */
        .tips-container {
            display: flex; align-items: flex-end; gap: 12px; margin-bottom: 25px;
            max-width: 900px; animation: fadeIn 0.5s ease;
        }
        .assistant-avatar { 
            width: 45px; height: 45px; background: var(--p); color: white; 
            border-radius: 12px; display: flex; align-items: center; justify-content: center; 
            font-size: 22px; flex-shrink: 0; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .bubble-content { 
            background: white; padding: 15px 20px; border-radius: 18px 18px 18px 4px;
            border: 1px solid #e2e8f0; box-shadow: 0 4px 12px rgba(0,0,0,0.03);
            position: relative; width: 100%;
        }
        .bubble-content small { 
            display: block; font-size: 10px; font-weight: 700; color: var(--acc); 
            text-transform: uppercase; margin-bottom: 5px; letter-spacing: 0.5px;
        }
        #tips-text { font-size: 14px; color: #334155; line-height: 1.5; font-weight: 500; transition: opacity 0.5s ease; }

        .card { background: white; border-radius: 16px; padding: 25px; box-shadow: 0 4px 6px rgba(0,0,0,0.02); margin-bottom: 25px; border: 1px solid #e2e8f0; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 15px; }
        
        label { font-size: 11px; font-weight: 800; color: #64748b; text-transform: uppercase; margin-bottom: 5px; display: block; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 10px; font-size: 14px; outline: none; }
        
        .btn-p { background: var(--acc); color: white; border: none; padding: 12px 20px; border-radius: 10px; cursor: pointer; font-weight: 700; width: 100%; transition: 0.2s; }
        .nav-link { display: flex; align-items: center; gap: 12px; padding: 14px; color: #cbd5e1; cursor: pointer; border-radius: 12px; margin-bottom: 8px; }
        .nav-link.active { background: var(--acc); color: white; }

        .table-wrap { overflow-x: auto; margin-top: 15px; border-radius: 12px; }
        table { width: 100%; border-collapse: collapse; min-width: 100%; }
        th { text-align: left; padding: 15px; background: #f8fafc; color: #64748b; font-size: 11px; border-bottom: 2px solid #edf2f7; }
        td { padding: 15px; border-bottom: 1px solid #f1f5f9; font-size: 13px; }

        .btn-action { background: none; border: 1px solid #e2e8f0; padding: 6px; border-radius: 6px; cursor: pointer; margin-right: 5px; }
        .filter-header { display: flex; gap: 10px; flex-wrap: wrap; align-items: flex-end; margin-bottom: 15px; background: #f1f5f9; padding: 15px; border-radius: 12px; }

        .config-item { display: flex; gap: 10px; margin-bottom: 10px; background: #f8fafc; padding: 10px; border-radius: 8px; align-items: center; justify-content: space-between; }
        .badge-del { background: #fee2e2; color: #ef4444; border: none; padding: 5px 10px; border-radius: 6px; cursor: pointer; font-weight: 800; }
        .search-mini { margin-bottom: 15px; border-bottom: 1px dashed #cbd5e1; padding-bottom: 10px; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        @media (max-width: 900px) {
            .sidebar { left: -100%; width: 280px; }
            .sidebar.open { left: 0; }
            .top-bar { left: 0; height: auto; padding: 15px; flex-wrap: wrap; }
            /* Ajuste para que los indicadores no tapen los tips */
            .main-content { margin-left: 0; margin-top: 140px; width: 100%; padding: 15px; }
            .menu-btn { display: block; }
            .balance-card { width: 100%; justify-content: space-between; order: 2; margin-top: 10px; }
        }
    </style>
</head>
<body>

<div class="top-bar">
    <button class="menu-btn" onclick="toggleMenu()">‚ò∞</button>
    <div class="balance-card">
        <div class="bal-item"><small>Ingresos</small><p style="color:var(--success)" id="total-ingresos">$0</p></div>
        <div class="bal-item"><small>Egresos</small><p style="color:var(--danger)" id="total-egresos">$0</p></div>
        <div class="bal-item"><small>Saldo</small><p id="total-saldo">$0</p></div>
    </div>
</div>

<nav class="sidebar" id="sidebar">
    <h1 style="margin-bottom: 30px; font-weight: 900;">Finanzas PRO</h1>
    <div class="nav-link active" onclick="showTab('registro')">üìù <span>Registro</span></div>
    <div class="nav-link" onclick="showTab('historial')">üìú <span>Historial</span></div>
    <div class="nav-link" onclick="showTab('analisis')">üìä <span>An√°lisis</span></div>
    <div class="nav-link" onclick="showTab('ajustes')">‚öôÔ∏è <span>Ajustes</span></div>
</nav>

<main class="main-content">
    <div class="tips-container">
        <div class="assistant-avatar">üíº</div>
        <div class="bubble-content">
            <small>Analista Financiero</small>
            <div id="tips-text">Hola, estoy analizando tus datos para darte el mejor consejo...</div>
        </div>
    </div>

    <div id="registro" class="tab-content">
        <div class="card">
            <h3 id="form-title">Nueva Operaci√≥n</h3><br>
            <input type="hidden" id="edit-id">
            <div class="form-grid">
                <div><label>Fecha</label><input type="date" id="f_fecha"></div>
                <div><label>Tipo</label><select id="f_tipo"></select></div>
                <div><label>Monto ($)</label><input type="number" id="f_monto" oninput="calcLogic()"></div>
                <div><label>Presupuesto ($)</label><input type="number" id="f_presupuesto" oninput="calcLogic()"></div>
            </div>
            <div class="form-grid">
                <div><label>Concepto</label><input type="text" id="f_concepto" placeholder="Ej: Pago agua"></div>
                <div><label>Categor√≠a</label><select id="f_cat"></select></div>
                <div><label>Subcategor√≠a</label><select id="f_subcat"></select></div>
                <div><label>Proveedor</label><select id="f_proveedor"></select></div>
            </div>
            <div class="form-grid">
                <div><label>Pago</label><select id="f_pago"></select></div>
                <div><label>Estado</label><select id="f_estado"></select></div>
                <div><label>Recurrente</label><select id="f_recurrente"></select></div>
                <div><label>Diferencia</label><p id="f_diff" style="font-weight:900; font-size:18px;">$0</p></div>
            </div>
            <div class="form-grid" style="margin-top:20px;">
                <button class="btn-p" onclick="saveData()">üíæ GUARDAR</button>
                <button class="btn-p" style="background:#64748b;" onclick="clearForm()">üßπ LIMPIAR</button>
            </div>
        </div>

        <div class="card">
            <h3>Movimientos Recientes & Filtros</h3><br>
            <div class="filter-header">
                <div style="flex:2;"><label>Buscador</label><input type="text" id="reg_q" placeholder="Buscar..." oninput="refreshUI()"></div>
                <div style="flex:1;"><label>D√≠a</label><input type="date" id="reg_d" onchange="refreshUI()"></div>
                <div style="flex:1;">
                    <label>Mes</label>
                    <select id="reg_m" onchange="refreshUI()">
                        <option value="">Todos los meses</option>
                        <option value="-01">Enero</option><option value="-02">Febrero</option>
                        <option value="-03">Marzo</option><option value="-04">Abril</option>
                        <option value="-05">Mayo</option><option value="-06">Junio</option>
                        <option value="-07">Julio</option><option value="-08">Agosto</option>
                        <option value="-09">Septiembre</option><option value="-10">Octubre</option>
                        <option value="-11">Noviembre</option><option value="-12">Diciembre</option>
                    </select>
                </div>
            </div>
            <div class="table-wrap">
                <table>
                    <thead><tr><th>Fecha</th><th>Concepto</th><th>Monto</th><th>Categor√≠a</th><th>Proveedor</th><th>Estado</th><th>Acciones</th></tr></thead>
                    <tbody id="list_reg_table"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="historial" class="tab-content" style="display:none;">
        <div class="card">
            <h3>Historial General</h3><br>
            <div class="filter-header">
                <div style="flex:2;"><label>Buscador</label><input type="text" id="his_q" placeholder="Buscar..." oninput="refreshUI()"></div>
                <div style="flex:1;"><label>D√≠a</label><input type="date" id="his_d" onchange="refreshUI()"></div>
                <div style="flex:1;">
                    <label>Mes</label>
                    <select id="his_m" onchange="refreshUI()">
                        <option value="">Todos los meses</option>
                        <option value="-01">Enero</option><option value="-02">Febrero</option>
                        <option value="-03">Marzo</option><option value="-04">Abril</option>
                        <option value="-05">Mayo</option><option value="-06">Junio</option>
                        <option value="-07">Julio</option><option value="-08">Agosto</option>
                        <option value="-09">Septiembre</option><option value="-10">Octubre</option>
                        <option value="-11">Noviembre</option><option value="-12">Diciembre</option>
                    </select>
                </div>
            </div>
            <div class="table-wrap">
                <table>
                    <thead><tr><th>Fecha</th><th>Concepto</th><th>Monto</th><th>Categor√≠a</th><th>Proveedor</th><th>Estado</th><th>Acciones</th></tr></thead>
                    <tbody id="list_his_table"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="analisis" class="tab-content" style="display:none;">
        <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
            <div class="card">
                <h3>Distribuci√≥n de Gastos (Egresos)</h3><br>
                <div style="height: 300px;"><canvas id="chartDona"></canvas></div>
            </div>
            <div class="card">
                <h3>Resumen Mensual y Semanal</h3><br>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                    <div style="text-align:center; padding:15px; background:#f0f9ff; border-radius:12px; border:1px solid #bae6fd;">
                        <label>Gastos Mes Actual</label>
                        <p id="ana-mes-total" style="font-size:20px; font-weight:900; color:var(--danger);">$0</p>
                    </div>
                    <div style="text-align:center; padding:15px; background:#f0fdf4; border-radius:12px; border:1px solid #bbf7d0;">
                        <label>Gastos Semanales</label>
                        <p id="ana-semana-total" style="font-size:20px; font-weight:900; color:var(--acc);">$0</p>
                    </div>
                </div>
                <div style="text-align:center; padding:10px; background:#f8fafc; border-radius:10px; margin-bottom:10px; border:1px solid #e2e8f0;">
                    <label>Categor√≠a Top del Mes</label>
                    <p id="ana-top-cat" style="font-size:18px; font-weight:900;">---</p>
                </div>
                <table style="min-width: 100%;">
                    <thead><tr><th>Top Categor√≠as (Mes)</th><th>Total</th></tr></thead>
                    <tbody id="ana-table-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="ajustes" class="tab-content" style="display:none;">
        <div class="card">
            <h2>‚öôÔ∏è Configuraci√≥n de Listas</h2>
            <div class="form-grid">
                <div>
                    <label>1. Selecciona Par√°metro</label>
                    <select id="adj_param" onchange="renderConfigList()">
                        <option value="tipos">Tipos</option>
                        <option value="cats">Categor√≠as</option>
                        <option value="subs_list">Subcategor√≠as</option>
                        <option value="provs">Proveedores</option>
                        <option value="pagos">M√©todos de Pago</option>
                        <option value="estados">Estados</option>
                        <option value="recurrentes">Recurrencia</option>
                    </select>
                </div>
                <div>
                    <label>2. Nuevo Valor</label>
                    <input type="text" id="adj_new_val" placeholder="Escribe aqu√≠...">
                </div>
                <div style="display:flex; align-items:flex-end;">
                    <button class="btn-p" onclick="addParam()">‚ûï AGREGAR</button>
                </div>
            </div>
            <div class="search-mini">
                <label>Buscar en la lista</label>
                <input type="text" id="adj_search" placeholder="Filtrar opciones..." oninput="renderConfigList()">
            </div>
            <div id="adj_list_container" style="max-height: 400px; overflow-y: auto;"></div>
        </div>
    </div>
</main>

<script>
    const firebaseConfig = {
      apiKey: "AIzaSyCO6WXu9iZsyEUmNNxrE4oWToLYY8wl-y4",
      authDomain: "misfinanzaspro-d2f3f.firebaseapp.com",
      databaseURL: "https://misfinanzaspro-d2f3f-default-rtdb.firebaseio.com",
      projectId: "misfinanzaspro-d2f3f",
      storageBucket: "misfinanzaspro-d2f3f.firebasestorage.app",
      messagingSenderId: "613366165036",
      appId: "1:613366165036:web:bebc72b38d39ab64932b89"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let rawData = {};
    let donaChart = null;
    let settings = JSON.parse(localStorage.getItem('fpro_master_settings')) || {
        tipos: ['Egreso', 'Ingreso'],
        cats: ['Servicios b√°sicos', 'Alimentaci√≥n', 'Transporte', 'Salud', 'Ocio'],
        subs_list: ['Agua potable', 'Luz', 'Gas', 'Internet', 'Supermercado'],
        provs: ['Aguas Andinas', 'Enel', 'Metrogas', 'Lider'],
        pagos: ['D√©bito', 'Cr√©dito', 'Efectivo'],
        estados: ['Pagado', 'Pendiente'],
        recurrentes: ['No', 'S√≠']
    };

    // 30 TIPS PROFESIONALES ACTUALIZADOS
    const tips = [
        "Regla 50/30/20: 50% necesidades, 30% deseos y 20% ahorro e inversi√≥n.",
        "Fondo de Emergencia: Ahorra de 3 a 6 meses de tus gastos b√°sicos obligatorios.",
        "P√°gate a ti primero: Separa tu ahorro apenas recibas tu sueldo, no al final del mes.",
        "Evita los gastos hormiga: Peque√±os gastos diarios pueden sumar una fortuna al a√±o.",
        "Inter√©s Compuesto: El tiempo es m√°s valioso que el capital. ¬°Empieza a invertir hoy!",
        "Inflaci√≥n de Estilo de Vida: No aumentes tus gastos cada vez que suba tu sueldo.",
        "Deudas Malas: Elimina primero las deudas con las tasas de inter√©s m√°s altas.",
        "Presupuesto Base Cero: Dale un prop√≥sito a cada centavo antes de que empiece el mes.",
        "Diferencia Deseo de Necesidad: Espera 48 horas antes de realizar una compra grande.",
        "Diversifica: No pongas todos tus ahorros en un solo tipo de inversi√≥n.",
        "Seguros: No son un gasto, son la protecci√≥n de tu patrimonio y tranquilidad.",
        "Revisa suscripciones: Cancela servicios que no has usado en los √∫ltimos 30 d√≠as.",
        "Compra calidad: Lo barato sale caro si tienes que reemplazarlo constantemente.",
        "Automatiza: Programa tus ahorros y pagos para evitar multas por olvido.",
        "Educaci√≥n Financiera: Tu mejor activo es tu capacidad de aprender a manejar dinero.",
        "Planifica compras: Ir al supermercado con lista reduce el gasto compulsivo.",
        "Metas SMART: Define objetivos financieros espec√≠ficos, medibles y realistas.",
        "Comparte gastos: Si es posible, usa transporte compartido o divide suscripciones.",
        "D√≠as de No Gasto: Intenta tener 2 d√≠as a la semana sin gastar absolutamente nada.",
        "Ahorra excedentes: Bonos o devoluciones de impuestos deben ir directo al ahorro.",
        "Negocia servicios: Revisa anualmente tus planes de internet, TV y telefon√≠a.",
        "Evita el pago m√≠nimo: Solo beneficia al banco; paga siempre el total de tu tarjeta.",
        "Invierte en salud: La prevenci√≥n m√©dica es mucho m√°s barata que un tratamiento.",
        "Efectivo para ocio: Usar efectivo ayuda a visualizar cu√°nto dinero te queda realmente.",
        "L√≠mite de cr√©dito: No utilices m√°s del 30% del cupo disponible en tus tarjetas.",
        "Compara precios: Usa herramientas online antes de comprar electrodom√©sticos.",
        "Mantenimiento preventivo: Cuidar tu auto o casa evita reparaciones costosas despu√©s.",
        "Registra todo: El √©xito financiero empieza con saber exactamente a d√≥nde se va el dinero.",
        "Invierte en ti: Cursos y certificaciones aumentan tu valor en el mercado laboral.",
        "Visi√≥n a largo plazo: La libertad financiera es una marat√≥n de constancia, no velocidad."
    ];

    function init() {
        document.getElementById('f_fecha').valueAsDate = new Date();
        startTipsSystem();
        loadDropdowns();
        db.ref('movimientos').on('value', snap => {
            rawData = snap.val() || {};
            refreshUI();
            updateCharts();
        });
    }

    function refreshUI() {
        let ing = 0, eg = 0;
        const rq = document.getElementById('reg_q').value.toLowerCase();
        const rd = document.getElementById('reg_d').value;
        const rm = document.getElementById('reg_m').value;
        const tableReg = document.getElementById('list_reg_table');
        const tableHis = document.getElementById('list_his_table');
        tableReg.innerHTML = ''; tableHis.innerHTML = '';

        Object.keys(rawData).reverse().forEach(key => {
            const d = rawData[key];
            if(d.tipo === 'Ingreso') ing += d.monto; else eg += d.monto;
            const searchBody = `${d.concepto} ${d.cat} ${d.proveedor}`.toLowerCase();
            
            if(searchBody.includes(rq) && (rd ? d.fecha === rd : true) && (rm ? d.fecha.includes(rm) : true)) {
                tableReg.innerHTML += renderRow(key, d);
            }
            if(searchBody.includes(document.getElementById('his_q').value.toLowerCase()) && (document.getElementById('his_m').value ? d.fecha.includes(document.getElementById('his_m').value) : true)) {
                tableHis.innerHTML += renderRow(key, d);
            }
        });
        document.getElementById('total-ingresos').innerText = `$${ing.toLocaleString()}`;
        document.getElementById('total-egresos').innerText = `$${eg.toLocaleString()}`;
        document.getElementById('total-saldo').innerText = `$${(ing - eg).toLocaleString()}`;
    }

    function renderRow(key, d) {
        return `<tr><td>${d.fecha}</td><td><b>${d.concepto}</b></td><td style="color:${d.tipo==='Ingreso'?'green':'red'}"><b>$${d.monto.toLocaleString()}</b></td><td><small>${d.cat}</small></td><td>${d.proveedor}</td><td><span style="font-size:11px; padding:3px 8px; border-radius:10px; background:${d.estado==='Pagado'?'#dcfce7':'#fee2e2'}; color:${d.estado==='Pagado'?'#166534':'#991b1b'}">${d.estado}</span></td><td><button class="btn-action" onclick="editItem('${key}')">‚úèÔ∏è</button><button class="btn-action" onclick="deleteItem('${key}')" style="color:red;">üóëÔ∏è</button></td></tr>`;
    }

    function updateCharts() {
        const ctx = document.getElementById('chartDona');
        if(!ctx) return;

        const hoy = new Date();
        const mesActual = hoy.toISOString().substring(0, 7);
        
        // Calcular inicio y fin de semana actual
        const tempDate = new Date();
        const inicioSemana = new Date(tempDate.setDate(tempDate.getDate() - tempDate.getDay() + 1)).toISOString().split('T')[0];
        const finSemana = new Date(tempDate.setDate(tempDate.getDate() - tempDate.getDay() + 7)).toISOString().split('T')[0];

        let catTotalsMes = {};
        let totalMes = 0;
        let totalSemana = 0;

        Object.values(rawData).forEach(d => {
            if(d.tipo === 'Egreso') {
                if(d.fecha >= inicioSemana && d.fecha <= finSemana) totalSemana += d.monto;
                if(d.fecha.startsWith(mesActual)) {
                    catTotalsMes[d.cat] = (catTotalsMes[d.cat] || 0) + d.monto;
                    totalMes += d.monto;
                }
            }
        });

        document.getElementById('ana-mes-total').innerText = `$${totalMes.toLocaleString()}`;
        document.getElementById('ana-semana-total').innerText = `$${totalSemana.toLocaleString()}`;
        
        const sortedCats = Object.entries(catTotalsMes).sort((a,b) => b[1] - a[1]);
        document.getElementById('ana-top-cat').innerText = sortedCats.length > 0 ? sortedCats[0][0] : "---";
        
        const tableBody = document.getElementById('ana-table-body');
        tableBody.innerHTML = sortedCats.map(c => `<tr><td>${c[0]}</td><td style="font-weight:700;">$${c[1].toLocaleString()}</td></tr>`).join('');

        if(donaChart) donaChart.destroy();
        donaChart = new Chart(ctx, { 
            type: 'doughnut', 
            data: { 
                labels: Object.keys(catTotalsMes), 
                datasets: [{ 
                    data: Object.values(catTotalsMes), 
                    backgroundColor: ['#2563eb', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4', '#ec4899'] 
                }] 
            }, 
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } } 
        });
    }

    function saveData() {
        const id = document.getElementById('edit-id').value;
        const data = {
            fecha: document.getElementById('f_fecha').value,
            tipo: document.getElementById('f_tipo').value,
            monto: parseFloat(document.getElementById('f_monto').value) || 0,
            presupuesto: parseFloat(document.getElementById('f_presupuesto').value) || 0,
            concepto: document.getElementById('f_concepto').value,
            cat: document.getElementById('f_cat').value,
            subcat: document.getElementById('f_subcat').value,
            pago: document.getElementById('f_pago').value,
            estado: document.getElementById('f_estado').value,
            proveedor: document.getElementById('f_proveedor').value,
            recurrente: document.getElementById('f_recurrente').value
        };
        if(id) db.ref('movimientos/' + id).set(data); else db.ref('movimientos').push(data);
        clearForm();
    }

    function editItem(key) {
        const d = rawData[key];
        document.getElementById('edit-id').value = key;
        document.getElementById('f_fecha').value = d.fecha;
        document.getElementById('f_monto').value = d.monto;
        document.getElementById('f_presupuesto').value = d.presupuesto;
        document.getElementById('f_concepto').value = d.concepto;
        document.getElementById('f_cat').value = d.cat;
        document.getElementById('f_subcat').value = d.subcat;
        document.getElementById('f_proveedor').value = d.proveedor;
        document.getElementById('f_tipo').value = d.tipo;
        document.getElementById('f_estado').value = d.estado;
        document.getElementById('f_pago').value = d.pago;
        document.getElementById('form-title').innerText = "‚úèÔ∏è Modificando...";
        showTab('registro');
    }

    function deleteItem(key) { if(confirm("¬øEliminar?")) db.ref('movimientos/' + key).remove(); }
    function clearForm() { 
        document.getElementById('edit-id').value = ''; 
        document.getElementById('f_monto').value = ''; 
        document.getElementById('f_concepto').value = ''; 
        document.getElementById('form-title').innerText = "Nueva Operaci√≥n"; 
    }

    function calcLogic() {
        const m = parseFloat(document.getElementById('f_monto').value) || 0;
        const p = parseFloat(document.getElementById('f_presupuesto').value) || 0;
        document.getElementById('f_diff').innerText = `$${(p - m).toLocaleString()}`;
        document.getElementById('f_diff').style.color = (p - m) < 0 ? 'red' : 'green';
    }

    function renderConfigList() {
        const param = document.getElementById('adj_param').value;
        const query = document.getElementById('adj_search').value.toLowerCase();
        const container = document.getElementById('adj_list_container');
        container.innerHTML = '';
        settings[param].forEach((item, index) => {
            if(item.toLowerCase().includes(query)) {
                container.innerHTML += `<div class="config-item"><span>${item}</span><button class="badge-del" onclick="removeParam('${param}', ${index})">‚úï</button></div>`;
            }
        });
    }

    function addParam() {
        const param = document.getElementById('adj_param').value;
        const val = document.getElementById('adj_new_val').value.trim();
        if(val) { settings[param].push(val); saveSettings(); document.getElementById('adj_new_val').value = ''; renderConfigList(); }
    }

    function removeParam(param, index) {
        if(confirm("¬øEliminar esta opci√≥n?")) { settings[param].splice(index, 1); saveSettings(); renderConfigList(); }
    }

    function saveSettings() {
        localStorage.setItem('fpro_master_settings', JSON.stringify(settings));
        loadDropdowns();
    }

    function loadDropdowns() {
        const fill = (id, arr) => {
            const el = document.getElementById(id);
            if(el) el.innerHTML = arr.map(i => `<option value="${i}">${i}</option>`).join('');
        };
        fill('f_tipo', settings.tipos);
        fill('f_cat', settings.cats);
        fill('f_subcat', settings.subs_list);
        fill('f_proveedor', settings.provs);
        fill('f_pago', settings.pagos);
        fill('f_estado', settings.estados);
        fill('f_recurrente', settings.recurrentes);
    }

    function startTipsSystem() {
        const textEl = document.getElementById('tips-text');
        let index = Math.floor(Math.random() * tips.length);
        setInterval(() => {
            textEl.style.opacity = 0;
            setTimeout(() => {
                textEl.innerText = tips[index % tips.length];
                textEl.style.opacity = 1;
                index++;
            }, 500);
        }, 12000);
    }

    function toggleMenu() { document.getElementById('sidebar').classList.toggle('open'); }
    function showTab(id) {
        document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
        document.getElementById(id).style.display = 'block';
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        const activeLink = document.querySelector(`[onclick="showTab('${id}')"]`);
        if(activeLink) activeLink.classList.add('active');
        if(id === 'ajustes') renderConfigList();
        if(id === 'analisis') updateCharts();
        if(window.innerWidth < 900) document.getElementById('sidebar').classList.remove('open');
    }

    window.onload = init;
</script>
</body>
</html>
