<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finanzas PRO | Master Edition</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        :root { 
            --p: #0f172a; --acc: #2563eb; --bg: #f8fafc; 
            --danger: #ef4444; --success: #10b981; 
            --sidebar-w: 260px;
        }
        * { margin:0; padding:0; box-sizing:border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--bg); display: flex; min-height: 100vh; color: #1e293b; overflow-x: hidden; }

        /* Sidebar */
        .sidebar { 
            width: var(--sidebar-w); background: var(--p); color: white; padding: 25px; 
            position: fixed; height: 100vh; z-index: 1000; transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1); 
        }
        .main-content { margin-left: var(--sidebar-w); padding: 20px; width: calc(100% - var(--sidebar-w)); margin-top: 85px; transition: 0.4s; }

        /* Top Bar */
        .top-bar { 
            position: fixed; top: 0; left: var(--sidebar-w); right: 0; height: 75px; 
            background: white; display: flex; align-items: center; padding: 0 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); z-index: 900; gap: 20px; transition: 0.4s;
        }
        .balance-card { display: flex; gap: 20px; flex-grow: 1; justify-content: flex-end; }
        .bal-item { text-align: right; }
        .bal-item small { font-size: 10px; font-weight: 800; color: #64748b; text-transform: uppercase; display: block; }
        .bal-item p { font-size: 16px; font-weight: 900; }

        /* Bot√≥n Men√∫: Solo visible en m√≥viles */
        .menu-toggle { display: none; background: var(--p); color: white; border: none; padding: 10px; border-radius: 8px; cursor: pointer; }

        /* DISE√ëO COACH / DI√ÅLOGO */
        .coach-box {
            background: white; border-radius: 20px; padding: 15px 25px; margin-bottom: 25px;
            display: flex; align-items: center; gap: 20px; border: 1px solid #e2e8f0;
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.04);
        }
        .coach-avatar { 
            width: 50px; height: 50px; background: linear-gradient(135deg, #2563eb, #1e40af); 
            border-radius: 15px; display: flex; align-items: center; justify-content: center; 
            font-size: 24px; flex-shrink: 0; color: white; box-shadow: 0 5px 15px rgba(37,99,235,0.3);
        }
        .coach-content { flex-grow: 1; }
        .coach-label { font-size: 10px; font-weight: 800; color: var(--acc); text-transform: uppercase; letter-spacing: 1px; }
        #tips-text { font-size: 14px; font-weight: 500; color: #334155; line-height: 1.4; transition: opacity 0.5s; }

        /* Cards & Forms */
        .card { background: white; border-radius: 16px; padding: 25px; box-shadow: 0 4px 6px rgba(0,0,0,0.02); margin-bottom: 25px; border: 1px solid #e2e8f0; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 15px; }
        label { font-size: 11px; font-weight: 800; color: #64748b; text-transform: uppercase; margin-bottom: 5px; display: block; }
        input, select { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 10px; font-size: 14px; }
        
        .btn-p { background: var(--acc); color: white; border: none; padding: 12px 20px; border-radius: 10px; cursor: pointer; font-weight: 700; transition: 0.2s; }
        .nav-link { display: flex; align-items: center; gap: 12px; padding: 14px; color: #cbd5e1; cursor: pointer; border-radius: 12px; margin-bottom: 8px; transition: 0.3s; }
        .nav-link.active { background: var(--acc); color: white; }

        .table-wrap { overflow-x: auto; margin-top: 15px; border-radius: 12px; border: 1px solid #f1f5f9; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th { text-align: left; padding: 15px; background: #f8fafc; color: #64748b; font-size: 11px; }
        td { padding: 15px; border-bottom: 1px solid #f1f5f9; font-size: 13px; }

        /* RESPONSIVE */
        @media (max-width: 900px) {
            .menu-toggle { display: block; }
            .sidebar { left: -100%; }
            .sidebar.open { left: 0; }
            .top-bar { left: 0; height: auto; padding: 15px; flex-wrap: wrap; }
            .main-content { margin-left: 0; margin-top: 130px; padding: 15px; }
            .balance-card { justify-content: space-around; width: 100%; order: 2; margin-top: 10px; }
            .coach-box { padding: 15px; gap: 12px; }
            .coach-avatar { width: 40px; height: 40px; font-size: 20px; }
            #tips-text { font-size: 13px; }
        }
    </style>
</head>
<body>

<nav class="sidebar" id="sidebar">
    <h1 style="margin-bottom: 30px; font-weight: 900;">Finanzas PRO</h1>
    <div class="nav-link active" onclick="showTab('registro')">üìù <span>Registro</span></div>
    <div class="nav-link" onclick="showTab('historial')">üìú <span>Historial</span></div>
    <div class="nav-link" onclick="showTab('analisis')">üìä <span>An√°lisis</span></div>
    <div class="nav-link" onclick="showTab('ajustes')">‚öôÔ∏è <span>Ajustes</span></div>
</nav>

<div class="top-bar">
    <button class="menu-toggle" onclick="toggleMenu()">‚ò∞</button>
    <div class="balance-card">
        <div class="bal-item"><small>Ingresos</small><p style="color:var(--success)" id="total-ingresos">$0</p></div>
        <div class="bal-item"><small>Egresos</small><p style="color:var(--danger)" id="total-egresos">$0</p></div>
        <div class="bal-item"><small>Saldo</small><p id="total-saldo" style="font-weight:900;">$0</p></div>
    </div>
</div>

<main class="main-content">
    <div class="coach-box">
        <div class="coach-avatar">ü§µ</div>
        <div class="coach-content">
            <span class="coach-label">Sabidur√≠a Financiera</span>
            <p id="tips-text">Cargando tu dosis de inteligencia financiera...</p>
        </div>
    </div>

    <div id="registro" class="tab-content">
        <div class="card">
            <h3 id="form-title">Nueva Operaci√≥n</h3><br>
            <input type="hidden" id="edit-id">
            <div class="form-grid">
                <div><label>Fecha</label><input type="date" id="f_fecha"></div>
                <div><label>Tipo</label><select id="f_tipo"><option value="Egreso">üîª Egreso</option><option value="Ingreso">üîπ Ingreso</option></select></div>
                <div><label>Monto ($)</label><input type="number" id="f_monto" oninput="calcLogic()"></div>
                <div><label>Presupuesto ($)</label><input type="number" id="f_presupuesto" oninput="calcLogic()"></div>
            </div>
            <div class="form-grid">
                <div><label>Concepto</label><input type="text" id="f_concepto" placeholder="Ej: Pago de luz"></div>
                <div><label>Categor√≠a</label><select id="f_cat" onchange="loadSubs()"></select></div>
                <div><label>Subcategor√≠a</label><select id="f_subcat"></select></div>
                <div><label>Proveedor</label><select id="f_proveedor"></select></div>
            </div>
            <div class="form-grid">
                <div><label>Pago</label><select id="f_pago"></select></div>
                <div><label>Estado</label><select id="f_estado"><option>Pagado</option><option>Pendiente</option></select></div>
                <div><label>Recurrente</label><select id="f_recurrente"><option>No</option><option>S√≠</option></select></div>
                <div><label>Diferencia</label><p id="f_diff" style="font-weight:900; font-size:18px;">$0</p></div>
            </div>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn-p" style="flex:2;" onclick="saveData()">üíæ GUARDAR</button>
                <button class="btn-p" style="background:#64748b; flex:1;" onclick="clearForm()">üßπ LIMPIAR</button>
            </div>
        </div>

        <div class="card">
            <h3>Movimientos Recientes</h3><br>
            <div class="form-grid" style="background: #f1f5f9; padding: 15px; border-radius: 12px;">
                <div style="grid-column: span 2;"><label>Buscador</label><input type="text" id="reg_q" placeholder="Concepto, categor√≠a..." oninput="refreshUI()"></div>
                <div><label>Mes</label>
                    <select id="reg_m" onchange="refreshUI()">
                        <option value="">Todo el a√±o</option>
                        <option value="-01">Enero</option><option value="-02">Febrero</option><option value="-03">Marzo</option>
                        <option value="-04">Abril</option><option value="-05">Mayo</option><option value="-06">Junio</option>
                        <option value="-07">Julio</option><option value="-08">Agosto</option><option value="-09">Septiembre</option>
                        <option value="-10">Octubre</option><option value="-11">Noviembre</option><option value="-12">Diciembre</option>
                    </select>
                </div>
            </div>
            <div class="table-wrap">
                <table>
                    <thead><tr><th>Fecha</th><th>Concepto</th><th>Monto</th><th>Categor√≠a</th><th>Estado</th><th>Acciones</th></tr></thead>
                    <tbody id="list_reg_table"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="historial" class="tab-content" style="display:none;">
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3>Historial General</h3>
                <div style="display:flex; gap:5px;">
                    <button class="btn-p" style="background:#10b981; padding:8px 12px;" onclick="exportExcel()">üìä Excel</button>
                    <button class="btn-p" style="background:#ef4444; padding:8px 12px;" onclick="exportPDF()">üìÑ PDF</button>
                </div>
            </div><br>
            <div class="table-wrap"><table><thead><tr><th>Fecha</th><th>Concepto</th><th>Monto</th><th>Categor√≠a</th><th>Acciones</th></tr></thead><tbody id="list_his_table"></tbody></table></div>
        </div>
    </div>

    <div id="analisis" class="tab-content" style="display:none;">
        <div class="form-grid">
            <div class="card"><h3>Distribuci√≥n</h3><div style="height:300px;"><canvas id="chartDona"></canvas></div></div>
            <div class="card"><h3>Top Gastos</h3><table style="width:100%"><tbody id="ana-table-body"></tbody></table></div>
        </div>
    </div>

    <div id="ajustes" class="tab-content" style="display:none;">
        <div class="card"><h3>Configuraci√≥n del Sistema</h3><p>Use WPCode para a√±adir par√°metros adicionales.</p></div>
    </div>
</main>

<script>
    // FIREBASE
    const firebaseConfig = {
      apiKey: "AIzaSyCO6WXu9iZsyEUmNNxrE4oWToLYY8wl-y4",
      authDomain: "misfinanzaspro-d2f3f.firebaseapp.com",
      databaseURL: "https://misfinanzaspro-d2f3f-default-rtdb.firebaseio.com",
      projectId: "misfinanzaspro-d2f3f",
      storageBucket: "misfinanzaspro-d2f3f.firebasestorage.app",
      messagingSenderId: "613366165036",
      appId: "1:613366165036:web:bebc72b38d39ab64932b89"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // 70 FRASES DE SABIDUR√çA
    const tips = [
        "Ahorra primero, gasta despu√©s.", "El inter√©s compuesto es la octava maravilla del mundo.",
        "Un peque√±o agujero hunde un gran barco. Cuida los gastos hormiga.", "No pongas todos los huevos en la misma canasta.",
        "El mejor momento para invertir fue ayer, el segundo mejor es hoy.", "Si compras cosas que no necesitas, pronto vender√°s lo que necesitas.",
        "El dinero es un buen siervo pero un mal amo.", "La riqueza no consiste en tener grandes posesiones, sino en tener pocas necesidades.",
        "Invertir en conocimientos produce siempre los mejores beneficios.", "Gasta lo que te queda despu√©s de ahorrar.",
        "Tu nivel de gastos no debe crecer al ritmo de tus ingresos.", "P√°gate a ti mismo primero: reserva el 10% m√≠nimo.",
        "El cr√©dito es un sistema de esclavitud si no se usa para activos.", "Tener un fondo de emergencia te da libertad.",
        "Las ofertas no son ahorro si no ten√≠as planeado comprar.", "La inflaci√≥n es el impuesto silencioso, invierte para superarla.",
        "Revisa tus suscripciones: el dinero se fuga en los goteos mensuales.", "Compra calidad, lo barato sale caro a largo plazo.",
        "La mejor inversi√≥n es tu propia salud y educaci√≥n.", "Ahorrar sin prop√≥sito es dif√≠cil. Define una meta.",
        "Anota cada gasto por 30 d√≠as, te sorprender√° el resultado.", "Evita las deudas de consumo como la peste.",
        "Las tarjetas de cr√©dito son herramientas, no dinero extra.", "Si no puedes pagarlo dos veces, no puedes permit√≠rtelo.",
        "El delivery es el mayor enemigo del presupuesto mensual.", "Invierte en activos que pongan dinero en tu bolsillo.",
        "El lujo es para cuando ya eres rico, no para parecerlo.", "Aprende a decir NO a compromisos que no puedes costear.",
        "Ahorra para el retiro desde hoy, el tiempo es tu aliado.", "Diversifica: diferentes monedas, diferentes mercados.",
        "No sigas consejos de personas que no est√°n donde t√∫ quieres estar.", "La paciencia es la clave de las inversiones exitosas.",
        "Crea m√∫ltiples fuentes de ingresos.", "Usa la regla de las 24 horas antes de compras impulsivas.",
        "La libertad financiera no es trabajar menos, es elegir en qu√©.", "Un presupuesto te dice a d√≥nde ir, no te pregunta a d√≥nde fue.",
        "Automatiza tus ahorros, as√≠ no tienes que pensarlo.", "Vivir por debajo de tus posibilidades es la verdadera riqueza.",
        "Compara precios siempre, internet es tu herramienta.", "No ignores las facturas, los intereses de mora son basura.",
        "Usa efectivo si pierdes el control con la tarjeta.", "Mant√©n tu coche un par de a√±os m√°s de lo planeado.",
        "Educa a tus hijos sobre finanzas, es el mejor legado.", "La envidia financiera es el camino r√°pido a la quiebra.",
        "Aprende a cocinar: es una habilidad muy rentable.", "Revisa tus seguros anualmente buscando mejores primas.",
        "Vende lo que no usas, limpia tu casa y llena tu cartera.", "El tiempo vale m√°s que el dinero, g√°stalo con sabidur√≠a.",
        "No te compares con el vecino, sus deudas pueden ser mayores.", "La disciplina financiera es libertad.",
        "Entiende qu√© compras antes de invertir un solo d√≥lar.", "Las crisis son oportunidades para los que tienen efectivo.",
        "Ahorrar es un h√°bito, no una cantidad.", "Aprende la diferencia entre precio y valor.",
        "Nunca inviertas dinero que necesites para vivir el mes.", "Mide tu riqueza por cu√°ntos d√≠as podr√≠as vivir sin trabajar.",
        "La simplicidad es la m√°xima sofisticaci√≥n financiera.", "Protege tu capacidad de generar ingresos.",
        "Haz un inventario de lo que tienes antes de ir de compras.", "La gratificaci√≥n instant√°nea es el enemigo del √©xito.",
        "S√© generoso cuando puedas, el dinero fluye al compartirlo.", "El optimismo es una estrategia de inversi√≥n.",
        "No asumas riesgos que no puedas explicar a un ni√±o.", "Mant√©n tus gastos fijos lo m√°s bajos posible.",
        "El √©xito financiero es 20% conocimiento y 80% comportamiento.", "Tu casa es un activo solo si te genera ingresos.",
        "No dejes que tus emociones manejen tu billetera.", "La mejor deuda es la que no existe.",
        "Ahorrar es comprar tu libertad futura.", "Finanzas PRO es tu mejor aliado, √∫salo a diario."
    ];

    let rawData = {};
    let donaChart = null;
    let settings = JSON.parse(localStorage.getItem('fpro_v6_settings')) || {
        cats: ['Servicios b√°sicos', 'Alimentaci√≥n', 'Transporte', 'Salud', 'Ocio'],
        subs: {'Servicios b√°sicos': ['Agua', 'Luz', 'Internet']},
        provs: ['General'],
        pagos: ['D√©bito', 'Cr√©dito', 'Efectivo']
    };

    function init() {
        document.getElementById('f_fecha').valueAsDate = new Date();
        loadDropdowns();
        startCoach();
        db.ref('movimientos').on('value', snap => {
            rawData = snap.val() || {};
            refreshUI();
            updateCharts();
        });
    }

    function startCoach() {
        const textEl = document.getElementById('tips-text');
        let i = 0;
        setInterval(() => {
            textEl.style.opacity = 0;
            setTimeout(() => {
                textEl.innerText = tips[i];
                textEl.style.opacity = 1;
                i = (i + 1) % tips.length;
            }, 500);
        }, 8000);
        textEl.innerText = tips[0];
    }

    function refreshUI() {
        let ing = 0, eg = 0;
        const rq = document.getElementById('reg_q').value.toLowerCase();
        const rm = document.getElementById('reg_m').value;
        const tableReg = document.getElementById('list_reg_table');
        const tableHis = document.getElementById('list_his_table');
        
        tableReg.innerHTML = ''; tableHis.innerHTML = '';
        Object.keys(rawData).reverse().forEach(key => {
            const d = rawData[key];
            if(d.tipo === 'Ingreso') ing += d.monto; else eg += d.monto;
            
            const match = d.concepto.toLowerCase().includes(rq) && (rm ? d.fecha.includes(rm) : true);
            if(match) {
                const row = `<tr><td>${d.fecha}</td><td>${d.concepto}</td><td style="color:${d.tipo==='Ingreso'?'green':'red'}">$${d.monto.toLocaleString()}</td><td>${d.cat}</td><td>${d.estado}</td><td><button onclick="editItem('${key}')">‚úèÔ∏è</button><button onclick="deleteItem('${key}')">üóëÔ∏è</button></td></tr>`;
                tableReg.innerHTML += row;
                tableHis.innerHTML += row;
            }
        });
        document.getElementById('total-ingresos').innerText = `$${ing.toLocaleString()}`;
        document.getElementById('total-egresos').innerText = `$${eg.toLocaleString()}`;
        document.getElementById('total-saldo').innerText = `$${(ing - eg).toLocaleString()}`;
    }

    // Funciones de L√≥gica (Tal cual estaban)
    function saveData() {
        const id = document.getElementById('edit-id').value;
        const data = {
            fecha: document.getElementById('f_fecha').value,
            tipo: document.getElementById('f_tipo').value,
            monto: parseFloat(document.getElementById('f_monto').value) || 0,
            presupuesto: parseFloat(document.getElementById('f_presupuesto').value) || 0,
            concepto: document.getElementById('f_concepto').value,
            cat: document.getElementById('f_cat').value,
            subcat: document.getElementById('f_subcat').value,
            pago: document.getElementById('f_pago').value,
            estado: document.getElementById('f_estado').value,
            proveedor: document.getElementById('f_proveedor').value,
            recurrente: document.getElementById('f_recurrente').value
        };
        if(id) db.ref('movimientos/' + id).set(data); else db.ref('movimientos').push(data);
        clearForm();
    }

    function editItem(key) {
        const d = rawData[key];
        document.getElementById('edit-id').value = key;
        document.getElementById('f_fecha').value = d.fecha;
        document.getElementById('f_monto').value = d.monto;
        document.getElementById('f_concepto').value = d.concepto;
        document.getElementById('f_cat').value = d.cat;
        loadSubs();
        showTab('registro');
    }

    function deleteItem(key) { if(confirm("¬øEliminar?")) db.ref('movimientos/' + key).remove(); }
    function clearForm() { document.getElementById('edit-id').value = ''; document.getElementById('f_monto').value = ''; document.getElementById('f_concepto').value = ''; }
    function calcLogic() {
        const m = parseFloat(document.getElementById('f_monto').value) || 0;
        const p = parseFloat(document.getElementById('f_presupuesto').value) || 0;
        document.getElementById('f_diff').innerText = `$${(p - m).toLocaleString()}`;
        document.getElementById('f_diff').style.color = (p - m) < 0 ? 'red' : 'green';
    }

    function loadDropdowns() {
        const fill = (id, arr) => document.getElementById(id).innerHTML = arr.map(i => `<option>${i}</option>`).join('');
        fill('f_cat', settings.cats); fill('f_proveedor', settings.provs); fill('f_pago', settings.pagos);
        loadSubs();
    }

    function loadSubs() {
        const c = document.getElementById('f_cat').value;
        const s = settings.subs[c] || ['General'];
        document.getElementById('f_subcat').innerHTML = s.map(v => `<option>${v}</option>`).join('');
    }

    function toggleMenu() { document.getElementById('sidebar').classList.toggle('open'); }
    function showTab(id) {
        document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
        document.getElementById(id).style.display = 'block';
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        if(window.innerWidth < 900) document.getElementById('sidebar').classList.remove('open');
        if(id === 'analisis') updateCharts();
    }

    function updateCharts() {
        const ctx = document.getElementById('chartDona');
        if(!ctx) return;
        let catTotals = {};
        Object.values(rawData).forEach(d => { if(d.tipo === 'Egreso') catTotals[d.cat] = (catTotals[d.cat] || 0) + d.monto; });
        if(donaChart) donaChart.destroy();
        donaChart = new Chart(ctx, { type: 'doughnut', data: { labels: Object.keys(catTotals), datasets: [{ data: Object.values(catTotals), backgroundColor: ['#2563eb', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'] }] }, options: { maintainAspectRatio: false } });
    }

    window.onload = init;
</script>
</body>
</html>
