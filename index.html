<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finanzas PRO | M√°s Control. Menos preocupaci√≥n</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        :root { --p: #0f172a; --acc: #2563eb; --bg: #f8fafc; --danger: #ef4444; --success: #10b981; }
        * { margin:0; padding:0; box-sizing:border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--bg); display: flex; min-height: 100vh; color: #1e293b; overflow-x: hidden; }

        #auth-screen { position: fixed; inset: 0; background: var(--p); z-index: 2000; display: flex; align-items: center; justify-content: center; color: white; }
        .auth-card { background: white; padding: 40px; border-radius: 20px; width: 100%; max-width: 400px; color: #1e293b; box-shadow: 0 10px 25px rgba(0,0,0,0.2); text-align: center; }
        .auth-card h2 { margin-bottom: 5px; color: var(--p); font-weight: 800; }
        .auth-card p { font-size: 13px; color: #64748b; margin-bottom: 25px; }
        .auth-tabs { display: flex; gap: 10px; margin-bottom: 20px; background: #f1f5f9; padding: 5px; border-radius: 10px; }
        .auth-tab { flex: 1; padding: 10px; border: none; background: none; cursor: pointer; border-radius: 8px; font-weight: 700; color: #64748b; font-size: 13px; }
        .auth-tab.active { background: white; color: var(--acc); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        .sidebar { width: 260px; background: var(--p); color: white; padding: 25px; position: fixed; height: 100vh; z-index: 1000; transition: 0.4s; }
        .main-content { margin-left: 260px; padding: 20px; width: calc(100% - 260px); margin-top: 75px; transition: 0.4s; }

        .logo-container { display: flex; align-items: center; gap: 12px; margin-bottom: 5px; }
        .logo-icon { width: 40px; height: 40px; background: var(--acc); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .slogan { font-size: 11px; color: #94a3b8; font-weight: 500; margin-bottom: 30px; display: block; }

        .top-bar { 
            position: fixed; top: 0; left: 260px; right: 0; height: 75px; 
            background: white; display: flex; align-items: center; padding: 0 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); z-index: 900; gap: 20px; transition: 0.4s;
        }

        .menu-btn { display: none; background: var(--p); color: white; border: none; padding: 10px; border-radius: 8px; cursor: pointer; font-size: 1.2rem; }
        .balance-card { display: flex; gap: 15px; flex-grow: 1; justify-content: flex-end; }
        .bal-item { text-align: right; }
        .bal-item small { font-size: 10px; font-weight: 800; color: #64748b; text-transform: uppercase; }
        .bal-item p { font-size: 16px; font-weight: 900; }

        .goal-progress { background: #e2e8f0; height: 10px; border-radius: 5px; margin: 10px 0; overflow: hidden; }
        .goal-bar { background: var(--success); height: 100%; transition: 0.5s; }
        .btn-goal-add { background: var(--success); color: white; border: none; padding: 8px; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 10px; }
        .btn-goal-edit { background: #f1f5f9; color: #475569; border: 1px solid #cbd5e1; padding: 5px; border-radius: 5px; cursor: pointer; font-size: 12px; }

        .tips-container { display: flex; align-items: flex-end; gap: 12px; margin-bottom: 25px; max-width: 900px; animation: fadeIn 0.5s ease; }
        .assistant-avatar { width: 45px; height: 45px; background: var(--p); color: white; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 22px; flex-shrink: 0; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .bubble-content { background: white; padding: 15px 20px; border-radius: 18px 18px 18px 4px; border: 1px solid #e2e8f0; box-shadow: 0 4px 12px rgba(0,0,0,0.03); position: relative; width: 100%; }
        .bubble-content small { display: block; font-size: 10px; font-weight: 700; color: var(--acc); text-transform: uppercase; margin-bottom: 5px; letter-spacing: 0.5px; }
        #tips-text { font-size: 14px; color: #334155; line-height: 1.5; font-weight: 500; transition: opacity 0.5s ease; }

        .card { background: white; border-radius: 16px; padding: 25px; box-shadow: 0 4px 6px rgba(0,0,0,0.02); margin-bottom: 25px; border: 1px solid #e2e8f0; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 15px; }
        label { font-size: 11px; font-weight: 800; color: #64748b; text-transform: uppercase; margin-bottom: 5px; display: block; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 10px; font-size: 14px; outline: none; }
        .btn-p { background: var(--acc); color: white; border: none; padding: 12px 20px; border-radius: 10px; cursor: pointer; font-weight: 700; width: 100%; transition: 0.2s; }
        .nav-link { display: flex; align-items: center; gap: 12px; padding: 14px; color: #cbd5e1; cursor: pointer; border-radius: 12px; margin-bottom: 8px; }
        .nav-link.active { background: var(--acc); color: white; }
        .table-wrap { overflow-x: auto; margin-top: 15px; border-radius: 12px; }
        table { width: 100%; border-collapse: collapse; min-width: 100%; }
        th { text-align: left; padding: 15px; background: #f8fafc; color: #64748b; font-size: 11px; border-bottom: 2px solid #edf2f7; }
        td { padding: 15px; border-bottom: 1px solid #f1f5f9; font-size: 13px; }
        .btn-action { background: none; border: 1px solid #e2e8f0; padding: 6px; border-radius: 6px; cursor: pointer; margin-right: 5px; }
        .filter-header { display: flex; gap: 10px; flex-wrap: wrap; align-items: flex-end; margin-bottom: 15px; background: #f1f5f9; padding: 15px; border-radius: 12px; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        @media (max-width: 900px) {
            .sidebar { left: -100%; width: 280px; }
            .sidebar.open { left: 0; }
            .top-bar { left: 0; height: auto; padding: 15px; flex-wrap: wrap; }
            .main-content { margin-left: 0; margin-top: 140px; width: 100%; padding: 15px; }
            .menu-btn { display: block; }
            .balance-card { width: 100%; justify-content: space-between; order: 2; margin-top: 10px; }
        }
    </style>
</head>
<body>

<div id="auth-screen">
    <div class="auth-card">
        <div class="logo-icon" style="margin: 0 auto 15px auto;">üìà</div>
        <h2>Finanzas PRO</h2>
        <p>"M√°s Control. Menos preocupaci√≥n"</p>
        
        <div class="auth-tabs">
            <button class="auth-tab active" id="tab-login" onclick="setAuthMode('login')">Ingresar</button>
            <button class="auth-tab" id="tab-register" onclick="setAuthMode('register')">Crear Cuenta</button>
        </div>

        <div id="auth-form">
            <label>Email</label>
            <input type="email" id="auth-email" placeholder="tu@email.com" style="margin-bottom:15px;">
            <label id="label-pass">Contrase√±a</label>
            <input type="password" id="auth-pass" placeholder="******" style="margin-bottom:20px;">
            
            <button class="btn-p" id="auth-btn" onclick="handleAuth()">INGRESAR</button>
            
            <div style="text-align: center; margin-top: 15px;">
                <button onclick="recoverPassword()" style="background:none; border:none; color:var(--acc); font-size:12px; cursor:pointer; font-weight:bold;">¬øOlvidaste tu contrase√±a?</button>
            </div>
            
            <p id="auth-error" style="color:red; font-size:12px; margin-top:15px; text-align:center; min-height: 15px;"></p>
        </div>
    </div>
</div>

<div class="top-bar">
    <button class="menu-btn" onclick="toggleMenu()">‚ò∞</button>
    <div class="balance-card">
        <div class="bal-item"><small>Ingresos</small><p style="color:var(--success)" id="total-ingresos">$0</p></div>
        <div class="bal-item"><small>Egresos</small><p style="color:var(--danger)" id="total-egresos">$0</p></div>
        <div class="bal-item"><small>Saldo</small><p id="total-saldo">$0</p></div>
    </div>
</div>

<nav class="sidebar" id="sidebar">
    <div class="logo-container">
        <div class="logo-icon">üìä</div>
        <h1 style="font-weight: 900; font-size: 20px;">Finanzas PRO</h1>
    </div>
    <span class="slogan">M√°s Control. Menos preocupaci√≥n</span>

    <div class="nav-link active" onclick="showTab('registro')">üìù <span>Registro</span></div>
    <div class="nav-link" onclick="showTab('historial')">üìú <span>Historial</span></div>
    <div class="nav-link" onclick="showTab('analisis')">üìä <span>An√°lisis</span></div>
    <div class="nav-link" onclick="showTab('metas')">üéØ <span>Metas</span></div>
    <div class="nav-link" onclick="showTab('ajustes')">‚öôÔ∏è <span>Ajustes</span></div>
    
    <div style="position:absolute; bottom:20px; width:calc(100% - 50px);">
        <button onclick="logout()" style="background:none; border:none; color:#94a3b8; cursor:pointer; font-size:12px; font-weight:bold;">üö™ CERRAR SESI√ìN</button>
    </div>
</nav>

<main class="main-content">
    <div class="tips-container">
        <div class="assistant-avatar">üíº</div>
        <div class="bubble-content">
            <small>Asistente de Finanzas PRO</small>
            <div id="tips-text">Analizando tus movimientos para optimizar tu presupuesto...</div>
        </div>
    </div>

    <div id="registro" class="tab-content">
        <div class="card">
            <h3 id="form-title">Nueva Operaci√≥n</h3><br>
            <input type="hidden" id="edit-id">
            <div class="form-grid">
                <div><label>Fecha</label><input type="date" id="f_fecha"></div>
                <div><label>Tipo</label><select id="f_tipo"></select></div>
                <div><label>Monto ($)</label><input type="text" id="f_monto" oninput="formatInput(this); calcLogic()"></div>
                <div><label>Presupuesto ($)</label><input type="text" id="f_presupuesto" oninput="formatInput(this); calcLogic()"></div>
            </div>
            <div class="form-grid">
                <div><label>Concepto</label><input type="text" id="f_concepto" placeholder="Ej: Pago agua"></div>
                <div><label>Categor√≠a</label><select id="f_cat"></select></div>
                <div><label>Subcategor√≠a</label><select id="f_subcat"></select></div>
                <div><label>Proveedor</label><select id="f_proveedor"></select></div>
            </div>
            <div class="form-grid">
                <div><label>Pago</label><select id="f_pago"></select></div>
                <div><label>Estado</label><select id="f_estado"></select></div>
                <div><label>Recurrente</label><select id="f_recurrente"></select></div>
                <div><label>Diferencia</label><p id="f_diff" style="font-weight:900; font-size:18px;">$0</p></div>
            </div>
            <div class="form-grid" style="margin-top:20px;">
                <button class="btn-p" onclick="saveData()">üíæ GUARDAR</button>
                <button class="btn-p" style="background:#64748b;" onclick="clearForm()">üßπ LIMPIAR</button>
            </div>
        </div>

        <div class="card">
            <h3>Movimientos Recientes</h3><br>
            <div class="filter-header">
                <div style="flex:2;"><label>Buscador</label><input type="text" id="reg_q" placeholder="Buscar..." oninput="refreshUI()"></div>
                <div style="flex:1;"><label>D√≠a</label><input type="date" id="reg_d" onchange="refreshUI()"></div>
                <div style="flex:1;"><label>Mes</label><select id="reg_m" onchange="refreshUI()"><option value="">Todos</option><option value="-01-">Enero</option><option value="-02-">Febrero</option><option value="-03-">Marzo</option><option value="-04-">Abril</option><option value="-05-">Mayo</option><option value="-06-">Junio</option><option value="-07-">Julio</option><option value="-08-">Agosto</option><option value="-09-">Septiembre</option><option value="-10-">Octubre</option><option value="-11-">Noviembre</option><option value="-12-">Diciembre</option></select></div>
            </div>
            <div class="table-wrap">
                <table>
                    <thead><tr><th>Fecha</th><th>Concepto</th><th>Monto</th><th>Categor√≠a</th><th>Proveedor</th><th>Estado</th><th>Acciones</th></tr></thead>
                    <tbody id="list_reg_table"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="historial" class="tab-content" style="display:none;">
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap: wrap; gap: 10px;">
                <h3>Historial General</h3>
                <div style="display: flex; gap: 10px;">
                    <button class="btn-p" style="width:auto; padding:8px 15px; font-size:12px; background:#10b981;" onclick="exportExcel()">üü¢ EXCEL</button>
                    <button class="btn-p" style="width:auto; padding:8px 15px; font-size:12px; background:#1e293b;" onclick="exportPDF()">üìÑ PDF DETALLADO</button>
                </div>
            </div><br>
            <div class="filter-header">
                <div style="flex:2;"><label>Buscador</label><input type="text" id="his_q" placeholder="Buscar..." oninput="refreshUI()"></div>
                <div style="flex:1;"><label>D√≠a Exacto</label><input type="date" id="his_d" onchange="refreshUI()"></div>
                <div style="flex:1;"><label>Mes</label><select id="his_m" onchange="refreshUI()"><option value="">Todos</option><option value="-01-">Enero</option><option value="-02-">Febrero</option><option value="-03-">Marzo</option><option value="-04-">Abril</option><option value="-05-">Mayo</option><option value="-06-">Junio</option><option value="-07-">Julio</option><option value="-08-">Agosto</option><option value="-09-">Septiembre</option><option value="-10-">Octubre</option><option value="-11-">Noviembre</option><option value="-12-">Diciembre</option></select></div>
            </div>
            <div class="table-wrap">
                <table id="table-to-export">
                    <thead><tr><th>Fecha</th><th>Concepto</th><th>Monto</th><th>Categor√≠a</th><th>Proveedor</th><th>Estado</th><th>Acciones</th></tr></thead>
                    <tbody id="list_his_table"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="metas" class="tab-content" style="display:none;">
        <div class="card">
            <h3 id="meta-form-title">üéØ Mis Metas de Ahorro</h3><br>
            <input type="hidden" id="m_edit_id">
            <div class="form-grid">
                <div><label>Nombre Meta</label><input type="text" id="m_nombre" placeholder="Ej: Fondo Viaje"></div>
                <div><label>Monto Objetivo ($)</label><input type="text" id="m_objetivo" oninput="formatInput(this)"></div>
                <div><label>Monto Actual ($)</label><input type="text" id="m_actual" oninput="formatInput(this)"></div>
                <div style="display:flex; align-items:flex-end; gap:5px;">
                    <button class="btn-p" onclick="saveMeta()" id="btn-save-meta">‚ûï CREAR META</button>
                    <button class="btn-p" style="background:#64748b; display:none;" id="btn-cancel-meta" onclick="cancelEditMeta()">‚úï</button>
                </div>
            </div>
            <div id="metas-container" style="margin-top:30px; display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:20px;"></div>
        </div>
    </div>

    <div id="analisis" class="tab-content" style="display:none;">
        <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
            <div class="card">
                <h3>Distribuci√≥n de Gastos</h3><br>
                <div style="height: 300px; position: relative;"><canvas id="chartDona"></canvas></div>
            </div>
            <div class="card">
                <h3>Resumen de Impacto</h3><br>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                    <div style="text-align:center; padding:15px; background:#f0f9ff; border-radius:12px; border:1px solid #bae6fd;">
                        <label>Gastos Mes</label><p id="ana-mes-total" style="font-size:20px; font-weight:900; color:var(--danger);">$0</p>
                    </div>
                    <div style="text-align:center; padding:15px; background:#f0fdf4; border-radius:12px; border:1px solid #bbf7d0;">
                        <label>Ingresos Mes</label><p id="ana-semana-total" style="font-size:20px; font-weight:900; color:var(--success);">$0</p>
                    </div>
                </div>
                <div id="ana-top-cat-box" style="text-align:center; padding:10px; background:#f8fafc; border-radius:10px; border:1px solid #e2e8f0;">
                    <label>Mayor Categor√≠a</label><p id="ana-top-cat" style="font-size:18px; font-weight:900;">---</p>
                </div>
            </div>
        </div>
    </div>

    <div id="ajustes" class="tab-content" style="display:none;">
        <div class="card">
            <h2>‚öôÔ∏è Configuraci√≥n</h2>
            <div class="form-grid">
                <div><label>Par√°metro</label><select id="adj_param" onchange="renderConfigList()"><option value="tipos">Tipos</option><option value="cats">Categor√≠as</option><option value="subs_list">Subcategor√≠as</option><option value="provs">Proveedores</option><option value="pagos">M√©todos de Pago</option><option value="estados">Estados</option><option value="recurrentes">Recurrencia</option></select></div>
                <div><label>Nuevo Valor</label><input type="text" id="adj_new_val"></div>
                <div style="display:flex; align-items:flex-end;"><button class="btn-p" onclick="addParam()">‚ûï AGREGAR</button></div>
            </div>
            <div id="adj_list_container" style="max-height: 400px; overflow-y: auto;"></div>
        </div>
    </div>
</main>

<script>
    // Configuraci√≥n Firebase (Se mantiene igual)
    const firebaseConfig = {
      apiKey: "AIzaSyCO6WXu9iZsyEUmNNxrE4oWToLYY8wl-y4",
      authDomain: "misfinanzaspro-d2f3f.firebaseapp.com",
      projectId: "misfinanzaspro-d2f3f",
      storageBucket: "misfinanzaspro-d2f3f.firebasestorage.app",
      messagingSenderId: "613366165036",
      appId: "1:613366165036:web:bebc72b38d39ab64932b89"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    let currentUser = null;
    let rawData = {};
    let metasData = {};
    let donaChart = null;
    let currentAuthMode = 'login';
    let settings = {
        tipos: ['Egreso', 'Ingreso'],
        cats: ['Servicios b√°sicos', 'Alimentaci√≥n', 'Transporte', 'Salud', 'Ocio', 'Ahorro'],
        subs_list: ['Agua potable', 'Luz', 'Gas', 'Internet', 'Supermercado'],
        provs: ['Aguas Andinas', 'Enel', 'Metrogas', 'Lider'],
        pagos: ['D√©bito', 'Cr√©dito', 'Efectivo'],
        estados: ['Pagado', 'Pendiente'],
        recurrentes: ['No', 'S√≠']
    };

    const tips = [
        "Regla 50/30/20: 50% necesidades, 30% deseos y 20% ahorro.",
        "Fondo de Emergencia: Ahorra de 3 a 6 meses de tus gastos b√°sicos.",
        "P√°gate a ti primero: Separa tu ahorro apenas recibas tu sueldo.",
        "Revisa tus suscripciones: A veces pagamos por lo que no usamos.",
        "Compara precios: Un ahorro peque√±o hoy es una fortuna ma√±ana.",
        "Evita compras por impulso: Espera 24 horas antes de comprar algo caro."
    ];

    // Funciones de utilidad y formato
    function formatInput(input) {
        let value = input.value.replace(/\D/g, "");
        if (value === "") { input.value = ""; return; }
        input.value = parseInt(value).toLocaleString('es-CL').replace(/,/g, ".");
    }

    function parseFormatted(val) {
        if (!val) return 0;
        return parseFloat(val.toString().replace(/\./g, "")) || 0;
    }

    // AUTH LOGIC
    function setAuthMode(mode) {
        currentAuthMode = mode;
        document.getElementById('tab-login').classList.toggle('active', mode === 'login');
        document.getElementById('tab-register').classList.toggle('active', mode === 'register');
        document.getElementById('auth-btn').innerText = mode === 'login' ? 'INGRESAR' : 'CREAR CUENTA';
    }

    async function handleAuth() {
        const email = document.getElementById('auth-email').value;
        const pass = document.getElementById('auth-pass').value;
        const errorEl = document.getElementById('auth-error');
        errorEl.innerText = "";
        if(!email || !pass) { errorEl.innerText = "Completa todos los campos"; return; }
        try {
            if(currentAuthMode === 'login') await auth.signInWithEmailAndPassword(email, pass);
            else await auth.createUserWithEmailAndPassword(email, pass);
        } catch (err) { errorEl.innerText = err.message; }
    }

    auth.onAuthStateChanged(user => {
        if (user) {
            currentUser = user;
            document.getElementById('auth-screen').style.display = 'none';
            initData();
        } else {
            document.getElementById('auth-screen').style.display = 'flex';
        }
    });

    function logout() { auth.signOut(); location.reload(); }

    function initData() {
        document.getElementById('f_fecha').valueAsDate = new Date();
        startTipsSystem();
        loadDropdowns();

        db.collection('users').doc(currentUser.uid).collection('config').doc('listas').onSnapshot(doc => {
            if(doc.exists) { settings = doc.data(); loadDropdowns(); }
            else { db.collection('users').doc(currentUser.uid).collection('config').doc('listas').set(settings); }
        });

        db.collection('users').doc(currentUser.uid).collection('movimientos').orderBy('fecha', 'desc').onSnapshot(snap => {
            rawData = {}; snap.forEach(doc => rawData[doc.id] = doc.data());
            refreshUI(); updateCharts();
        });

        db.collection('users').doc(currentUser.uid).collection('metas').onSnapshot(snap => {
            metasData = {}; snap.forEach(doc => metasData[doc.id] = doc.data());
            renderMetas();
        });
    }

    function startTipsSystem() {
        setInterval(() => {
            const text = document.getElementById('tips-text');
            if(text) {
                text.style.opacity = 0;
                setTimeout(() => {
                    text.innerText = tips[Math.floor(Math.random()*tips.length)];
                    text.style.opacity = 1;
                }, 500);
            }
        }, 8000);
    }

    function refreshUI() {
        let ing = 0, eg = 0;
        const rq = document.getElementById('reg_q').value.toLowerCase();
        const rd = document.getElementById('reg_d').value;
        const rm = document.getElementById('reg_m').value;
        const hq = document.getElementById('his_q').value.toLowerCase();
        const hd = document.getElementById('his_d').value;
        const hm = document.getElementById('his_m').value;

        const tableReg = document.getElementById('list_reg_table');
        const tableHis = document.getElementById('list_his_table');
        tableReg.innerHTML = ''; tableHis.innerHTML = '';

        Object.keys(rawData).forEach(key => {
            const d = rawData[key];
            if(d.tipo === 'Ingreso') ing += d.monto; else eg += d.monto;
            
            const matchRegQ = `${d.concepto} ${d.cat}`.toLowerCase().includes(rq);
            const matchRegD = !rd || d.fecha === rd;
            const matchRegM = !rm || d.fecha.includes(rm);
            if(matchRegQ && matchRegD && matchRegM) tableReg.innerHTML += renderRow(key, d);

            const matchHisQ = `${d.concepto} ${d.cat}`.toLowerCase().includes(hq);
            const matchHisD = !hd || d.fecha === hd;
            const matchHisM = !hm || d.fecha.includes(hm);
            if(matchHisQ && matchHisD && matchHisM) tableHis.innerHTML += renderRow(key, d);
        });

        document.getElementById('total-ingresos').innerText = `$${ing.toLocaleString('es-CL')}`;
        document.getElementById('total-egresos').innerText = `$${eg.toLocaleString('es-CL')}`;
        document.getElementById('total-saldo').innerText = `$${(ing - eg).toLocaleString('es-CL')}`;
    }

    function renderRow(key, d) {
        return `<tr><td>${d.fecha}</td><td><b>${d.concepto}</b></td><td style="color:${d.tipo==='Ingreso'?'green':'red'}">$${d.monto.toLocaleString('es-CL')}</td><td>${d.cat}</td><td>${d.proveedor}</td><td><span style="font-size:11px; padding:3px 8px; border-radius:10px; background:${d.estado==='Pagado'?'#dcfce7':'#fee2e2'}; color:${d.estado==='Pagado'?'#166534':'#991b1b'}">${d.estado}</span></td><td><button class="btn-action" onclick="editItem('${key}')">‚úèÔ∏è</button><button class="btn-action" onclick="deleteItem('${key}')" style="color:red;">üóëÔ∏è</button></td></tr>`;
    }

    // --- NUEVA FUNCI√ìN: EXPORTAR A EXCEL ---
    function exportExcel() {
        const dataToExport = Object.values(rawData).map(d => ({
            Fecha: d.fecha,
            Tipo: d.tipo,
            Concepto: d.concepto,
            Monto: d.monto,
            Categor√≠a: d.cat,
            Proveedor: d.proveedor,
            Estado: d.estado,
            Metodo_Pago: d.pago
        }));
        
        const ws = XLSX.utils.json_to_sheet(dataToExport);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Movimientos");
        XLSX.writeFile(wb, "FinanzasPRO_Reporte.xlsx");
    }

    // --- NUEVA FUNCI√ìN: EXPORTAR PDF CON DATOS ADICIONALES ---
    function exportPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // Cabecera
        doc.setFontSize(22);
        doc.setTextColor(15, 23, 42);
        doc.text("Reporte Finanzas PRO", 14, 20);
        doc.setFontSize(10);
        doc.text("Mas Control. Menos preocupaci√≥n", 14, 26);
        doc.text(`Fecha: ${new Date().toLocaleDateString()}`, 160, 20);

        // Tabla de Movimientos
        const body = Object.values(rawData).map(d => [d.fecha, d.concepto, d.tipo, `$${d.monto.toLocaleString('es-CL')}`, d.cat, d.estado]);
        doc.autoTable({
            startY: 35,
            head: [['Fecha', 'Concepto', 'Tipo', 'Monto', 'Categor√≠a', 'Estado']],
            body: body,
            theme: 'grid',
            headStyles: { fillColor: [37, 99, 235] }
        });

        // --- RESUMEN FINAL AL FINAL DEL PDF ---
        let finalY = doc.lastAutoTable.finalY + 15;
        
        // Calcular datos para el resumen
        let totalIng = 0, totalEg = 0;
        Object.values(rawData).forEach(d => {
            if(d.tipo === 'Ingreso') totalIng += d.monto; else totalEg += d.monto;
        });

        doc.setFontSize(14);
        doc.text("RESUMEN EJECUTIVO", 14, finalY);
        doc.setFontSize(10);
        
        // Bloque de Totales
        doc.text(`Total Ingresos: $${totalIng.toLocaleString('es-CL')}`, 14, finalY + 10);
        doc.text(`Total Gastos: $${totalEg.toLocaleString('es-CL')}`, 14, finalY + 16);
        doc.text(`Saldo / Ahorro: $${(totalIng - totalEg).toLocaleString('es-CL')}`, 14, finalY + 22);

        // Bloque de Metas
        let metaY = finalY + 35;
        doc.setFontSize(12);
        doc.text("PROGRESO DE METAS:", 14, metaY);
        doc.setFontSize(10);
        let i = 1;
        Object.values(metasData).forEach(m => {
            let porc = ((m.actual / m.objetivo) * 100).toFixed(1);
            doc.text(`${m.nombre}: $${m.actual.toLocaleString()} de $${m.objetivo.toLocaleString()} (${porc}%)`, 14, metaY + (i * 6));
            i++;
        });

        // Mayores Gastos
        let mayorGastoY = metaY + (i * 7) + 5;
        doc.setFontSize(12);
        doc.text("MAYORES GASTOS REGISTRADOS:", 14, mayorGastoY);
        doc.setFontSize(10);
        const topGastos = Object.values(rawData)
            .filter(d => d.tipo === 'Egreso')
            .sort((a,b) => b.monto - a.monto)
            .slice(0, 3);
        
        topGastos.forEach((g, idx) => {
            doc.text(`${idx+1}. ${g.concepto}: $${g.monto.toLocaleString('es-CL')} (${g.fecha})`, 14, mayorGastoY + 7 + (idx * 6));
        });

        doc.save("Reporte_Finanzas_PRO.pdf");
    }

    // Funciones de formulario (L√≥gica id√©ntica a la proporcionada para no romper nada)
    function saveData() {
        const id = document.getElementById('edit-id').value;
        const data = {
            fecha: document.getElementById('f_fecha').value,
            tipo: document.getElementById('f_tipo').value,
            monto: parseFormatted(document.getElementById('f_monto').value),
            presupuesto: parseFormatted(document.getElementById('f_presupuesto').value),
            concepto: document.getElementById('f_concepto').value,
            cat: document.getElementById('f_cat').value,
            subcat: document.getElementById('f_subcat').value,
            pago: document.getElementById('f_pago').value,
            estado: document.getElementById('f_estado').value,
            proveedor: document.getElementById('f_proveedor').value,
            recurrente: document.getElementById('f_recurrente').value
        };
        const ref = db.collection('users').doc(currentUser.uid).collection('movimientos');
        if(id) ref.doc(id).set(data).then(() => clearForm());
        else ref.add(data).then(() => clearForm());
    }

    function clearForm() {
        document.getElementById('edit-id').value = '';
        document.getElementById('f_monto').value = '';
        document.getElementById('f_presupuesto').value = '';
        document.getElementById('f_concepto').value = '';
        document.getElementById('f_diff').innerText = '$0';
        document.getElementById('form-title').innerText = "Nueva Operaci√≥n";
    }

    function editItem(key) {
        const d = rawData[key];
        document.getElementById('edit-id').value = key;
        document.getElementById('f_fecha').value = d.fecha;
        document.getElementById('f_tipo').value = d.tipo;
        document.getElementById('f_monto').value = d.monto.toLocaleString('es-CL');
        document.getElementById('f_presupuesto').value = d.presupuesto.toLocaleString('es-CL');
        document.getElementById('f_concepto').value = d.concepto;
        document.getElementById('f_cat').value = d.cat;
        document.getElementById('f_subcat').value = d.subcat;
        document.getElementById('f_pago').value = d.pago;
        document.getElementById('f_estado').value = d.estado;
        document.getElementById('f_proveedor').value = d.proveedor;
        document.getElementById('f_recurrente').value = d.recurrente;
        document.getElementById('form-title').innerText = "Editando Operaci√≥n";
        showTab('registro');
        calcLogic();
    }

    function deleteItem(key) { if(confirm("¬øEliminar este registro?")) db.collection('users').doc(currentUser.uid).collection('movimientos').doc(key).delete(); }

    function showTab(id) {
        document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        document.getElementById(id).style.display = 'block';
        if(event) event.currentTarget.classList.add('active');
        if(window.innerWidth <= 900) toggleMenu();
    }

    function toggleMenu() { document.getElementById('sidebar').classList.toggle('open'); }

    function loadDropdowns() {
        const map = { f_tipo: 'tipos', f_cat: 'cats', f_subcat: 'subs_list', f_proveedor: 'provs', f_pago: 'pagos', f_estado: 'estados', f_recurrente: 'recurrentes' };
        Object.keys(map).forEach(id => {
            const el = document.getElementById(id);
            if(el) el.innerHTML = settings[map[id]].map(v => `<option value="${v}">${v}</option>`).join('');
        });
    }

    function calcLogic() {
        const m = parseFormatted(document.getElementById('f_monto').value);
        const p = parseFormatted(document.getElementById('f_presupuesto').value);
        const diff = p - m;
        const el = document.getElementById('f_diff');
        el.innerText = `$${diff.toLocaleString('es-CL')}`;
        el.style.color = diff < 0 ? 'var(--danger)' : 'var(--success)';
    }

    // --- METAS LOGIC ---
    function saveMeta() {
        const id = document.getElementById('m_edit_id').value;
        const data = {
            nombre: document.getElementById('m_nombre').value,
            objetivo: parseFormatted(document.getElementById('m_objetivo').value),
            actual: parseFormatted(document.getElementById('m_actual').value)
        };
        if(!data.nombre || data.objetivo <= 0) return alert("Completa nombre y objetivo");
        const ref = db.collection('users').doc(currentUser.uid).collection('metas');
        if(id) ref.doc(id).update(data).then(() => cancelEditMeta());
        else ref.add(data).then(() => cancelEditMeta());
    }

    function renderMetas() {
        const container = document.getElementById('metas-container');
        container.innerHTML = '';
        Object.keys(metasData).forEach(id => {
            const m = metasData[id];
            const porc = Math.min((m.actual / m.objetivo) * 100, 100).toFixed(1);
            container.innerHTML += `
                <div class="card" style="margin-bottom:0; border-left: 5px solid ${porc >= 100 ? 'var(--success)' : 'var(--acc)'}">
                    <div style="display:flex; justify-content:space-between; align-items: center;">
                        <h4 style="color:var(--acc)">${m.nombre}</h4>
                        <div style="display:flex; gap:5px;">
                            <button class="btn-goal-edit" onclick="editMeta('${id}')">‚úèÔ∏è</button>
                            <button class="btn-goal-edit" onclick="deleteMeta('${id}')" style="color:red;">üóëÔ∏è</button>
                        </div>
                    </div>
                    <p style="font-size:20px; font-weight:900; margin:10px 0;">$${m.actual.toLocaleString()} / $${m.objetivo.toLocaleString()}</p>
                    <div class="goal-progress"><div class="goal-bar" style="width:${porc}%"></div></div>
                    <small style="font-weight:bold; color:#64748b">${porc}% completado</small>
                </div>`;
        });
    }

    function editMeta(id) {
        const m = metasData[id];
        document.getElementById('m_edit_id').value = id;
        document.getElementById('m_nombre').value = m.nombre;
        document.getElementById('m_objetivo').value = m.objetivo.toLocaleString('es-CL');
        document.getElementById('m_actual').value = m.actual.toLocaleString('es-CL');
        document.getElementById('btn-save-meta').innerText = "üíæ ACTUALIZAR";
        document.getElementById('btn-cancel-meta').style.display = 'block';
    }

    function cancelEditMeta() {
        document.getElementById('m_edit_id').value = '';
        document.getElementById('m_nombre').value = '';
        document.getElementById('m_objetivo').value = '';
        document.getElementById('m_actual').value = '';
        document.getElementById('btn-save-meta').innerText = "‚ûï CREAR META";
        document.getElementById('btn-cancel-meta').style.display = 'none';
    }

    function deleteMeta(id) { if(confirm("¬øEliminar meta?")) db.collection('users').doc(currentUser.uid).collection('metas').doc(id).delete(); }

    function updateCharts() {
        const catsMap = {};
        let totalEgMes = 0;
        let totalIngMes = 0;
        const now = new Date();
        const currentMonth = `-${String(now.getMonth()+1).padStart(2,'0')}-`;

        Object.values(rawData).forEach(d => {
            if(d.tipo === 'Egreso') {
                catsMap[d.cat] = (catsMap[d.cat] || 0) + d.monto;
                if(d.fecha.includes(currentMonth)) totalEgMes += d.monto;
            } else {
                if(d.fecha.includes(currentMonth)) totalIngMes += d.monto;
            }
        });

        document.getElementById('ana-mes-total').innerText = `$${totalEgMes.toLocaleString('es-CL')}`;
        document.getElementById('ana-semana-total').innerText = `$${totalIngMes.toLocaleString('es-CL')}`;

        const ctx = document.getElementById('chartDona').getContext('2d');
        if(donaChart) donaChart.destroy();
        donaChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: Object.keys(catsMap),
                datasets: [{ data: Object.values(catsMap), backgroundColor: ['#2563eb','#10b981','#f59e0b','#ef4444','#8b5cf6','#06b6d4'] }]
            },
            options: { maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
        });
    }

    // Configuraci√≥n y par√°metros (Se mantiene igual)
    function addParam() {
        const p = document.getElementById('adj_param').value;
        const val = document.getElementById('adj_new_val').value;
        if(!val) return;
        settings[p].push(val);
        db.collection('users').doc(currentUser.uid).collection('config').doc('listas').set(settings);
        document.getElementById('adj_new_val').value = '';
        renderConfigList();
    }

    function renderConfigList() {
        const p = document.getElementById('adj_param').value;
        const cont = document.getElementById('adj_list_container');
        cont.innerHTML = settings[p].map((v, i) => `
            <div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #eee;">
                <span>${v}</span>
                <button onclick="deleteParam('${p}', ${i})" style="color:red; border:none; background:none; cursor:pointer;">‚úï</button>
            </div>`).join('');
    }

    function deleteParam(p, i) {
        settings[p].splice(i, 1);
        db.collection('users').doc(currentUser.uid).collection('config').doc('listas').set(settings);
        renderConfigList();
    }
</script>

</body>
</html>
