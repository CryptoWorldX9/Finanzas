<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finanzas PRO | Corporativo</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        :root { --p: #0f172a; --acc: #2563eb; --bg: #f1f5f9; --danger: #ef4444; --success: #10b981; --card: #ffffff; }
        * { margin:0; padding:0; box-sizing:border-box; font-family: 'Inter', system-ui, sans-serif; }
        
        body { background: var(--bg); display: flex; min-height: 100vh; color: #1e293b; overflow-x: hidden; }

        /* Sidebar - Oculta en m√≥vil, fija en escritorio */
        .sidebar { 
            width: 260px; background: var(--p); color: white; padding: 25px; 
            position: fixed; height: 100vh; z-index: 1100; transition: transform 0.3s ease;
        }

        .main-content { 
            margin-left: 260px; padding: 20px; width: 100%; transition: 0.3s; 
            margin-top: 75px; max-width: 1400px;
        }

        /* Top Bar Pro */
        .top-bar { 
            position: fixed; top: 0; left: 260px; right: 0; height: 75px; 
            background: rgba(255,255,255,0.9); backdrop-filter: blur(10px);
            display: flex; align-items: center; padding: 0 30px;
            box-shadow: 0 1px 0px rgba(0,0,0,0.05); z-index: 1000; gap: 15px;
        }

        .balance-card { display: flex; gap: 20px; flex-grow: 1; justify-content: flex-end; }
        .bal-item { text-align: right; }
        .bal-item small { font-size: 9px; font-weight: 800; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; }
        .bal-item p { font-size: 15px; font-weight: 900; }

        /* Bot√≥n Men√∫ - Solo m√≥vil */
        .menu-toggle { 
            display: none; background: var(--p); color: white; border: none; 
            padding: 10px; border-radius: 8px; cursor: pointer;
        }

        /* Nuevo Sistema de Tips (Di√°logo Assistant) */
        .assistant-box {
            display: flex; align-items: center; gap: 15px;
            background: white; padding: 15px; border-radius: 15px;
            margin-bottom: 25px; border: 1px solid #e2e8f0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.03);
        }
        .avatar { width: 45px; height: 45px; background: var(--acc); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; color: white; flex-shrink: 0; }
        .speech-bubble { font-size: 14px; line-height: 1.5; color: #475569; position: relative; transition: opacity 0.5s; }

        /* Cards y Forms */
        .card { background: var(--card); border-radius: 20px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 25px; border: 1px solid #e2e8f0; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px; }
        
        label { font-size: 10px; font-weight: 700; color: #64748b; text-transform: uppercase; margin-bottom: 6px; display: block; }
        input, select { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 12px; font-size: 14px; outline: none; transition: 0.2s; }
        input:focus { border-color: var(--acc); box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }
        
        .btn-p { background: var(--acc); color: white; border: none; padding: 14px; border-radius: 12px; cursor: pointer; font-weight: 700; transition: 0.3s; }
        .btn-p:hover { opacity: 0.9; transform: translateY(-1px); }

        .nav-link { display: flex; align-items: center; gap: 12px; padding: 14px; color: #94a3b8; cursor: pointer; border-radius: 12px; margin-bottom: 5px; transition: 0.2s; }
        .nav-link:hover { background: rgba(255,255,255,0.05); color: white; }
        .nav-link.active { background: var(--acc); color: white; box-shadow: 0 4px 12px rgba(37,99,235,0.3); }

        /* Responsive M√≥vil */
        @media (max-width: 900px) {
            .sidebar { transform: translateX(-100%); width: 280px; }
            .sidebar.open { transform: translateX(0); }
            .main-content { margin-left: 0; padding: 15px; }
            .top-bar { left: 0; padding: 0 15px; }
            .menu-toggle { display: block; }
            .balance-card { gap: 10px; }
            .bal-item p { font-size: 13px; }
            .form-grid { grid-template-columns: 1fr; }
            .table-wrap { margin: 0 -15px; padding: 0 15px; }
        }
    </style>
</head>
<body>

<nav class="sidebar" id="sidebar">
    <h1 style="margin-bottom: 40px; font-weight: 900; font-size: 22px; color: white; text-align: center;">Finanzas<span style="color:var(--acc)">PRO</span></h1>
    <div class="nav-link active" onclick="showTab('registro')">üìù <span>Registro</span></div>
    <div class="nav-link" onclick="showTab('historial')">üìú <span>Historial</span></div>
    <div class="nav-link" onclick="showTab('analisis')">üìä <span>An√°lisis</span></div>
</nav>

<div class="top-bar">
    <button class="menu-toggle" onclick="toggleMenu()">‚ò∞</button>
    <div class="balance-card">
        <div class="bal-item"><small>Ingresos</small><p style="color:var(--success)" id="total-ingresos">$0</p></div>
        <div class="bal-item"><small>Egresos</small><p style="color:var(--danger)" id="total-egresos">$0</p></div>
        <div class="bal-item"><small>Saldo</small><p id="total-saldo" style="color:var(--p)">$0</p></div>
    </div>
</div>

<main class="main-content">
    <div class="assistant-box">
        <div class="avatar">üí°</div>
        <div class="speech-bubble">
            <strong>Tip Financiero:</strong><br>
            <span id="tip-text">Analizando tus finanzas...</span>
        </div>
    </div>

    <div id="registro" class="tab-content">
        <div class="card">
            <h3 id="form-title" style="font-size: 18px;">Nueva Operaci√≥n</h3><br>
            <input type="hidden" id="edit-id">
            <div class="form-grid">
                <div><label>Fecha</label><input type="date" id="f_fecha"></div>
                <div><label>Tipo</label><select id="f_tipo"><option value="Egreso">üîª Egreso</option><option value="Ingreso">üîπ Ingreso</option></select></div>
                <div><label>Monto ($)</label><input type="number" id="f_monto" oninput="calcLogic()"></div>
                <div><label>Presupuesto ($)</label><input type="number" id="f_presupuesto" oninput="calcLogic()"></div>
            </div>
            <div class="form-grid">
                <div><label>Concepto</label><input type="text" id="f_concepto" placeholder="Ej: Supermercado"></div>
                <div><label>Categor√≠a</label><select id="f_cat" onchange="loadSubs()"></select></div>
                <div><label>Subcategor√≠a</label><select id="f_subcat"></select></div>
                <div><label>Proveedor</label><select id="f_proveedor"></select></div>
            </div>
            <div class="form-grid">
                <div><label>Pago</label><select id="f_pago"></select></div>
                <div><label>Estado</label><select id="f_estado"><option>Pagado</option><option>Pendiente</option></select></div>
                <div><label>Diferencia</label><p id="f_diff" style="font-weight:900; font-size:20px; color:var(--success)">$0</p></div>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button class="btn-p" style="flex: 2;" onclick="saveData()">üíæ GUARDAR</button>
                <button class="btn-p" style="background:#64748b; flex: 1;" onclick="clearForm()">üßπ</button>
            </div>
        </div>

        <div class="card">
            <h3 style="font-size: 16px;">Movimientos Recientes & Filtros</h3><br>
            <div class="filter-header">
                <div style="flex:2; width: 100%;"><label>Buscador</label><input type="text" id="reg_q" placeholder="Buscar concepto..." oninput="refreshUI()"></div>
                <div style="flex:1; width: 100%;">
                    <label>Filtrar Mes</label>
                    <select id="reg_m" onchange="refreshUI()">
                        <option value="">Cualquier mes</option>
                        <option value="-01">Enero</option><option value="-02">Febrero</option><option value="-03">Marzo</option><option value="-04">Abril</option><option value="-05">Mayo</option><option value="-06">Junio</option><option value="-07">Julio</option><option value="-08">Agosto</option><option value="-09">Septiembre</option><option value="-10">Octubre</option><option value="-11">Noviembre</option><option value="-12">Diciembre</option>
                    </select>
                </div>
            </div>
            <div class="table-wrap">
                <table id="table-reg">
                    <thead><tr><th>Fecha</th><th>Concepto</th><th>Monto</th><th>Estado</th><th>Acciones</th></tr></thead>
                    <tbody id="list_reg_table"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="historial" class="tab-content" style="display:none;">
        <div class="card">
            <h3 style="font-size: 16px;">Historial General</h3><br>
            <div class="filter-header">
                <div style="flex:2; width: 100%;"><input type="text" id="his_q" placeholder="Buscar en historial..." oninput="refreshUI()"></div>
                <div style="flex:1; width: 100%;">
                    <select id="his_m" onchange="refreshUI()">
                        <option value="">Mes</option>
                        <option value="-01">Enero</option><option value="-02">Febrero</option><option value="-03">Marzo</option><option value="-04">Abril</option><option value="-05">Mayo</option><option value="-06">Junio</option><option value="-07">Julio</option><option value="-08">Agosto</option><option value="-09">Septiembre</option><option value="-10">Octubre</option><option value="-11">Noviembre</option><option value="-12">Diciembre</option>
                    </select>
                </div>
            </div>
            <div class="table-wrap">
                <table>
                    <thead><tr><th>Fecha</th><th>Concepto</th><th>Monto</th><th>Categor√≠a</th><th>Estado</th><th>Acciones</th></tr></thead>
                    <tbody id="list_his_table"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="analisis" class="tab-content" style="display:none;">
        <div class="form-grid">
            <div class="card">
                <h3>Gastos por Categor√≠a</h3><br>
                <div style="height: 300px;"><canvas id="chartDona"></canvas></div>
            </div>
            <div class="card">
                <h3>Ranking de Gasto</h3><br>
                <div style="background:var(--bg); padding:15px; border-radius:12px; margin-bottom:15px; text-align:center;">
                    <small>M√ÅXIMO GASTO</small>
                    <p id="ana-top-cat" style="font-size:20px; font-weight:900; color:var(--acc)">---</p>
                </div>
                <table style="min-width: 100%;">
                    <tbody id="ana-table-body"></tbody>
                </table>
            </div>
        </div>
    </div>
</main>

<script>
    // FIREBASE CONFIG
    const firebaseConfig = {
      apiKey: "AIzaSyCO6WXu9iZsyEUmNNxrE4oWToLYY8wl-y4",
      authDomain: "misfinanzaspro-d2f3f.firebaseapp.com",
      databaseURL: "https://misfinanzaspro-d2f3f-default-rtdb.firebaseio.com",
      projectId: "misfinanzaspro-d2f3f",
      storageBucket: "misfinanzaspro-d2f3f.firebasestorage.app",
      messagingSenderId: "613366165036",
      appId: "1:613366165036:web:bebc72b38d39ab64932b89"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let rawData = {};
    let donaChart = null;
    let settings = JSON.parse(localStorage.getItem('fpro_v6_settings')) || {
        cats: ['Servicios b√°sicos', 'Alimentaci√≥n', 'Transporte', 'Salud', 'Ocio'],
        subs: {'Servicios b√°sicos': ['Agua potable', 'Luz', 'Gas', 'Internet']},
        provs: ['Aguas Andinas', 'Enel', 'Metrogas', 'Lider'],
        pagos: ['D√©bito', 'Cr√©dito', 'Efectivo']
    };

    const tips = [
        "Ahorra el 10% de tus ingresos apenas los recibas.", "Usa la regla 50/30/20: 50% Necesidades, 30% Deseos, 20% Ahorro.",
        "Los 'gastos hormiga' pueden sumar una fortuna al a√±o. ¬°Cuidado!", "Antes de una compra grande, espera 24 horas para evitar impulsos.",
        "Revisa tus suscripciones digitales. ¬øRealmente usas todas?", "Un fondo de emergencia debe cubrir al menos 3 meses de gastos.",
        "Pagar tus deudas m√°s peque√±as primero te da motivaci√≥n psicol√≥gica.", "Comprar a granel ahorra hasta un 20% en tu cesta mensual.",
        "Planifica tus comidas de la semana para no gastar de m√°s afuera.", "Ahorrar es el camino a la libertad financiera, no solo a comprar cosas.",
        "Invierte en educaci√≥n, es el activo que m√°s rentabilidad genera.", "No gastes dinero que a√∫n no has ganado (tarjetas de cr√©dito).",
        "El inter√©s compuesto es la octava maravilla. Empieza a invertir hoy.", "Paga tus tarjetas a tiempo para no regalar dinero en intereses."
    ];

    function init() {
        document.getElementById('f_fecha').valueAsDate = new Date();
        rotateTips();
        loadDropdowns();
        db.ref('movimientos').on('value', snap => {
            rawData = snap.val() || {};
            refreshUI();
            updateCharts();
        });
    }

    function rotateTips() {
        const el = document.getElementById('tip-text');
        let i = 0;
        setInterval(() => {
            el.style.opacity = 0;
            setTimeout(() => {
                el.innerText = tips[i];
                el.style.opacity = 1;
                i = (i + 1) % tips.length;
            }, 500);
        }, 8000);
    }

    function refreshUI() {
        let ing = 0, eg = 0;
        const rq = document.getElementById('reg_q').value.toLowerCase();
        const rm = document.getElementById('reg_m').value;
        const hq = document.getElementById('his_q').value.toLowerCase();
        const hm = document.getElementById('his_m').value;

        const tableReg = document.getElementById('list_reg_table');
        const tableHis = document.getElementById('list_his_table');
        tableReg.innerHTML = ''; tableHis.innerHTML = '';

        Object.keys(rawData).reverse().forEach(key => {
            const d = rawData[key];
            if(d.tipo === 'Ingreso') ing += d.monto; else eg += d.monto;
            
            const searchBody = `${d.concepto} ${d.cat} ${d.proveedor}`.toLowerCase();
            const regMatch = searchBody.includes(rq) && (rm ? d.fecha.includes(rm) : true);
            if(regMatch) tableReg.innerHTML += renderRow(key, d, true);

            const hisMatch = searchBody.includes(hq) && (hm ? d.fecha.includes(hm) : true);
            if(hisMatch) tableHis.innerHTML += renderRow(key, d, false);
        });

        document.getElementById('total-ingresos').innerText = `$${ing.toLocaleString()}`;
        document.getElementById('total-egresos').innerText = `$${eg.toLocaleString()}`;
        document.getElementById('total-saldo').innerText = `$${(ing - eg).toLocaleString()}`;
    }

    function renderRow(key, d, mini) {
        if(mini) {
            return `<tr>
                <td style="font-size:11px">${d.fecha.split('-').slice(1).join('/')}</td>
                <td><b>${d.concepto}</b></td>
                <td style="color:${d.tipo==='Ingreso'?'#10b981':'#ef4444'}">$${d.monto.toLocaleString()}</td>
                <td><span style="font-size:10px; color:${d.estado==='Pagado'?'green':'orange'}">${d.estado}</span></td>
                <td><button class="btn-action" onclick="editItem('${key}')">‚úèÔ∏è</button></td>
            </tr>`;
        }
        return `<tr>
            <td>${d.fecha}</td>
            <td><b>${d.concepto}</b></td>
            <td style="color:${d.tipo==='Ingreso'?'#10b981':'#ef4444'}">$${d.monto.toLocaleString()}</td>
            <td>${d.cat}</td>
            <td>${d.estado}</td>
            <td>
                <button class="btn-action" onclick="editItem('${key}')">‚úèÔ∏è</button>
                <button class="btn-action" onclick="deleteItem('${key}')" style="color:red">üóëÔ∏è</button>
            </td>
        </tr>`;
    }

    function updateCharts() {
        const ctx = document.getElementById('chartDona');
        if(!ctx) return;
        let catTotals = {};
        Object.values(rawData).forEach(d => {
            if(d.tipo === 'Egreso') catTotals[d.cat] = (catTotals[d.cat] || 0) + d.monto;
        });
        if(donaChart) donaChart.destroy();
        donaChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: Object.keys(catTotals),
                datasets: [{ data: Object.values(catTotals), backgroundColor: ['#2563eb', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'] }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
        });
        const sorted = Object.entries(catTotals).sort((a,b) => b[1] - a[1]);
        document.getElementById('ana-top-cat').innerText = sorted[0] ? sorted[0][0] : '---';
        document.getElementById('ana-table-body').innerHTML = sorted.map(i => `<tr><td>${i[0]}</td><td align="right"><b>$${i[1].toLocaleString()}</b></td></tr>`).join('');
    }

    // Funciones de Control
    function saveData() {
        const id = document.getElementById('edit-id').value;
        const data = {
            fecha: document.getElementById('f_fecha').value,
            tipo: document.getElementById('f_tipo').value,
            monto: parseFloat(document.getElementById('f_monto').value) || 0,
            presupuesto: parseFloat(document.getElementById('f_presupuesto').value) || 0,
            concepto: document.getElementById('f_concepto').value,
            cat: document.getElementById('f_cat').value,
            subcat: document.getElementById('f_subcat').value,
            pago: document.getElementById('f_pago').value,
            estado: document.getElementById('f_estado').value,
            proveedor: document.getElementById('f_proveedor').value,
            recurrente: 'No'
        };
        if(id) db.ref('movimientos/' + id).set(data); else db.ref('movimientos').push(data);
        clearForm();
    }
    function editItem(key) {
        const d = rawData[key];
        document.getElementById('edit-id').value = key;
        document.getElementById('f_fecha').value = d.fecha;
        document.getElementById('f_monto').value = d.monto;
        document.getElementById('f_concepto').value = d.concepto;
        document.getElementById('f_cat').value = d.cat;
        document.getElementById('form-title').innerText = "‚úèÔ∏è Editando...";
        showTab('registro');
    }
    function deleteItem(key) { if(confirm("¬øBorrar registro?")) db.ref('movimientos/' + key).remove(); }
    function clearForm() { document.getElementById('edit-id').value = ''; document.getElementById('f_monto').value = ''; document.getElementById('f_concepto').value = ''; document.getElementById('form-title').innerText = "Nueva Operaci√≥n"; }
    function calcLogic() {
        const m = parseFloat(document.getElementById('f_monto').value) || 0;
        const p = parseFloat(document.getElementById('f_presupuesto').value) || 0;
        const d = p - m;
        document.getElementById('f_diff').innerText = `$${d.toLocaleString()}`;
        document.getElementById('f_diff').style.color = d < 0 ? 'var(--danger)' : 'var(--success)';
    }
    function loadDropdowns() {
        const fill = (id, arr) => document.getElementById(id).innerHTML = arr.map(i => `<option>${i}</option>`).join('');
        fill('f_cat', settings.cats); fill('f_proveedor', settings.provs); fill('f_pago', settings.pagos);
        loadSubs();
    }
    function loadSubs() {
        const c = document.getElementById('f_cat').value;
        const s = settings.subs[c] || ['General'];
        document.getElementById('f_subcat').innerHTML = s.map(v => `<option>${v}</option>`).join('');
    }
    function toggleMenu() { document.getElementById('sidebar').classList.toggle('open'); }
    function showTab(id) {
        document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
        document.getElementById(id).style.display = 'block';
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        const activeLink = document.querySelector(`.nav-link[onclick*="${id}"]`);
        if(activeLink) activeLink.classList.add('active');
        if(window.innerWidth < 900) document.getElementById('sidebar').classList.remove('open');
    }

    window.onload = init;
</script>
</body>
</html>
