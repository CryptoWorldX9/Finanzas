<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finanzas PRO | Master System</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    
    <style>
        :root { --p: #0f172a; --acc: #2563eb; --bg: #f1f5f9; --danger: #ef4444; --success: #10b981; }
        * { margin:0; padding:0; box-sizing:border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--bg); display: flex; min-height: 100vh; color: #1e293b; }

        .sidebar { width: 260px; background: var(--p); color: white; padding: 20px; position: fixed; height: 100vh; z-index: 100; }
        .main-content { margin-left: 260px; padding: 30px; width: 100%; }

        .nav-link { display: flex; align-items: center; gap: 10px; padding: 12px; color: #cbd5e1; cursor: pointer; border-radius: 8px; margin-bottom: 5px; }
        .nav-link.active { background: var(--acc); color: white; }

        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 15px; }
        
        label { font-size: 11px; font-weight: bold; color: #64748b; text-transform: uppercase; display: block; margin-bottom: 5px; }
        input, select { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 14px; }
        
        .btn { padding: 12px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; transition: 0.2s; }
        .btn-p { background: var(--acc); color: white; width: 100%; }
        
        table { width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 15px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #f1f5f9; }

        .config-item { display: flex; justify-content: space-between; align-items: center; background: #f8fafc; padding: 8px 12px; border-radius: 6px; margin-bottom: 5px; }
        .btn-danger { background: var(--danger); color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; }

        @media (max-width: 768px) {
            .sidebar { width: 0; padding: 0; overflow: hidden; }
            .main-content { margin-left: 0; }
        }
    </style>
</head>
<body>

<nav class="sidebar">
    <h2 style="margin-bottom: 25px;">FINANZAS PRO</h2>
    <div class="nav-link active" onclick="showTab('registro')">üè† <span>Registro</span></div>
    <div class="nav-link" onclick="showTab('ajustes')">‚öôÔ∏è <span>Ajustes</span></div>
</nav>

<main class="main-content">
    <div id="registro" class="tab-content">
        <div class="card">
            <h3 id="form-title">Registrar Movimiento</h3><br>
            <input type="hidden" id="edit-id">
            
            <div class="form-grid">
                <div><label>Fecha</label><input type="date" id="f_fecha"></div>
                <div><label>Tipo</label><select id="f_tipo"><option>Egreso</option><option>Ingreso</option></select></div>
                <div><label>Monto</label><input type="number" id="f_monto" oninput="calcDiff()"></div>
                <div><label>Presupuesto</label><input type="number" id="f_presupuesto" oninput="calcDiff()"></div>
            </div>

            <div class="form-grid">
                <div><label>Concepto</label><input type="text" id="f_concepto"></div>
                <div><label>Categor√≠a</label><select id="f_cat" onchange="updateSubSelect()"></select></div>
                <div><label>Subcategor√≠a</label><select id="f_subcat"></select></div>
                <div><label>Proveedor</label><select id="f_proveedor"></select></div>
            </div>

            <div class="btn-group" style="display:flex; gap:10px;">
                <button class="btn btn-p" id="btn-save" onclick="saveData()">üíæ GUARDAR EN NUBE</button>
                <button class="btn" style="background:#64748b; color:white;" onclick="clearForm()">LIMPIAR</button>
                <div style="margin-left:auto; align-self:center;"><b>Diff: </b><span id="val_diff">$0</span></div>
            </div>
        </div>

        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3>Listado Mensual</h3>
                <select id="filter_mes" onchange="renderList()" style="width:auto;"></select>
            </div>
            <table>
                <thead><tr><th>Fecha</th><th>Concepto</th><th>Monto</th><th>Acciones</th></tr></thead>
                <tbody id="list_body"></tbody>
            </table>
        </div>
    </div>

    <div id="ajustes" class="tab-content" style="display:none;">
        <h2>Configuraci√≥n de Listas</h2><br>
        <div class="form-grid">
            <div class="card">
                <label>Categor√≠as</label>
                <div style="display:flex; gap:5px; margin-bottom:10px;">
                    <input type="text" id="new_cat"><button onclick="addItem('cats', 'new_cat')" class="btn btn-p" style="width:40px">+</button>
                </div>
                <div id="list_cats"></div>
            </div>
            <div class="card">
                <label>Proveedores</label>
                <div style="display:flex; gap:5px; margin-bottom:10px;">
                    <input type="text" id="new_prov"><button onclick="addItem('proveedores', 'new_prov')" class="btn btn-p" style="width:40px">+</button>
                </div>
                <div id="list_provs"></div>
            </div>
        </div>
    </div>
</main>

<script>
    // CONFIGURACI√ìN CORREGIDA
    const firebaseConfig = {
      apiKey: "AIzaSyCO6WXu9iZsyEUmNNxrE4oWToLYY8wl-y4",
      authDomain: "misfinanzaspro-d2f3f.firebaseapp.com",
      // Esta URL es CLAVE, si no es esta, c√≥piala de tu consola de Firebase (Realtime Database)
      databaseURL: "https://misfinanzaspro-d2f3f-default-rtdb.firebaseio.com", 
      projectId: "misfinanzaspro-d2f3f",
      storageBucket: "misfinanzaspro-d2f3f.firebasestorage.app",
      messagingSenderId: "613366165036",
      appId: "1:613366165036:web:bebc72b38d39ab64932b89"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let settings = JSON.parse(localStorage.getItem('fpro_settings_v3')) || {
        cats: ['Servicios', 'Comida', 'Transporte'],
        subs: { 'Servicios': ['Agua', 'Luz', 'Gas'] },
        proveedores: ['Aguas Andinas', 'Enel', 'General'],
        pagos: ['Efectivo', 'D√©bito']
    };

    let rawData = {};

    function init() {
        document.getElementById('f_fecha').valueAsDate = new Date();
        populateMonths();
        updateAllSelects();
        
        // Listener REALTIME
        db.ref('movimientos').on('value', (snap) => {
            console.log("Datos recibidos de Firebase:", snap.val()); // Para depuraci√≥n
            rawData = snap.val() || {};
            renderList();
        }, (error) => {
            console.error("Error de Firebase:", error);
            alert("Error de conexi√≥n: Verifica las Reglas en Firebase");
        });
    }

    function saveData() {
        const id = document.getElementById('edit-id').value;
        const fecha = document.getElementById('f_fecha').value;
        const monto = parseFloat(document.getElementById('f_monto').value);

        if(!monto) return alert("Ingresa un monto v√°lido");

        const data = {
            fecha,
            tipo: document.getElementById('f_tipo').value,
            monto: monto,
            presupuesto: parseFloat(document.getElementById('f_presupuesto').value) || 0,
            concepto: document.getElementById('f_concepto').value || "Sin concepto",
            cat: document.getElementById('f_cat').value,
            subcat: document.getElementById('f_subcat').value,
            proveedor: document.getElementById('f_proveedor').value,
            mes_anio: fecha.substring(0, 7)
        };

        if(id) {
            db.ref('movimientos/' + id).set(data)
                .then(() => alert("Actualizado en la nube"))
                .catch(e => alert("Error: " + e.message));
        } else {
            db.ref('movimientos').push(data)
                .then(() => alert("Guardado en la nube"))
                .catch(e => alert("Error: " + e.message));
        }
        clearForm();
    }

    function renderList() {
        const mes = document.getElementById('filter_mes').value;
        const body = document.getElementById('list_body');
        body.innerHTML = '';
        
        Object.keys(rawData).forEach(key => {
            const d = rawData[key];
            if(d.mes_anio === mes) {
                body.innerHTML += `
                <tr>
                    <td>${d.fecha}</td>
                    <td>${d.concepto}</td>
                    <td style="color:${d.tipo==='Ingreso'?'green':'red'}">$${d.monto.toLocaleString()}</td>
                    <td>
                        <button onclick="editItem('${key}')">‚úèÔ∏è</button>
                        <button onclick="deleteItem('${key}')">üóëÔ∏è</button>
                    </td>
                </tr>`;
            }
        });
    }

    // Funciones de Apoyo
    function updateAllSelects() {
        const fill = (id, arr) => {
            const el = document.getElementById(id);
            if(el) el.innerHTML = arr.map(i => `<option>${i}</option>`).join('');
        };
        fill('f_cat', settings.cats);
        fill('f_proveedor', settings.proveedores);
        updateSubSelect();
    }

    function updateSubSelect() {
        const cat = document.getElementById('f_cat').value;
        const subs = settings.subs[cat] || ['General'];
        document.getElementById('f_subcat').innerHTML = subs.map(s => `<option>${s}</option>`).join('');
    }

    function calcDiff() {
        const m = parseFloat(document.getElementById('f_monto').value) || 0;
        const p = parseFloat(document.getElementById('f_presupuesto').value) || 0;
        const d = p - m;
        document.getElementById('val_diff').innerText = `$${d.toLocaleString()}`;
        document.getElementById('val_diff').style.color = d < 0 ? 'red' : 'green';
    }

    function deleteItem(key) {
        if(confirm("¬øEliminar?")) db.ref('movimientos/' + key).remove();
    }

    function clearForm() {
        document.getElementById('edit-id').value = '';
        document.getElementById('f_monto').value = '';
        document.getElementById('f_concepto').value = '';
        document.getElementById('form-title').innerText = "Registrar Movimiento";
    }

    function populateMonths() {
        const sel = document.getElementById('filter_mes');
        const now = new Date();
        for(let i=0; i<12; i++) {
            const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
            const val = d.toISOString().substring(0,7);
            sel.innerHTML += `<option value="${val}">${val}</option>`;
        }
    }

    function showTab(id) {
        document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
        document.getElementById(id).style.display = 'block';
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        event.currentTarget.classList.add('active');
        if(id === 'ajustes') renderSettings();
    }

    function renderSettings() {
        const draw = (arr, key, target) => {
            document.getElementById(target).innerHTML = arr.map((item, i) => `
                <div class="config-item"><span>${item}</span>
                <button class="btn-danger" onclick="removeItem('${key}', ${i})">‚úï</button></div>`).join('');
        };
        draw(settings.cats, 'cats', 'list_cats');
        draw(settings.proveedores, 'proveedores', 'list_provs');
    }

    function addItem(key, inputId) {
        const v = document.getElementById(inputId).value;
        if(v) { settings[key].push(v); saveSettings(); document.getElementById(inputId).value=''; }
    }

    function removeItem(key, i) {
        settings[key].splice(i, 1); saveSettings();
    }

    function saveSettings() {
        localStorage.setItem('fpro_settings_v3', JSON.stringify(settings));
        updateAllSelects(); renderSettings();
    }

    window.onload = init;
</script>
</body>
</html>
