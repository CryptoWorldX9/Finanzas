<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finanzas PRO | Master Edition</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        :root { 
            --p: #0f172a; --acc: #2563eb; --bg: #f8fafc; 
            --danger: #ef4444; --success: #10b981; --warning: #f59e0b;
        }
        * { margin:0; padding:0; box-sizing:border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--bg); display: flex; min-height: 100vh; color: #1e293b; }

        /* Sidebar */
        .sidebar { width: 260px; background: var(--p); color: white; padding: 25px; position: fixed; height: 100vh; z-index: 1000; transition: 0.4s; }
        .main-content { margin-left: 260px; padding: 20px; width: calc(100% - 260px); margin-top: 75px; }

        /* Top Bar & Balance */
        .top-bar { 
            position: fixed; top: 0; left: 260px; right: 0; height: 75px; 
            background: white; display: flex; align-items: center; padding: 0 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); z-index: 900; gap: 20px;
        }
        .balance-card { display: flex; gap: 15px; flex-grow: 1; justify-content: flex-end; }
        .bal-item { text-align: right; line-height: 1.2; }
        .bal-item small { font-size: 10px; font-weight: 800; color: #64748b; text-transform: uppercase; }
        .bal-item p { font-size: 16px; font-weight: 900; }

        /* UI Elements */
        .card { background: white; border-radius: 16px; padding: 25px; box-shadow: 0 4px 6px rgba(0,0,0,0.02); margin-bottom: 25px; border: 1px solid #e2e8f0; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 15px; }
        
        label { font-size: 11px; font-weight: 800; color: #64748b; text-transform: uppercase; margin-bottom: 5px; display: block; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 10px; font-size: 14px; background: #fff; }
        
        .btn-p { background: var(--acc); color: white; border: none; padding: 12px 20px; border-radius: 10px; cursor: pointer; font-weight: 700; width: 100%; transition: 0.3s; }
        .btn-p:hover { opacity: 0.9; transform: translateY(-1px); }
        
        .nav-link { display: flex; align-items: center; gap: 12px; padding: 14px; color: #cbd5e1; cursor: pointer; border-radius: 12px; margin-bottom: 8px; }
        .nav-link.active { background: var(--acc); color: white; }

        /* Table */
        .table-wrap { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 700px; }
        th { text-align: left; padding: 15px; background: #f8fafc; color: #64748b; font-size: 11px; text-transform: uppercase; border-bottom: 2px solid #edf2f7; }
        td { padding: 15px; border-bottom: 1px solid #f1f5f9; font-size: 13px; }

        .btn-action { background: none; border: 1px solid #e2e8f0; padding: 6px; border-radius: 6px; cursor: pointer; transition: 0.2s; margin-right: 5px; }
        .btn-action:hover { background: #f1f5f9; border-color: var(--acc); }

        /* Responsive */
        @media (max-width: 900px) {
            .sidebar { left: -100%; }
            .sidebar.open { left: 0; }
            .top-bar { left: 0; padding: 0 15px; height: 110px; flex-direction: column; justify-content: center; }
            .main-content { margin-left: 0; margin-top: 120px; padding: 15px; }
            .balance-card { justify-content: center; width: 100%; gap: 10px; }
            .bal-item p { font-size: 13px; }
        }
    </style>
</head>
<body>

<div class="top-bar">
    <div style="display:flex; align-items:center; gap:10px;">
        <button onclick="toggleMenu()" style="background:var(--p); color:white; border:none; padding:8px; border-radius:5px; cursor:pointer;">‚ò∞</button>
        <h2 style="font-size: 16px;">FINANZAS PRO</h2>
    </div>
    <div class="balance-card">
        <div class="bal-item"><small>Ingresos</small><p style="color:var(--success)" id="total-ingresos">$0</p></div>
        <div class="bal-item"><small>Egresos</small><p style="color:var(--danger)" id="total-egresos">$0</p></div>
        <div class="bal-item"><small>Saldo</small><p id="total-saldo">$0</p></div>
    </div>
</div>

<nav class="sidebar" id="sidebar">
    <h1 style="margin-bottom: 30px; font-weight: 900; letter-spacing: -1px;">Finanzas PRO</h1>
    <div class="nav-link active" onclick="showTab('registro')">üìù <span>Registro</span></div>
    <div class="nav-link" onclick="showTab('historial')">üìú <span>Historial</span></div>
    <div class="nav-link" onclick="showTab('analisis')">üìä <span>An√°lisis</span></div>
    <div class="nav-link" onclick="showTab('ajustes')">‚öôÔ∏è <span>Ajustes</span></div>
</nav>

<main class="main-content">
    <div id="registro" class="tab-content">
        <div class="card">
            <h3 id="form-title">Nueva Operaci√≥n</h3><br>
            <input type="hidden" id="edit-id">
            <div class="form-grid">
                <div><label>Fecha</label><input type="date" id="f_fecha" onchange="autoFillDate()"></div>
                <div><label>Tipo</label><select id="f_tipo"><option value="Egreso">üîª Egreso</option><option value="Ingreso">üîπ Ingreso</option></select></div>
                <div><label>Monto ($)</label><input type="number" id="f_monto" oninput="calcLogic()"></div>
                <div><label>Presupuesto ($)</label><input type="number" id="f_presupuesto" oninput="calcLogic()"></div>
            </div>
            <div class="form-grid">
                <div><label>Concepto</label><input type="text" id="f_concepto"></div>
                <div><label>Categor√≠a</label><select id="f_cat" onchange="loadSubs()"></select></div>
                <div><label>Subcategor√≠a</label><select id="f_subcat"></select></div>
                <div><label>Proveedor</label><select id="f_proveedor"></select></div>
            </div>
            <div class="form-grid">
                <div><label>Forma de Pago</label><select id="f_pago"></select></div>
                <div><label>Estado</label><select id="f_estado"><option>Pagado</option><option>Pendiente</option></select></div>
                <div><label>Gasto</label><select id="f_gasto_tipo"><option>Fijo</option><option>Variable</option></select></div>
                <div><label>Recurrente</label><select id="f_recurrente"><option>No</option><option>S√≠</option></select></div>
            </div>
            <div class="form-grid" style="background: #f8fafc; padding: 15px; border-radius: 10px; border: 1px dashed #cbd5e1;">
                <div><label>Mes</label><input type="text" id="f_mes" readonly></div>
                <div><label>A√±o</label><input type="text" id="f_anio" readonly></div>
                <div><label>Diferencia</label><p id="f_diff" style="font-weight:900; font-size:18px;">$0</p></div>
            </div>
            <div style="margin-top:15px;"><label>Observaciones</label><textarea id="f_obs" rows="2"></textarea></div>
            <div class="form-grid" style="margin-top:20px;">
                <button class="btn-p" onclick="saveData()">üíæ GUARDAR</button>
                <button class="btn-p" style="background:#64748b;" onclick="clearForm()">üßπ LIMPIAR</button>
            </div>
        </div>
    </div>

    <div id="historial" class="tab-content" style="display:none;">
        <div class="card">
            <h3>Historial de Movimientos</h3><br>
            <div class="form-grid">
                <input type="text" id="h_search" placeholder="üîç Buscar por concepto, proveedor o categor√≠a..." oninput="refreshUI()">
                <div style="display:flex; gap:10px;">
                    <button class="btn-p" style="background:#10b981; padding:10px;" onclick="exportExcel()">üìä Excel</button>
                    <button class="btn-p" style="background:#ef4444; padding:10px;" onclick="exportPDF()">üìÑ PDF</button>
                </div>
            </div>
            <div class="table-wrap">
                <table id="table-hist">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Concepto</th>
                            <th>Monto</th>
                            <th>Categor√≠a</th>
                            <th>Proveedor</th>
                            <th>Estado</th>
                            <th style="text-align:center;">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="list_hist"></tbody>
                </table>
            </div>
        </div>
    </div>
</main>

<script>
    // FIREBASE CONFIG
    const firebaseConfig = {
      apiKey: "AIzaSyCO6WXu9iZsyEUmNNxrE4oWToLYY8wl-y4",
      authDomain: "misfinanzaspro-d2f3f.firebaseapp.com",
      databaseURL: "https://misfinanzaspro-d2f3f-default-rtdb.firebaseio.com",
      projectId: "misfinanzaspro-d2f3f",
      storageBucket: "misfinanzaspro-d2f3f.firebasestorage.app",
      messagingSenderId: "613366165036",
      appId: "1:613366165036:web:bebc72b38d39ab64932b89"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let rawData = {};
    let settings = JSON.parse(localStorage.getItem('fpro_v6_settings')) || {
        cats: ['Servicios b√°sicos', 'Alimentaci√≥n', 'Transporte', 'Salud', 'Ocio'],
        subs: {'Servicios b√°sicos': ['Agua potable', 'Luz', 'Gas', 'Internet']},
        provs: ['Aguas Andinas', 'Enel', 'Metrogas', 'Lider'],
        pagos: ['D√©bito', 'Cr√©dito', 'Efectivo', 'Transferencia']
    };

    function init() {
        document.getElementById('f_fecha').valueAsDate = new Date();
        autoFillDate();
        loadDropdowns();
        db.ref('movimientos').on('value', snap => {
            rawData = snap.val() || {};
            refreshUI();
        });
    }

    function autoFillDate() {
        const d = new Date(document.getElementById('f_fecha').value + 'T12:00:00');
        const meses = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];
        document.getElementById('f_mes').value = meses[d.getMonth()];
        document.getElementById('f_anio').value = d.getFullYear();
    }

    function calcLogic() {
        const monto = parseFloat(document.getElementById('f_monto').value) || 0;
        const presu = parseFloat(document.getElementById('f_presupuesto').value) || 0;
        const diff = presu - monto;
        const el = document.getElementById('f_diff');
        el.innerText = `$${diff.toLocaleString()}`;
        el.style.color = diff < 0 ? 'red' : 'green';
    }

    function saveData() {
        const id = document.getElementById('edit-id').value;
        const data = {
            fecha: document.getElementById('f_fecha').value,
            tipo: document.getElementById('f_tipo').value,
            monto: parseFloat(document.getElementById('f_monto').value) || 0,
            presupuesto: parseFloat(document.getElementById('f_presupuesto').value) || 0,
            concepto: document.getElementById('f_concepto').value,
            cat: document.getElementById('f_cat').value,
            subcat: document.getElementById('f_subcat').value,
            pago: document.getElementById('f_pago').value,
            estado: document.getElementById('f_estado').value,
            proveedor: document.getElementById('f_proveedor').value,
            gasto_tipo: document.getElementById('f_gasto_tipo').value,
            recurrente: document.getElementById('f_recurrente').value,
            obs: document.getElementById('f_obs').value,
            mes_anio: document.getElementById('f_fecha').value.substring(0,7)
        };
        if(id) db.ref('movimientos/' + id).set(data);
        else db.ref('movimientos').push(data);
        alert("¬°Registro sincronizado!");
        clearForm();
    }

    function refreshUI() {
        const search = document.getElementById('h_search').value.toLowerCase();
        let ing = 0, eg = 0;
        const listHist = document.getElementById('list_hist');
        listHist.innerHTML = '';

        Object.keys(rawData).reverse().forEach(key => {
            const d = rawData[key];
            if(d.tipo === 'Ingreso') ing += d.monto; else eg += d.monto;

            if(d.concepto.toLowerCase().includes(search) || d.proveedor.toLowerCase().includes(search) || d.cat.toLowerCase().includes(search)) {
                listHist.innerHTML += `
                <tr>
                    <td>${d.fecha}</td>
                    <td><b>${d.concepto}</b></td>
                    <td style="color:${d.tipo==='Ingreso'?'green':'red'}"><b>$${d.monto.toLocaleString()}</b></td>
                    <td><small>${d.cat}</small></td>
                    <td>${d.proveedor}</td>
                    <td><span style="color:${d.estado==='Pagado'?'green':'orange'}">${d.estado}</span></td>
                    <td style="text-align:center;">
                        <button class="btn-action" onclick="editItem('${key}')" title="Modificar">‚úèÔ∏è</button>
                        <button class="btn-action" onclick="deleteItem('${key}')" title="Eliminar" style="color:red;">üóëÔ∏è</button>
                    </td>
                </tr>`;
            }
        });

        document.getElementById('total-ingresos').innerText = `$${ing.toLocaleString()}`;
        document.getElementById('total-egresos').innerText = `$${eg.toLocaleString()}`;
        document.getElementById('total-saldo').innerText = `$${(ing - eg).toLocaleString()}`;
    }

    function editItem(key) {
        const d = rawData[key];
        document.getElementById('edit-id').value = key;
        document.getElementById('f_fecha').value = d.fecha;
        document.getElementById('f_tipo').value = d.tipo;
        document.getElementById('f_monto').value = d.monto;
        document.getElementById('f_presupuesto').value = d.presupuesto;
        document.getElementById('f_concepto').value = d.concepto;
        document.getElementById('f_cat').value = d.cat;
        loadSubs();
        document.getElementById('f_subcat').value = d.subcat;
        document.getElementById('f_proveedor').value = d.proveedor;
        document.getElementById('f_pago').value = d.pago;
        document.getElementById('f_estado').value = d.estado;
        document.getElementById('f_gasto_tipo').value = d.gasto_tipo;
        document.getElementById('f_recurrente').value = d.recurrente;
        document.getElementById('f_obs').value = d.obs || '';
        document.getElementById('form-title').innerText = "‚úèÔ∏è Modificando Registro";
        autoFillDate(); calcLogic();
        showTab('registro');
    }

    function deleteItem(key) {
        if(confirm("¬øEst√°s seguro de eliminar este registro? Esta acci√≥n no se puede deshacer.")) {
            db.ref('movimientos/' + key).remove();
        }
    }

    function clearForm() {
        document.getElementById('edit-id').value = '';
        document.getElementById('f_monto').value = '';
        document.getElementById('f_presupuesto').value = '';
        document.getElementById('f_concepto').value = '';
        document.getElementById('f_obs').value = '';
        document.getElementById('form-title').innerText = "Nueva Operaci√≥n";
        calcLogic();
    }

    function loadDropdowns() {
        const fill = (id, arr) => document.getElementById(id).innerHTML = arr.map(i => `<option>${i}</option>`).join('');
        fill('f_cat', settings.cats);
        fill('f_proveedor', settings.provs);
        fill('f_pago', settings.pagos);
        loadSubs();
    }

    function loadSubs() {
        const c = document.getElementById('f_cat').value;
        const s = settings.subs[c] || ['General'];
        document.getElementById('f_subcat').innerHTML = s.map(v => `<option>${v}</option>`).join('');
    }

    function toggleMenu() { document.getElementById('sidebar').classList.toggle('open'); }
    function showTab(id) {
        document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
        document.getElementById(id).style.display = 'block';
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        if(window.innerWidth < 900) toggleMenu();
    }

    function exportPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('l', 'mm', 'a4');
        doc.text("Historial de Finanzas PRO", 14, 15);
        doc.autoTable({ html: '#table-hist', startY: 20, theme: 'striped' });
        doc.save("Historial_FPRO.pdf");
    }

    function exportExcel() {
        let csv = "Fecha,Concepto,Monto,Categoria,Proveedor,Estado\n";
        Object.values(rawData).forEach(d => {
            csv += `${d.fecha},${d.concepto},${d.monto},${d.cat},${d.proveedor},${d.estado}\n`;
        });
        const blob = new Blob([csv], { type: 'text/csv' });
        const a = document.createElement('a');
        a.href = window.URL.createObjectURL(blob);
        a.download = 'Historial_FPRO.csv';
        a.click();
    }

    window.onload = init;
</script>
</body>
</html>
