<main class="main-content">
    <div id="analisis" class="tab-content" style="display:none;">
        <div class="card">
            <h3>Estadísticas Generales</h3><br>
            <div class="form-grid">
                <div style="background:#eff6ff; padding:20px; border-radius:12px; border-left:5px solid var(--acc);">
                    <small>PROMEDIO GASTO DIARIO</small>
                    <p id="stat-avg-gasto" style="font-size:24px; font-weight:900;">$0</p>
                </div>
                <div style="background:#f0fdf4; padding:20px; border-radius:12px; border-left:5px solid var(--success);">
                    <small>MAYOR INGRESO MES</small>
                    <p id="stat-max-ingreso" style="font-size:24px; font-weight:900;">$0</p>
                </div>
                <div style="background:#fef2f2; padding:20px; border-radius:12px; border-left:5px solid var(--danger);">
                    <small>CATEGORÍA MÁS COSTOSA</small>
                    <p id="stat-top-cat" style="font-size:18px; font-weight:900;">---</p>
                </div>
            </div>
        </div>

        <div class="form-grid">
            <div class="card">
                <h3>Gastos por Categoría</h3><br>
                <div style="max-height: 300px; display: flex; justify-content: center;">
                    <canvas id="chartCats"></canvas>
                </div>
            </div>
            <div class="card">
                <h3>Flujo de Caja Mensual</h3><br>
                <div style="max-height: 300px;">
                    <canvas id="chartFlow"></canvas>
                </div>
            </div>
        </div>

        <div class="card">
            <h3>Distribución por Proveedor</h3><br>
            <div style="max-height: 300px;">
                <canvas id="chartProvs"></canvas>
            </div>
        </div>
    </div>

    </main>

<script>
    // [Configuración Firebase y Variables globales igual]
    let chart1, chart2, chart3;

    function init() {
        document.getElementById('f_fecha').valueAsDate = new Date();
        loadDropdowns();
        db.ref('movimientos').on('value', snap => {
            rawData = snap.val() || {};
            refreshUI();
            updateCharts(); // Llamada para actualizar gráficos
        });
    }

    // [Funciones refreshUI, saveData, editItem, etc. se mantienen igual]

    // NUEVA FUNCIÓN DE GRÁFICOS Y ESTADÍSTICAS
    function updateCharts() {
        const data = Object.values(rawData);
        if (data.length === 0) return;

        // 1. LÓGICA DE ESTADÍSTICAS
        let catTotals = {};
        let provTotals = {};
        let flowData = {}; // Meses
        let totalEgresos = 0;
        let maxIngreso = 0;

        data.forEach(d => {
            if (d.tipo === 'Egreso') {
                totalEgresos += d.monto;
                catTotals[d.cat] = (catTotals[d.cat] || 0) + d.monto;
                provTotals[d.proveedor] = (provTotals[d.proveedor] || 0) + d.monto;
            } else {
                if (d.monto > maxIngreso) maxIngreso = d.monto;
            }
            
            let mes = d.fecha.substring(0, 7);
            if (!flowData[mes]) flowData[mes] = { ing: 0, eg: 0 };
            if (d.tipo === 'Ingreso') flowData[mes].ing += d.monto;
            else flowData[mes].eg += d.monto;
        });

        // Actualizar Tarjetas
        document.getElementById('stat-avg-gasto').innerText = `$${Math.round(totalEgresos / 30).toLocaleString()}`;
        document.getElementById('stat-max-ingreso').innerText = `$${maxIngreso.toLocaleString()}`;
        const topCat = Object.keys(catTotals).reduce((a, b) => catTotals[a] > catTotals[b] ? a : b, "---");
        document.getElementById('stat-top-cat').innerText = topCat;

        // 2. GRÁFICO CATEGORÍAS (Doughnut)
        if (chart1) chart1.destroy();
        chart1 = new Chart(document.getElementById('chartCats'), {
            type: 'doughnut',
            data: {
                labels: Object.keys(catTotals),
                datasets: [{
                    data: Object.values(catTotals),
                    backgroundColor: ['#2563eb', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899']
                }]
            },
            options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
        });

        // 3. GRÁFICO FLUJO (Barra)
        const mesesLabels = Object.keys(flowData).sort();
        if (chart2) chart2.destroy();
        chart2 = new Chart(document.getElementById('chartFlow'), {
            type: 'bar',
            data: {
                labels: mesesLabels,
                datasets: [
                    { label: 'Ingresos', data: mesesLabels.map(m => flowData[m].ing), backgroundColor: '#10b981' },
                    { label: 'Egresos', data: mesesLabels.map(m => flowData[m].eg), backgroundColor: '#ef4444' }
                ]
            },
            options: { responsive: true, scales: { y: { beginAtZero: true } } }
        });

        // 4. GRÁFICO PROVEEDORES (Horizontal Bar)
        if (chart3) chart3.destroy();
        chart3 = new Chart(document.getElementById('chartProvs'), {
            type: 'bar',
            data: {
                labels: Object.keys(provTotals),
                datasets: [{
                    label: 'Gasto por Proveedor',
                    data: Object.values(provTotals),
                    backgroundColor: '#64748b'
                }]
            },
            options: { indexAxis: 'y', responsive: true }
        });
    }

    // [Resto de funciones: showTab, toggleMenu, etc. igual]
</script>
