<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finanzas PRO | Smart Management</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    
    <style>
        :root { 
            --p: #0f172a; --acc: #2563eb; --bg: #f8fafc; 
            --danger: #ef4444; --success: #10b981; --warning: #f59e0b;
            --sidebar-w: 260px;
            --grad: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        }
        * { margin:0; padding:0; box-sizing:border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--bg); display: flex; min-height: 100vh; color: #1e293b; overflow-x: hidden; }

        /* Sidebar & Navigation */
        .sidebar { 
            width: var(--sidebar-w); background: var(--p); color: white; padding: 25px; 
            position: fixed; height: 100vh; z-index: 1000; transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1); 
        }
        .main-content { margin-left: var(--sidebar-w); padding: 30px; width: calc(100% - var(--sidebar-w)); transition: 0.4s; }

        .nav-link { display: flex; align-items: center; gap: 12px; padding: 14px; color: #cbd5e1; cursor: pointer; border-radius: 12px; margin-bottom: 8px; transition: 0.3s; }
        .nav-link:hover, .nav-link.active { background: var(--acc); color: white; transform: translateX(5px); }

        /* Mobile Menu */
        .menu-toggle { display: none; position: fixed; top: 15px; left: 15px; z-index: 1100; background: var(--p); color: white; border: none; padding: 10px; border-radius: 8px; cursor: pointer; }

        /* DISE√ëO PRO: SABIDUR√çA FINANCIERA */
        .wisdom-box {
            background: white; border-radius: 20px; padding: 20px; margin-bottom: 30px;
            display: flex; align-items: center; gap: 20px; border: 1px solid #e2e8f0;
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.05); position: relative;
            overflow: hidden;
        }
        .wisdom-box::before { content: ''; position: absolute; left: 0; top: 0; height: 100%; width: 5px; background: var(--acc); }
        .wisdom-avatar { 
            width: 55px; height: 55px; background: var(--grad); border-radius: 16px; 
            display: flex; align-items: center; justify-content: center; font-size: 26px; 
            flex-shrink: 0; color: white; box-shadow: 0 8px 15px rgba(37,99,235,0.2);
        }
        .wisdom-content { flex-grow: 1; }
        .wisdom-label { font-size: 10px; font-weight: 800; color: var(--acc); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px; display: block; }
        #tip-text { font-size: 15px; font-weight: 500; color: #334155; line-height: 1.5; transition: all 0.5s ease; opacity: 1; }

        /* Cards & Inputs */
        .card { background: white; border-radius: 16px; padding: 25px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); margin-bottom: 25px; border: 1px solid #eef2f6; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 18px; margin-bottom: 18px; }
        
        label { font-size: 11px; font-weight: 800; color: #64748b; text-transform: uppercase; margin-bottom: 6px; display: block; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 10px; font-size: 14px; background: #fdfdfd; }
        input:focus { border-color: var(--acc); outline: none; box-shadow: 0 0 0 4px rgba(37,99,235,0.1); }
        
        .btn { padding: 14px 24px; border-radius: 10px; border: none; cursor: pointer; font-weight: 700; transition: 0.3s; display: flex; align-items: center; gap: 10px; justify-content: center; }
        .btn-p { background: var(--acc); color: white; }
        .btn-p:hover { box-shadow: 0 8px 15px rgba(37,99,235,0.3); }

        /* Table Design */
        .table-container { overflow-x: auto; border-radius: 12px; border: 1px solid #eef2f6; }
        table { width: 100%; border-collapse: collapse; background: white; }
        th { background: #f8fafc; padding: 15px; text-align: left; color: #64748b; font-size: 12px; }
        td { padding: 15px; border-bottom: 1px solid #f1f5f9; font-size: 13px; }

        /* Responsive Mobile */
        @media (max-width: 900px) {
            .sidebar { left: -100%; width: 280px; }
            .sidebar.open { left: 0; }
            .main-content { margin-left: 0; width: 100%; padding: 70px 15px 20px 15px; }
            .menu-toggle { display: block; }
            .form-grid { grid-template-columns: 1fr; }
            .wisdom-box { padding: 15px; gap: 15px; }
            .wisdom-avatar { width: 45px; height: 45px; font-size: 20px; }
            #tip-text { font-size: 13px; }
        }
    </style>
</head>
<body>

<button class="menu-toggle" onclick="toggleMenu()">‚ò∞</button>

<nav class="sidebar" id="sidebar">
    <h2 style="margin-bottom: 30px; font-weight: 900;">FINANZAS PRO</h2>
    <div class="nav-link active" onclick="showTab('registro')">üìù <span>Registro</span></div>
    <div class="nav-link" onclick="showTab('historial')">üìú <span>Historial</span></div>
    <div class="nav-link" onclick="showTab('analisis')">üìä <span>An√°lisis</span></div>
    <div class="nav-link" onclick="showTab('ajustes')">‚öôÔ∏è <span>Ajustes</span></div>
</nav>

<main class="main-content">
    <div style="margin-bottom: 5px; color: var(--acc); font-weight: 700; font-size: 12px; letter-spacing: 2px; text-transform: uppercase;">Sistema Inteligente de Gesti√≥n Patrimonial</div>
    
    <div class="wisdom-box">
        <div class="wisdom-avatar">üíé</div>
        <div class="wisdom-content">
            <span class="wisdom-label">Sabidur√≠a Financiera ‚ú®</span>
            <div id="tip-text">Preparando tu siguiente consejo maestro...</div>
        </div>
    </div>

    <div id="registro" class="tab-content">
        <div class="card">
            <h3 id="form-title">Registrar Transacci√≥n</h3><br>
            <input type="hidden" id="edit-id">
            <div class="form-grid">
                <div><label>Fecha</label><input type="date" id="f_fecha"></div>
                <div><label>Tipo</label><select id="f_tipo"><option>Egreso</option><option>Ingreso</option></select></div>
                <div><label>Monto</label><input type="number" id="f_monto" oninput="calcDiff()"></div>
                <div><label>Presupuesto</label><input type="number" id="f_presupuesto" oninput="calcDiff()"></div>
            </div>
            <div class="form-grid">
                <div><label>Categor√≠a</label><select id="f_cat" onchange="updateSubSelect()"></select></div>
                <div><label>Subcategor√≠a</label><select id="f_subcat"></select></div>
                <div><label>Concepto</label><input type="text" id="f_concepto"></div>
                <div><label>Proveedor</label><select id="f_proveedor"></select></div>
            </div>
            <div class="form-grid">
                <div><label>Forma Pago</label><select id="f_pago"></select></div>
                <div><label>Estado</label><select id="f_estado"><option>Pagado</option><option>Pendiente</option></select></div>
                <div><label>Gasto</label><select id="f_gasto_tipo"><option>Fijo</option><option>Variable</option></select></div>
                <div><label>Diferencia</label><div id="val_diff" style="font-weight:900; padding:10px;">$0</div></div>
            </div>
            <button class="btn btn-p" onclick="saveData()">üíæ SINCRONIZAR CON NUBE</button>
        </div>
    </div>

    <div id="historial" class="tab-content" style="display:none;">
        <div class="card">
            <h3>Explorador de Movimientos</h3><br>
            <div style="display:flex; gap:10px; margin-bottom:20px; flex-wrap:wrap;">
                <input type="text" id="search_input" placeholder="Buscar por concepto, categor√≠a o proveedor..." oninput="renderHistorialFull()" style="flex:2;">
                <select id="filter_mes_h" onchange="renderHistorialFull()" style="flex:1;"></select>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr><th>Fecha</th><th>Concepto</th><th>Categor√≠a</th><th>Monto</th><th>Acciones</th></tr>
                    </thead>
                    <tbody id="hist_body_full"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="analisis" class="tab-content" style="display:none;">
        <div class="form-grid">
            <div class="card"><h3>Distribuci√≥n de Gastos</h3><canvas id="chartPie"></canvas></div>
            <div class="card"><h3>Top 5 Impactos</h3><div id="topList"></div></div>
        </div>
    </div>

    <div id="ajustes" class="tab-content" style="display:none;">
        <div class="form-grid">
            <div class="card">
                <label>Gestionar Categor√≠as</label>
                <div style="display:flex; gap:5px; margin-bottom:10px;"><input type="text" id="new_cat"><button onclick="addSet('cats','new_cat')" class="btn btn-p" style="width:45px">+</button></div>
                <div id="list_cats"></div>
            </div>
            <div class="card">
                <label>Proveedores</label>
                <div style="display:flex; gap:5px; margin-bottom:10px;"><input type="text" id="new_prov"><button onclick="addSet('proveedores','new_prov')" class="btn btn-p" style="width:45px">+</button></div>
                <div id="list_provs"></div>
            </div>
        </div>
    </div>
</main>

<script>
    const firebaseConfig = {
      apiKey: "AIzaSyCO6WXu9iZsyEUmNNxrE4oWToLYY8wl-y4",
      authDomain: "misfinanzaspro-d2f3f.firebaseapp.com",
      databaseURL: "https://misfinanzaspro-d2f3f-default-rtdb.firebaseio.com",
      projectId: "misfinanzaspro-d2f3f",
      storageBucket: "misfinanzaspro-d2f3f.firebasestorage.app",
      messagingSenderId: "613366165036",
      appId: "1:613366165036:web:bebc72b38d39ab64932b89"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // LAS 70 FRASES ACTUALIZADAS
    const tips = [
        "El camino a la riqueza depende de dos palabras: trabajo y ahorro.", "No ahorres lo que queda despu√©s de gastar, gasta lo que queda despu√©s de ahorrar.",
        "Cuida de los peque√±os gastos; un peque√±o agujero hunde un gran barco.", "La libertad financiera es la capacidad de vivir del flujo de caja de tus activos.",
        "El precio es lo que pagas, el valor es lo que obtienes.", "Invierte en ti mismo, es el activo que m√°s intereses te pagar√°.",
        "Nunca dependas de una sola fuente de ingresos.", "Si compras cosas que no necesitas, pronto tendr√°s que vender cosas que necesitas.",
        "La riqueza no consiste en tener grandes posesiones, sino en tener pocas necesidades.", "El inter√©s compuesto es la octava maravilla del mundo. Quien lo entiende, lo gana; quien no, lo paga.",
        "Ahorrar es el proceso de retener capital; invertir es el proceso de ponerlo a trabajar.", "Tu nivel de √©xito financiero rara vez superar√° tu nivel de desarrollo personal.",
        "No busques el momento perfecto para invertir, haz que el momento sea perfecto empezando hoy.", "El dinero es un excelente esclavo, pero un p√©simo amo.",
        "La mejor inversi√≥n que puedes hacer es en tu propia educaci√≥n.", "El riesgo viene de no saber lo que est√°s haciendo.",
        "La disciplina financiera es el puente entre tus metas y tus logros.", "Un presupuesto le dice a tu dinero a d√≥nde ir, en lugar de preguntarte a d√≥nde se fue.",
        "Ser rico es tener dinero; ser pr√≥spero es tener tiempo.", "La deuda de consumo es el impuesto que pagas por la impaciencia.",
        "El ahorro sin prop√≥sito es estancamiento; el ahorro con meta es poder.", "La educaci√≥n financiera es m√°s importante que el dinero mismo.",
        "No trabajes por el dinero, haz que el dinero trabaje para ti.", "La simplicidad es la clave de la gesti√≥n financiera exitosa.",
        "El √©xito financiero no es un sprint, es un marat√≥n de consistencia.", "Tu cuenta bancaria es un reflejo de tus h√°bitos, no de tu suerte.",
        "El costo de algo es la cantidad de vida que intercambias por ello.", "Quien controla su mente, controla su bolsillo.",
        "La verdadera riqueza es discreta; la pobreza suele ser ruidosa.", "Planifica hoy para que tu 'yo' del futuro te lo agradezca.",
        "Diversificar es la √∫nica protecci√≥n contra la ignorancia.", "El mercado financiero es un mecanismo para transferir dinero de los impacientes a los pacientes.",
        "Gasta siempre un centavo menos de lo que ganas.", "Las deudas son como el fuego: √∫tiles si se controlan, destructivas si te superan.",
        "La mejor forma de predecir tu futuro financiero es cre√°ndolo.", "La frugalidad es disfrutar de la abundancia sin caer en el desperdicio.",
        "Tu patrimonio neto es tu red de seguridad ante la incertidumbre.", "El dinero no te hace feliz, pero la falta de dinero te quita opciones.",
        "No te compares con los dem√°s, comp√°rate con tu balance del mes pasado.", "La gratificaci√≥n instant√°nea es el enemigo n√∫mero uno de tu riqueza.",
        "Aprende a decir 'no' hoy para poder decir 's√≠' a tus sue√±os ma√±ana.", "La inversi√≥n m√°s segura es liquidar tus deudas con intereses altos.",
        "Tener un fondo de emergencia no es opcional, es vital.", "La inflaci√≥n es el impuesto invisible; invierte para vencerla.",
        "La mentalidad de escasez gasta; la mentalidad de abundancia invierte.", "Cada peso que ahorras es una semilla para tu √°rbol de libertad.",
        "Simplifica tu vida y ver√°s c√≥mo se multiplica tu ahorro.", "El conocimiento paga el mejor inter√©s.",
        "No pongas todos los huevos en la misma cesta.", "El √©xito es 10% lo que ganas y 90% c√≥mo lo administras.",
        "La libertad financiera empieza con una decisi√≥n, no con un aumento de sueldo.", "El hombre m√°s rico es aquel cuyos placeres son los m√°s baratos.",
        "Los ricos invierten su dinero y gastan lo que queda; los pobres gastan su dinero e invierten lo que queda.", "La paciencia es una virtud, especialmente en las inversiones.",
        "Tu capacidad de ahorro determina tu velocidad de jubilaci√≥n.", "Automatizar tus finanzas es eliminar la tentaci√≥n de fallar.",
        "El dinero solo amplifica quien ya eres.", "No permitas que tus deseos crezcan m√°s r√°pido que tus activos.",
        "La estabilidad financiera es la paz mental convertida en n√∫meros.", "Invierte en activos, no en pasivos que parecen activos.",
        "El lujo debe ser una recompensa, no una fachada.", "La riqueza se mide en el tiempo que puedes vivir sin trabajar.",
        "El primer paso para salir del hoyo es dejar de cavar.", "Tu futuro financiero se construye en los detalles de hoy.",
        "No confundas un buen estilo de vida con una buena vida.", "El valor de una persona no se mide por su saldo, pero su libertad s√≠.",
        "La curiosidad financiera te salvar√° de errores costosos.", "Protege tu capital como si fuera tu vida, porque es tu tiempo.",
        "Aprende las reglas del juego antes de poner tu dinero en la mesa.", "La sabidur√≠a financiera es saber distinguir un activo de un capricho.",
        "La meta no es ser rico, la meta es ser libre."
    ];

    let settings = JSON.parse(localStorage.getItem('fpro_final_settings')) || {
        cats: ['Alimentaci√≥n', 'Vivienda', 'Transporte', 'Salud', 'Ocio'],
        subs: {'Alimentaci√≥n': ['Supermercado', 'Restaurante']},
        proveedores: ['General'],
        pagos: ['Efectivo', 'Tarjeta']
    };
    let rawData = {};

    function init() {
        document.getElementById('f_fecha').valueAsDate = new Date();
        populateMonths();
        updateAllSelects();
        startCoach();
        
        db.ref('movimientos').on('value', snap => {
            rawData = snap.val() || {};
            renderHistorialFull();
        });
    }

    function toggleMenu() { document.getElementById('sidebar').classList.toggle('open'); }

    function startCoach() {
        const textEl = document.getElementById('tip-text');
        let i = Math.floor(Math.random() * tips.length);
        
        const update = () => {
            textEl.style.opacity = 0;
            setTimeout(() => {
                textEl.innerText = tips[i];
                textEl.style.opacity = 1;
                i = (i + 1) % tips.length;
            }, 500);
        };
        
        update();
        setInterval(update, 10000);
    }

    function showTab(id) {
        document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
        document.getElementById(id).style.display = 'block';
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        if(event) event.currentTarget.classList.add('active');
        if(window.innerWidth < 900) document.getElementById('sidebar').classList.remove('open');
        if(id === 'analisis') runAnalysis();
    }

    function saveData() {
        const id = document.getElementById('edit-id').value;
        const fecha = document.getElementById('f_fecha').value;
        const data = {
            fecha, tipo: document.getElementById('f_tipo').value,
            monto: parseFloat(document.getElementById('f_monto').value) || 0,
            presupuesto: parseFloat(document.getElementById('f_presupuesto').value) || 0,
            concepto: document.getElementById('f_concepto').value,
            cat: document.getElementById('f_cat').value,
            subcat: document.getElementById('f_subcat').value,
            proveedor: document.getElementById('f_proveedor').value,
            pago: document.getElementById('f_pago').value,
            estado: document.getElementById('f_estado').value,
            gasto_tipo: document.getElementById('f_gasto_tipo').value,
            mes_anio: fecha.substring(0, 7)
        };
        if(id) db.ref('movimientos/' + id).set(data);
        else db.ref('movimientos').push(data);
        alert("Sincronizado");
        clearForm();
    }

    function renderHistorialFull() {
        const search = document.getElementById('search_input').value.toLowerCase();
        const mes = document.getElementById('filter_mes_h').value;
        const body = document.getElementById('hist_body_full');
        body.innerHTML = '';

        Object.keys(rawData).reverse().forEach(key => {
            const d = rawData[key];
            const matchSearch = d.concepto.toLowerCase().includes(search) || d.cat.toLowerCase().includes(search) || d.proveedor.toLowerCase().includes(search);
            const matchMes = mes === "all" || d.mes_anio === mes;

            if(matchSearch && matchMes) {
                body.innerHTML += `<tr>
                    <td>${d.fecha}</td>
                    <td><b>${d.concepto}</b></td>
                    <td>${d.cat}</td>
                    <td style="color:${d.tipo==='Ingreso'?'green':'red'}">$${d.monto.toLocaleString()}</td>
                    <td>
                        <button onclick="editItem('${key}')">‚úèÔ∏è</button>
                        <button onclick="deleteItem('${key}')">üóëÔ∏è</button>
                    </td>
                </tr>`;
            }
        });
    }

    function editItem(key) {
        const d = rawData[key];
        document.getElementById('edit-id').value = key;
        document.getElementById('f_fecha').value = d.fecha;
        document.getElementById('f_monto').value = d.monto;
        document.getElementById('f_concepto').value = d.concepto;
        document.getElementById('f_cat').value = d.cat;
        updateSubSelect();
        showTab('registro');
    }

    function deleteItem(key) { if(confirm("¬øEliminar?")) db.ref('movimientos/' + key).remove(); }

    function updateAllSelects() {
        const f = (id, arr) => {
            const el = document.getElementById(id);
            if(el) el.innerHTML = arr.map(i => `<option>${i}</option>`).join('');
        };
        f('f_cat', settings.cats);
        f('f_proveedor', settings.proveedores);
        f('f_pago', settings.pagos);
        updateSubSelect();
    }

    function updateSubSelect() {
        const cat = document.getElementById('f_cat').value;
        const subs = settings.subs[cat] || ['General'];
        document.getElementById('f_subcat').innerHTML = subs.map(s => `<option>${s}</option>`).join('');
    }

    function calcDiff() {
        const m = parseFloat(document.getElementById('f_monto').value) || 0;
        const p = parseFloat(document.getElementById('f_presupuesto').value) || 0;
        const d = p - m;
        document.getElementById('val_diff').innerText = `$${d.toLocaleString()}`;
        document.getElementById('val_diff').style.color = d < 0 ? 'red' : 'green';
    }

    function clearForm() {
        document.getElementById('edit-id').value = '';
        document.getElementById('f_monto').value = '';
        document.getElementById('f_concepto').value = '';
        document.getElementById('form-title').innerText = "Registrar Transacci√≥n";
    }

    function populateMonths() {
        const sel = document.getElementById('filter_mes_h');
        sel.innerHTML = '<option value="all">Todos los meses</option>';
        const now = new Date();
        for(let i=0; i<12; i++) {
            const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
            const val = d.toISOString().substring(0,7);
            sel.innerHTML += `<option value="${val}">${val}</option>`;
        }
    }

    function addSet(key, inputId) {
        const v = document.getElementById(inputId).value;
        if(v) { 
            settings[key].push(v); 
            localStorage.setItem('fpro_final_settings', JSON.stringify(settings)); 
            updateAllSelects(); 
            document.getElementById(inputId).value = '';
        }
    }

    function runAnalysis() {
        const gastos = Object.values(rawData).filter(d => d.tipo === 'Egreso');
        const catMap = {};
        gastos.forEach(g => catMap[g.cat] = (catMap[g.cat] || 0) + g.monto);
        const ctx = document.getElementById('chartPie').getContext('2d');
        if(window.myChart) window.myChart.destroy();
        window.myChart = new Chart(ctx, { 
            type: 'doughnut', 
            data: { 
                labels: Object.keys(catMap), 
                datasets: [{ data: Object.values(catMap), backgroundColor: ['#2563eb', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'] }] 
            },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }

    window.onload = init;
</script>
</body>
</html>
